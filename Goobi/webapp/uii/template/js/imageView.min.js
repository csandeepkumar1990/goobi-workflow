/*!
 * This file is part of the Goobi viewer - a content presentation and management application for digitized objects.
 *
 * Visit these websites for more information.
 * - http://www.intranda.com
 * - http://digiverso.com
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var _MIN_DESKEW_ANGLE=-44.9,_MAX_DESKEW_ANGLE=45,DEFAULT_CURSOR="default",ImageView=function(){"use strict";var e=!1,t={global:{divId:"map",zoomSlider:".zoom-slider",zoomSliderHandle:".zoom-slider-handle",overlayGroups:[],zoomSpeed:1.25,maxZoomLevel:2,minZoomLevel:1,allowPanning:!0,enableMouseNavigation:!0,imageControlsActive:!0,visibilityRatio:.2,loadImageTimeout:6e5,maxParallelImageLoads:2,adaptContainerHeight:!1,fitToContainer:!0,footerHeight:0,topMargin:0,rememberZoom:!1,rememberRotation:!1,panHomeOnZoomOut:!0,showControls:!1,useTiles:!0},image:{initialRotation:0,mimeType:"image/jpeg"}},o={};function i(e){var t=e.userData;if(t.config.global.footerHeight>0){var o=t.config.global.footerHeight,i=new OpenSeadragon.Point(0,t.container.height()-o),n=new OpenSeadragon.Point(t.container.width(),o);t.canvasScale||(t.canvasScale=t.viewer.drawer.context.canvas.width/t.viewer.drawer.context.canvas.clientWidth),1!=t.canvasScale&&(i=i.times(t.canvasScale),n=n.times(t.canvasScale)),t.viewer.drawer.context.drawImage(t.footerImage,i.x,i.y,n.x,n.y)}}function n(t,o){var i=Q.defer();return ImageView.TileSourceResolver.resolveAsJson(t).then(function(t){return e&&console.log("IIIF image info ",t),function(e,t){if(t){if("string"==typeof t){t.replace(/[\{\}]/,"");var t=JSON.parse(t)}var o=[];t.forEach(function(e){e.width||e.height?o.push(e):o.push({width:parseInt(e),height:parseInt(e)})}),o.length>0&&(e.sizes=o)}}(t,o.global.imageSizes),function(e,t){if(t){if("string"==typeof t){var o=t.replace(/(\d+)/,'"$1"').replace("=",":");t=JSON.parse(o)}var i=[];Array.isArray(t)?i=t:Object.keys(t).forEach(function(e){var o=t[e];i.push({width:parseInt(e),height:parseInt(e),scaleFactors:o})}),i.length>0&&(e.tiles=i)}}(t,o.global.tileSizes),e&&console.log("adapted IIIF image info ",t),o.global.useTiles&&t.tiles&&t.tiles.length>0?new OpenSeadragon.IIIFTileSource(t):function(t,o){e&&console.log("Creating legacy tilesource from imageInfo ",t);var i=o.image.mimeType;i=(i=i.replace("image/","")).replace("jpeg","jpg").replace("tiff","tif");var n,r=[];Array.isArray(t)?(t.forEach(function(e){e.mimetype=o.image.mimeType}),n=new OpenSeadragon.LegacyTileSource(t)):t.sizes?(t.sizes.forEach(function(n){e&&(console.log("Image level width = ",n.width),console.log("Image level height = ",n.height));var a={mimetype:o.image.mimeType,url:t["@id"].replace("/info.json","")+"/full/"+n.width+",/0/default."+i,width:t.width,height:t.height};e&&console.log("Created level ",a),r.push(a)}),n=new OpenSeadragon.LegacyTileSource(r)):n=new OpenSeadragon.ImageTileSource({url:t["@id"].replace("/info.json","")+"/full/full/0/default."+i,crossOriginPolicy:"Anonymous",buildPyramid:!1});return n}(t,o)},function(t){if(ImageView.TileSourceResolver.isURI(o.image.tileSource)){e&&console.log("Image URL",o.image.tileSource);var i=new OpenSeadragon.ImageTileSource({url:o.image.tileSource,buildPyramid:!0,crossOriginPolicy:!1});return i}var n="Failed to load tilesource from "+i;return e&&console.log(n),Q.reject(n)}).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)}),i.promise}return o.Image=function(o){this.config=jQuery.extend(!0,{},t),jQuery.extend(!0,this.config,o),this.container=$("#"+this.config.global.divId),e&&console.log("initializing image view with config ",this.config)},o.Image.prototype.load=function(){e&&(console.log("##############################"),console.log("osViewer.init"),console.log("##############################")),this.config.image.mimeType=this.config.image.mimeType.replace("jpeg","jpg");var t=this.config.image.tileSource;"string"==typeof t&&t.startsWith("[")?(e&&console.log("Sources = ",t),t=JSON.parse(t)):$.isArray(t)||(t=[t]);for(var o=[],i=0;i<t.length;i++){var r=n(t[i],this.config);o.push(r)}var a=this;return Q.all(o).then(function(t){for(var o=Number.MAX_VALUE,i=Number.MAX_VALUE,n=Number.MAX_VALUE,r=0;r<t.length;r++){var s=t[r];o=Math.min(o,s.width),i=Math.min(i,s.height),n=Math.min(n,s.aspectRatio),a.config.image.originalImageWidth||(a.config.image.originalImageWidth=s.width),a.config.image.originalImageHeight||(a.config.image.originalImageHeight=s.height)}e&&(console.log("original image size: ",a.config.image.originalImageWidth,a.config.image.originalImageHeight),console.log("Min aspect ratio = "+n));for(var l=0,c=0;c<t.length;c++){s=t[c];t[c]={tileSource:s,width:s.aspectRatio/n,x:l,y:0},l+=t[c].width}return a.loadImage(t)})},o.Image.prototype.loadImage=function(i){e&&console.log("Loading image with tilesource: ",i);var n=$("#"+this.config.global.divId),r=this.config.global.maxZoomLevel;this.config.image.originalImageWidth&&n.width()>0&&(r=this.config.global.maxZoomLevel*this.config.image.originalImageWidth/n.width()),this.loadFooter();var a={tileSources:i,id:this.config.global.divId,prefixUrl:this.config.resourcePath+"/javascript/openseadragon/images/",immediateRender:!1,visibilityRatio:this.config.global.visibilityRatio,sequenceMode:!1,degrees:this.config.image.initialRotation?this.config.image.initialRotation:0,zoomPerClick:1,showRotationControl:!0,showNavigationControl:this.config.global.showControls,minZoomLevel:this.config.global.minZoomLevel,maxZoomLevel:r,zoomPerScroll:this.config.global.zoomSpeed,panHorizontal:this.config.global.allowPanning,panVertical:this.config.global.allowPanning,mouseNavEnabled:this.config.global.enableMouseNavigation,homeButton:this.config.global.zoomHome,rotateLeftButton:this.config.global.rotateLeft,rotateRightButton:this.config.global.rotateRight,timeout:this.config.global.loadImageTimeout,blendTime:.5,alwaysBlend:!1,imageLoaderLimit:this.config.global.maxParallelImageLoads,loadTilesWithAjax:!0,ajaxHeaders:{token:this.config.global.webApiToken},viewportMargins:{top:this.config.global.topMargin,left:0,right:0,bottom:this.config.global.footerHeight}};e&&console.log("osconfig ",a),this.viewer=new OpenSeadragon(a);var s=Q.defer();this.observables=function(e,o){var i={};return i.viewerOpen=Rx.Observable.create(function(e){o.viewer.addOnceHandler("open",function(o){return o.osState="open",Number.isNaN(o.eventSource.viewport.getHomeBounds().x)?e.onError("Unknow error loading image from ",t.image.tileSource):e.onNext(o)}),o.viewer.addOnceHandler("open-failed",function(t){return t.osState="open-failed",console.error("Failed to open openseadragon "),e.onError(t)})}),i.firstTileLoaded=Rx.Observable.create(function(e){o.viewer.addOnceHandler("tile-loaded",function(t){return t.osState="tile-loaded",e.onNext(t)}),o.viewer.addOnceHandler("tile-load-failed",function(t){return t.osState="tile-load-failed",console.error("Failed to load tile"),e.onError(t)})}),i.viewerZoom=Rx.Observable.create(function(e){o.viewer.addHandler("zoom",function(t){return e.onNext(t)})}),i.animationComplete=Rx.Observable.create(function(e){o.viewer.addHandler("animation-finish",function(t){return e.onNext(t)})}),i.viewportUpdate=Rx.Observable.create(function(e){o.viewer.addHandler("update-viewport",function(t){return e.onNext(t)})}),i.animation=Rx.Observable.create(function(e){o.viewer.addHandler("animation",function(t){return e.onNext(t)})}),i.viewerRotate=Rx.Observable.create(function(e){o.viewer.addHandler("rotate",function(t){return t.osState="rotate",e.onNext(t)})}),i.canvasResize=Rx.Observable.create(function(e){o.viewer.addHandler("resize",function(t){return t.osState="resize",e.onNext(t)})}),i.windowResize=Rx.Observable.fromEvent(e,"resize").map(function(e){return e.osState="window resize",e}),i.overlayRemove=Rx.Observable.create(function(e){o.viewer.addHandler("remove-overlay",function(t){return e.onNext(t)})}),i.overlayUpdate=Rx.Observable.create(function(e){o.viewer.addHandler("update-overlay",function(t){return e.onNext(t)})}),i.levelUpdate=Rx.Observable.create(function(e){o.viewer.addHandler("update-level",function(t){return e.onNext(t)})}),i.redrawRequired=i.viewerOpen.merge(i.viewerRotate.merge(i.canvasResize).debounce(10)).map(function(e){var t={};return o.controls&&(t=o.controls.getLocation()),"open"===e.osState&&(t.zoom=o.viewer.viewport.getHomeZoom(),o.config.image.location&&(t=o.config.image.location)),e.targetLocation=t,e}).publish(),i}(window,this),(this.config.global.rotationSlider||this.config.global.rotationInput)&&function(e){var t=e.config.image.initialRotation,o=_getDeskewAngle(t);e.rotation=_getRotation(t);var i=e.config.global,n=e.viewer;i.rotationSlider&&($("#"+i.rotationSlider).slider({orientation:"vertical",min:_MIN_DESKEW_ANGLE,max:_MAX_DESKEW_ANGLE,step:.1,slide:function(t,o){var i=-o.value,r=_getDeskewAngle(i);n.viewport.setRotation(r+e.rotation)}}),$("#"+i.rotationSlider).slider("option","value",-o));i.rotationInput&&$("#"+i.rotationInput).on("blur",function(t){e.rotate(t.target.value)});n.addHandler("rotate",function(t){var o=_normalizeAngle(t.degrees),r=_getDeskewAngle(o);if(e.rotation=_getRotation(n.viewport.getRotation()),i.rotationInput){var a=e.rotation+r;$("#"+i.rotationInput).val(a.toFixed(1)).change()}})}(this);var l=this;return this.observables.viewerOpen.subscribe(function(e,t){s.resolve(l)},function(e){s.reject(e)}),this.observables.redrawRequired.subscribe(function(t){e&&console.log("viewer "+t.osState+"ed with target location ",t.targetLocation),l.redraw()}),o.Controls&&(this.controls=new o.Controls(this.config,this)),o.ZoomSlider&&(this.zoomSlider=new o.ZoomSlider(this.config,this),this.onFirstTileLoaded().then(function(){l.zoomSlider&&l.zoomSlider.init()})),o.Overlays&&(this.overlays=new o.Overlays(this.config,this)),o.DrawRect&&(this.drawRect=new o.DrawRect(this.config,this)),o.TransformRect&&(this.transformRect=new o.TransformRect(this.config,this)),this.observables.redrawRequired.connect(),s.promise},o.Image.prototype.getObservables=function(){return this.observables},o.Image.prototype.hasFooter=function(){return null!=this.footerImage},o.Image.prototype.getConfig=function(){return this.config},o.Image.prototype.loadFooter=function(){if(this.config.image.baseFooterUrl&&this.config.global.footerHeight>0){this.footerImage=new Image,this.footerImage.src=this.config.image.baseFooterUrl.replace("{width}",Math.round(this.container.width())).replace("{height}",Math.round(this.config.global.footerHeight)),this.footerImage.src=this.config.image.baseFooterUrl.replace("/full/max/","/full/!"+Math.round(this.container.width())+","+Math.round(this.config.global.footerHeight)+"/");var t=this;this.footerImage.onload=function(){e&&(console.log("loading footer image ",t.footerImage),console.log("Calculating image Footer size")),function(e){e&&e.viewer&&(i({userData:e}),e.viewer.removeHandler("update-viewport",i),e.viewer.addHandler("update-viewport",i,e))}(t)}}},o.Image.prototype.getOverlayGroup=function(e){for(var t=this.config.global.overlayGroups,o=0;o<t.length;o++){var i=t[o];if(i.name===e)return i}},o.Image.prototype.getHighlightCoordinates=function(e){var t=this.config.image.highlightCoords;if(t)for(var o=0;o<t.length;o++){var i=t[o];if(i.name===e)return i}},o.Image.prototype.getSizes=function(){return this.sizes},o.Image.prototype.getImageInfo=function(){return this.viewer?this.viewer.tileSources:null},o.Image.prototype.close=function(){e&&console.log("Closing openSeadragon viewer"),this.viewer&&this.viewer.destroy()},o.Image.prototype.redraw=function(){this.controls&&this.controls.setPanning(!0),this.sizes=function(t){e&&(console.log("viewImage: calcualte sizes"),console.log("Home zoom = ",t.viewer.viewport.getHomeZoom()));var o=new ImageView.Measures(t);(t.config.global.adaptContainerHeight||t.config.global.adaptContainerWidth)&&o.resizeCanvas();if(null!=t.viewer){var i=t.viewer.viewport.getMargins();i.bottom=o.footerHeight+o.calculateExcessHeight(),t.viewer.viewport.setMargins(i)}e&&console.log("sizes: ",o);return o}(this)},o.Image.prototype.onFirstTileLoaded=function(){var e=Q.defer();return this.observables?this.observables.firstTileLoaded.subscribe(function(t){e.resolve(t)},function(t){e.reject(t)}):e.reject("No observables defined"),e.promise},o.Image.prototype.getOriginalImageSize=function(){return new OpenSeadragon.Point(this.config.image.originalImageWidth,this.config.image.originalImageHeight)},o.Image.prototype.scaleToOpenSeadragon=function(e){return o.CoordinateConversion.scaleToOpenSeadragon(e,this.viewer,this.getOriginalImageSize())},o.Image.prototype.scaleToImage=function(e){return o.CoordinateConversion.scaleToImage(e,this.viewer,this.getOriginalImageSize())},o}();String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.substring(0,e.length).localeCompare(e)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return 0===this.substring(this.length-e.length,this.length).localeCompare(e)}),Array.prototype.find||(Array.prototype.find=function(e){for(var t=0;t<this.length;t++){var o=this[t];if(e(o))return o}}),Number.isNaN||(Number.isNaN=function(e){return e!=e});ImageView=function(e){"use strict";var t=!1,o={},i={sliderDilation:12};return e.ZoomSlider=function(e,t){this.config=$.extend(!0,{},i),$.extend(!0,this.config,e.global),this.image=t},e.ZoomSlider.prototype.init=function(){t&&(console.log("##############################"),console.log("imageView.zoomSlider.init"),console.log("##############################")),this.addZoomSlider(this.config.zoomSlider),this.buttonToZoom(this.image.viewer.viewport.getHomeZoom());var e=this;this.image.observables.viewerZoom.subscribe(function(t){var o=e.image.viewer.viewport.getZoom();e.buttonToZoom(o)})},e.ZoomSlider.prototype.exists=function(){return this.$element.length&&this.$button.length},e.ZoomSlider.prototype.buttonToMouse=function(e){t&&console.log("imageView.zoomSlider.buttonToMouse: mousePos - "+e);var o=this.$button.width()/2,i=e-o;i<0&&(i=0),i+2*o>this.absoluteWidth&&(i=this.absoluteWidth-2*o),this.$button.css({left:i}),this.buttonPosition=i;var n=i/(this.absoluteWidth-2*o);n=1/this.config.sliderDilation*Math.tan(Math.atan(this.config.sliderDilation)*n);var r=this.image.viewer.viewport.getMinZoom()+(this.image.viewer.viewport.getMaxZoom()-this.image.viewer.viewport.getMinZoom())*n;t&&console.log("imageView.zoomSlider.buttonToMouse: newScale - "+r),this.zoomTo(r)},e.ZoomSlider.prototype.zoomTo=function(e){t&&console.log("imageView.controls.myZoomTo: zoomTo - "+e);var o=parseFloat(e)/this.image.viewer.viewport.getZoom();t&&console.log("imageView.controls.myZoomTo: zoomBy - "+o),this.image.viewer.viewport.zoomBy(o,this.image.viewer.viewport.getCenter(!1),!0),this.setLabel(e)},e.ZoomSlider.prototype.buttonToZoom=function(e){if(t&&(console.log("imageView.zoomSlider.buttonToZoom: scale - "+e),console.log("imageView.zoomSlider.buttonToZoom: _zoomSlider - ",o)),this.image.viewer.viewport){if(this.$button){var i=(e-this.image.viewer.viewport.getMinZoom())/(this.image.viewer.viewport.getMaxZoom()-this.image.viewer.viewport.getMinZoom()),n=(i=1/Math.atan(this.config.sliderDilation)*Math.atan(this.config.sliderDilation*i))*(this.absoluteWidth-this.$button.width());Math.abs(this.image.viewer.viewport.getMaxZoom()-e)<1e-10&&(n=this.absoluteWidth-this.$button.width()),n<0&&(n=0),this.$button.css({left:n}),this.buttonPosition=n}this.setLabel(e)}},e.ZoomSlider.prototype.setLabel=function(e){if(this.$label.length&&this.image.sizes){var t=this.image.config.image.originalImageWidth,o=this.image.container.width();e=parseFloat(e)/t*o,e*=window.devicePixelRatio,this.$label.val((100*e).toFixed(1))}},e.ZoomSlider.prototype.inputToZoom=function(e){var o=parseFloat(e);if(o&&this.image.sizes){t&&console.log("scale to ",e);var i=o*this.image.config.image.originalImageWidth/this.image.container.width()/100;(i/=window.devicePixelRatio)<this.image.viewer.viewport.getMinZoom()?i=this.image.viewer.viewport.getMinZoom():i>this.image.viewer.viewport.getMaxZoom()&&(i=this.image.viewer.viewport.getMaxZoom()),this.zoomTo(i)}},e.ZoomSlider.prototype.addZoomSlider=function(e){t&&console.log("imageView.zoomSlider.addZoomSlider: element - "+e),this.buttonPosition=0,this.$element=$(e),this.absoluteWidth=this.$element.innerWidth(),this.mousedown=!1;var o=this;this.$element.length&&(this.$button=this.$element.children(this.config.zoomSliderHandle),this.$element.on("mousedown",function(e){!function(e,o){t&&console.log("imageView.zoomSlider.zoomSliderMouseDown: evt - "+e);o.mousedown=!0;var i=o.$element.offset(),n=e.pageX-i.left;o.buttonToMouse(n)}(e,o)}),this.$element.on("mousemove",function(e){!function(e,o){t&&console.log("imageView.zoomSlider.zoomSliderMouseMove: evt - "+e);if(!o.mousedown)return;var i=o.$element.offset(),n=e.pageX-i.left;o.buttonToMouse(n),t&&console.log("imageView.zoomSlider.zoomSliderMouseMove: moving - "+n)}(e,o)}),this.$button.length&&this.$button.on("mousedown",function(e){!function(e,o){t&&console.log("imageView.zoomSlider.buttonMouseDown");o.mousedown=!0}(0,o)})),this.$label=$(this.config.zoomSliderLabel),this.$label.length&&(this.$label.on("change",function(e){return o.inputToZoom(e.target.value),!1}),this.$label.on("keypress",function(e){if(13==e.which)return o.inputToZoom(e.target.value),!1})),$(document).on("mouseup",function(e){!function(e,o){t&&console.log("imageView.zoomSlider.zoomSliderMouseUp");o.mousedown=!1}(0,o)})},e}(ImageView=function(e){"use strict";var t="default",o=!1,i=.004;function n(t,o,i){var n=c(o,t.getTopLeft(),t.getBottomLeft()),r=c(o,t.getBottomLeft(),t.getBottomRight()),a=c(o,t.getTopRight(),t.getBottomRight()),s=c(o,t.getTopLeft(),t.getTopRight()),l=Math.min(n,Math.min(a,Math.min(s,r)));if(l<=i){if(n===l)return e.TransformRect.HitAreas.LEFT;if(a===l)return e.TransformRect.HitAreas.RIGHT;if(s===l)return e.TransformRect.HitAreas.TOP;if(r===l)return e.TransformRect.HitAreas.BOTTOM}return""}function r(t,o,i){var n=l(o,t.getTopLeft()),r=l(o,t.getBottomLeft()),a=l(o,t.getTopRight()),s=l(o,t.getBottomRight()),c=Math.min(n,Math.min(a,Math.min(r,s)));if(c<=i){if(n===c)return e.TransformRect.HitAreas.TOPLEFT;if(a===c)return e.TransformRect.HitAreas.TOPRIGHT;if(r===c)return e.TransformRect.HitAreas.BOTTOMLEFT;if(s===c)return e.TransformRect.HitAreas.BOTTOMRIGHT}return""}function a(e){return e*e}function s(e,t){return a(e.x-t.x)+a(e.y-t.y)}function l(e,t){return Math.sqrt(s(e,t))}function c(e,t,o){return Math.sqrt(function(e,t,o){var i=s(t,o);if(0==i)return s(e,t);var n=((e.x-t.x)*(o.x-t.x)+(e.y-t.y)*(o.y-t.y))/i;return s(e,n<0?t:n>1?o:{x:t.x+n*(o.x-t.x),y:t.y+n*(o.y-t.y)})}(e,t,o))}return e.TransformRect=function(a,s){o&&(console.log("##############################"),console.log("osViewer.transformRect.init"),console.log("##############################")),this.config=a,this.image=s;var l=this;this.viewerInputHook=s.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){if(t.drawing)e.preventDefaultAction=!0}(e,l)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,o){if(o.drawing){var i,n,r=o.image.viewer.viewport.viewerElementToViewportCoordinates(t.position),a=o.image.overlays.getDrawingOverlay().rect;if(o.drawArea===e.TransformRect.HitAreas.TOPLEFT)i=new OpenSeadragon.Point(Math.min(r.x,a.getBottomRight().x),Math.min(r.y,a.getBottomRight().y)),n=a.getBottomRight();else if(o.drawArea===e.TransformRect.HitAreas.TOPRIGHT)i=new OpenSeadragon.Point(a.getTopLeft().x,Math.min(r.y,a.getBottomRight().y)),n=new OpenSeadragon.Point(Math.max(r.x,a.getTopLeft().x),a.getBottomRight().y);else if(o.drawArea===e.TransformRect.HitAreas.BOTTOMLEFT)i=new OpenSeadragon.Point(Math.min(r.x,a.getBottomRight().x),a.getTopLeft().y),n=new OpenSeadragon.Point(a.getBottomRight().x,Math.max(r.y,a.getTopLeft().y));else if(o.drawArea===e.TransformRect.HitAreas.BOTTOMRIGHT)i=a.getTopLeft(),n=new OpenSeadragon.Point(Math.max(r.x,a.getTopLeft().x),Math.max(r.y,a.getTopLeft().y));else if(o.drawArea===e.TransformRect.HitAreas.LEFT)i=new OpenSeadragon.Point(Math.min(r.x,a.getBottomRight().x),a.getTopLeft().y),n=a.getBottomRight();else if(o.drawArea===e.TransformRect.HitAreas.RIGHT)i=a.getTopLeft(),n=new OpenSeadragon.Point(Math.max(r.x,a.getTopLeft().x),a.getBottomRight().y);else if(o.drawArea===e.TransformRect.HitAreas.TOP)i=new OpenSeadragon.Point(a.getTopLeft().x,Math.min(r.y,a.getBottomRight().y)),n=a.getBottomRight();else if(o.drawArea===e.TransformRect.HitAreas.BOTTOM)i=a.getTopLeft(),n=new OpenSeadragon.Point(a.getBottomRight().x,Math.max(r.y,a.getTopLeft().y));else if(o.drawArea===e.TransformRect.HitAreas.CENTER&&o.enterPoint){var s=o.enterPoint.x-r.x,l=o.enterPoint.y-r.y;a.x-=s,a.y-=l,o.enterPoint=r}return i&&n&&(a.x=i.x,a.y=i.y,a.width=n.x-i.x,a.height=n.y-i.y),o.image.viewer.updateOverlay(o.image.overlays.getDrawingOverlay().element,a,0),t.preventDefaultAction=!0,!0}if(o.drawArea)o.drawing=!0,t.preventDefaultAction=!0}(t,l)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(t){!function(t,a){if(a.active){if(!a.image.overlays.getDrawingOverlay())return!1;var s=a.image.overlays.getDrawingOverlay().rect,l=a.image.overlays.getDrawingOverlay().element,c=a.image.viewer.viewport.viewerElementToViewportCoordinates(t.position),g=r(s,c,i);g||(g=n(s,c,i)),!g&&a.image.overlays.contains(s,c,0)&&(g=e.TransformRect.HitAreas.CENTER),o&&console.log("draw area = "+g),g&&($(l).tooltip("destroy"),a.enterPoint=c),a.drawArea=g,t.preventDefaultAction=!0}}(t,l)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){if(t.drawing)t.drawing=!1,e.preventDefaultAction=!0}(e,l)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){if(t.active)t.drawing&&t.finishHook&&t.finishHook(t.image.overlays.getDrawingOverlay()),t.drawing=!1,t.image.overlays.getDrawingOverlay()&&$(t.image.overlays.getDrawingOverlay().element).tooltip(),t.drawArea="",t.enterPoint=null,e.preventDefaultAction=!0}(e,l)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(o){!function(o,a){if(!a.drawing&&a.active){var s=a.image.viewer.viewport.viewerElementToViewportCoordinates(o.position),l=a.image.overlays.getDrawingOverlay().rect,c=(a.image.overlays.getDrawingOverlay().element,a.image.viewer.element),g=r(l,s,i);g||(g=n(l,s,i)),!g&&a.image.overlays.contains(l,s,0)&&(g=e.TransformRect.HitAreas.CENTER),g?$(c).css({cursor:e.TransformRect.HitAreas.getCursor(g,a.image)}):$(c).css({cursor:t}),o.preventDefaultAction=!0}}(o,l)}}]})},e.TransformRect.prototype.startDrawing=function(e,t){o&&console.log("Start drawing"),this.image.overlays.setDrawingOverlay(e),this.active=!0,this.group=e.group,this.finishHook=t,$(e.element).addClass("transforming")},e.TransformRect.prototype.endDrawing=function(){this.drawing=!1,this.group=null,this.finishHook=null,this.active=!1;var e=this.image.overlays.getDrawingOverlay();null!=e&&($(e.element).removeClass("transforming"),$(e.element).css({cursor:t}))},e.TransformRect.prototype.isActive=function(){return this.active},e.TransformRect.HitAreas={TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(e,o){var i=o.viewer.viewport.getRotation()%180==90;return e===this.TOPLEFT||e===this.BOTTOMRIGHT?i?"nesw-resize":"nwse-resize":e===this.TOPRIGHT||e===this.BOTTOMLEFT?i?"nwse-resize":"nesw-resize":e===this.TOP||e===this.BOTTOM?i?"ew-resize":"ns-resize":e===this.RIGHT||e===this.LEFT?i?"ns-resize":"ew-resize":e===this.CENTER?"move":t}},e}(ImageView=function(e){"use strict";return e.TileSourceResolver={resolveAsJsonOrURI:function(e){var t=Q.defer();return this.isJson(e)?t.resolve(e):this.isStringifiedJson(e)?t.resolve(JSON.parse(e)):t.resolve(e),t.promise},resolveAsJson:function(e){var t=Q.defer();if(this.isURI(e)){if(this.isJsonURI(e))return this.loadJsonFromURL(e);t.reject("Url does not lead to a json object")}else if("string"==typeof e)try{var o=JSON.parse(e);t.resolve(o)}catch(e){t.reject("String does not contain valid json: "+e)}else"object"==typeof e?t.resolve(e):t.reject("Neither a url nor a json object");return t.promise},loadJsonFromURL:function(e){var t=Q.defer();return this.isJsonURI(e)?OpenSeadragon.makeAjaxRequest(e,function(e){try{t.resolve(JSON.parse(e.responseText))}catch(e){t.reject(e)}},function(e){t.reject(e)}):t.reject("Not a json uri: "+e),t.promise},loadIfJsonURL:function(t){return Q.promise(function(o,i){if(e.TileSourceResolver.isURI(t)){var n={url:decodeURI(t),type:"GET",dataType:"JSON",async:!0,crossDomain:!0,accepts:{application_json:"application/json",application_jsonLd:"application/ld+json",text_json:"text/json",text_jsonLd:"text/ld+json"}};Q($.ajax(n)).then(function(e){o(e)}).fail(function(e){i("Failed to retrieve json from "+t)}),setTimeout(function(){i("Timeout after 10s")},1e4)}else i("Not a uri: "+t)})},isJsonURI:function(e){if(this.isURI(e)){var t=e.replace(/\?.*/,"");return t.endsWith("/")&&(t=t.substring(0,t.length-1)),t.toLowerCase().endsWith(".json")}return!1},isURI:function(e){return!(!e||"string"!=typeof e||!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file:/")))},isStringifiedJson:function(e){if(e&&"string"==typeof e)try{var t=JSON.parse(e);return this.isJson(t)}catch(e){return!1}return!1},isJson:function(e){return e&&"object"==typeof e}},e}(ImageView=function(e){"use strict";var t=!1,o="focus",i="highlight";function n(n,r){t&&(console.log("viewImage.overlays._drawOverlay"),console.log("overlay: ",n));var a=document.createElement("div");$(a).attr("id","overlay_"+n.id);var s=r.image.getOverlayGroup(n.group);s&&(t&&console.log("overlay style",s),$(a).addClass(s.styleClass),n.type===e.Overlays.OverlayTypes.LINE&&function(e,o){t&&(console.log("Overlays _rotate: angle - "+e),console.log("Overlays _rotate: mapElement - "+o));if(0!==e){$(o).css("-moz-transform","rotate("+e+"deg)"),$(o).css("-webkit-transform","rotate("+e+"deg)"),$(o).css("-ms-transform","rotate("+e+"deg)"),$(o).css("-o-transform","rotate("+e+"deg)"),$(o).css("transform","rotate("+e+"deg)");var i=Math.sin(e),n=Math.cos(e);$(o).css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+n+", M12="+i+", M21=-"+i+", M22="+n+", sizingMethod='auto expand'")}}(n.angle,a),s.interactive&&(a.focus=function(e){e?($(a).addClass(o),function(e,t,o){if(t.title){var i=o.sizes.$container.offset(),n=$(e).offset().top,r=$(e).offset().left,a=($(e).outerHeight(),r+$(e).outerWidth()),s=$("<div class='tooltipp'>"+t.title+"</div>");$("body").append(s);var l=parseFloat(s.css("padding-top"));s.css("max-width",a-r),s.css("top",Math.max(i.top+l,n-s.outerHeight()-l)),s.css("left",Math.max(i.left+l,r)),s.attr("id","tooltip_"+t.id),o.observables.animation.do(function(){var t=Math.max($(e).offset().top,i.top),o=Math.max($(e).offset().left,i.left);s.css("top",Math.max(i.top+l,t-s.outerHeight()-l)),s.css("left",Math.max(i.left+l,o))}).takeWhile(function(){return $(".tooltipp").length>0}).subscribe()}}(a,n,r.image)):($(a).removeClass(o),$(".tooltipp#tooltip_"+n.id).remove()),r.overlayFocusHook&&r.overlayFocusHook(n,e)},a.highlight=function(e){e?$(a).addClass(i):$(a).removeClass(i)},$(a).on("mouseover",function(){t&&console.log("Overlays _drawOverlay: mouse over - "+s.name),r.focusBox(n.group,n.id)}),$(a).on("mouseout",function(){t&&console.log("Overlays _drawOverlay: mouse out - "+s.name),a.focus(!1)}),$(a).on("click",function(){r.overlayClickHook&&r.overlayClickHook(n)})),n.element=a,r.image.viewer.addOverlay(a,n.rect,0))}function r(e,t,o){return t.x>e.x-o&&t.x<e.x+e.width+o&&t.y>e.y-o&&t.y<e.y+e.height+o}return e.Overlays=function(e,o){t&&(console.log("##############################"),console.log("osViewer.overlays.init"),console.log("##############################")),this.config=e,this.image=o,this.overlays=[];var i=this;this.image.observables.overlayRemove.subscribe(function(e){e.element&&$(e.element).remove()}),this.config.image.highlightCoords&&this.image.observables.viewerOpen.subscribe(function(e){for(var t=0;t<i.config.image.highlightCoords.length;t++){var o=i.config.image.highlightCoords[t],n=o.pageIndex;i.draw(o.name,o.displayTooltip,n)}i.initializedCallback&&i.initializedCallback()})},e.Overlays.prototype.onInitialized=function(e){var t=this.initializedCallback;this.initializedCallback=function(){t&&t(),e()}},e.Overlays.prototype.onFocus=function(e){var t=this.overlayFocusHook;this.overlayFocusHook=function(o,i){t&&t(o,i),e(o,i)}},e.Overlays.prototype.onClick=function(e){var t=this.overlayClickHook;this.overlayClickHook=function(o){t&&t(o),e(o)}},e.Overlays.prototype.getOverlays=function(){return this.overlays.slice()},e.Overlays.prototype.getRects=function(){return this.overlays.filter(function(t){return t.type===e.Overlays.OverlayTypes.RECTANGLE}).slice()},e.Overlays.prototype.getLines=function(){return this.overlays.filter(function(t){return t.type===e.Overlays.OverlayTypes.LINE}).slice()},e.Overlays.prototype.draw=function(e,o,i){t&&(console.log("osViewer.overlays.draw: group - "+e),console.log("osViewer.overlays.draw: displayTitle - "+o),console.log("osViewer.overlays.draw: imageIndex - "+i));var n=this.image.getHighlightCoordinates(e);if(n){"string"==typeof n.coordinates&&(t&&console.log("convert "+n+" to coordinate list"),n.coordinates=function(e,t){if(e){var o=e.match(/xywh=(percent:)?([\d\.\-\+]+,[\d\.\-\+]+,[\d\.\-\+]+,[\d\.\-\+]+)/);if(o){var i,n,r,a,s=void 0!=o[1],l=o[2];return l=l.split(","),s?(i=parseInt(l[0])*t.x/100,n=parseInt(l[1])*t.y/100,r=parseInt(l[2])*t.x/100,a=parseInt(l[3])*t.y/100):(i=parseInt(l[0]),n=parseInt(l[1]),r=parseInt(l[2]),a=parseInt(l[3])),i=Math.max(Math.min(t.x,i),0),n=Math.max(Math.min(t.y,n),0),r=Math.max(Math.min(t.x-i,r),0),a=Math.max(Math.min(t.y-n,a),0),[[i,n,i+r,n+a,"",""]]}}return[]}(n.coordinates,this.image.getOriginalImageSize()));for(var r=0;r<n.coordinates.length;r++){var a=n.coordinates[r],s=o&&a.length>4?a[4]:"",l=a.length>5?a[5]:r;this.createRectangle(a[0],a[1],a[2]-a[0],a[3]-a[1],s,l,e,i)}}},e.Overlays.prototype.unDraw=function(e){t&&console.log("osViewer.overlays.unDraw: group - "+e);this.overlays=this.overlays.filter(function(t){return t.group!==e||(this.image.viewer.removeOverlay(t.element),!1)})},e.Overlays.prototype.highlight=function(e){t&&console.log("osViewer.overlays.highlight: group - "+e),this.overlays.filter(function(t){return t.group===e}).forEach(function(e){e.element&&e.element.highlight(!0)})},e.Overlays.prototype.unHighlight=function(e){t&&console.log("osViewer.overlays.unHighlight: group - "+e),this.overlays.filter(function(t){return t.group===e}).forEach(function(e){e.element&&e.element.highlight(!1)})},e.Overlays.prototype.focusBox=function(e,o){t&&(console.log("osViewer.overlays.highlightBox: group - "+e),console.log("osViewer.overlays.highlightBox: id - "+o)),this.overlays.filter(function(t){return t.group===e}).forEach(function(e){e.element&&e.element.focus(e.id===o)})},e.Overlays.prototype.addOverlay=function(e){t&&console.log("osViewer.overlays.addOverlay: overlay - "+e),this.overlays.push(e),e.element&&this.image.viewer.updateOverlay(e.element,e.rect,0)},e.Overlays.prototype.removeOverlay=function(e){if(e){t&&console.log("Removing overlay "+e.id);var o=this.overlays.indexOf(e);this.overlays.splice(o,1),e.element&&this.image.viewer.removeOverlay(e.element)}},e.Overlays.prototype.drawRect=function(e,o,i,n){t&&(console.log("osViewer.overlays.drawRect: rectangle - "+e),console.log("osViewer.overlays.drawRect: group - "+o)),this.createRectangle(e.x,e.y,e.width,e.height,i||"",n||"",o)},e.Overlays.prototype.drawLine=function(e,o,i){t&&(console.log("osViewer.overlays.drawLine: point1 - "+e),console.log("osViewer.overlays.drawLine: point2 - "+o),console.log("osViewer.overlays.drawLine: group - "+i)),this.createLine(e.x,e.y,o.x,o.y,"","",i)},e.Overlays.prototype.showOverlay=function(e){e&&!e.element&&(n(e,this),this.overlayFocusHook&&this.overlayFocusHook(e,!0))},e.Overlays.prototype.hideOverlay=function(e){e&&e.element&&this.drawingOverlay!=e&&(!function(e,t){t.image.viewer.removeOverlay(e.element),e.element=null}(e,this),this.overlayFocusHook&&this.overlayFocusHook(e,!1))},e.Overlays.prototype.getOverlay=function(e,t){return this.overlays.find(function(o){return t?o.id===e&&o.group===t:o.id===e})},e.Overlays.prototype.getCoordinates=function(o){return t&&console.log("getCoordinates - overlay",o),o.type===e.Overlays.OverlayTypes.RECTANGLE?this.image.viewer.viewport.viewportToImageRectangle(o.rect):o.type===e.Overlays.OverlayTypes.LINE?{point1:this.image.viewer.viewport.viewportToImageCoordinates(o.poin1),point2:this.image.viewer.viewport.viewportToImageCoordinates(o.poin2)}:void 0},e.Overlays.prototype.getDrawingOverlay=function(){return this.drawingOverlay},e.Overlays.prototype.setDrawingOverlay=function(e){this.drawingOverlay=e},e.Overlays.prototype.showHiddenOverlays=function(){var e=this;this.image.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"moveHandler",hookHandler:function(t){!function(e,t){var o=e.position,i=viewerJS.helper.detectIEVersion();i&&10===i&&(o.x+=$(window).scrollLeft(),o.y+=$(window).scrollTop());var n=t.image.viewer.viewport.viewerElementToViewportCoordinates(o);t.overlays.forEach(function(e){r(e.rect,n,0)?t.showOverlay(e):t.hideOverlay(e)})}(t,e)}}]})},e.Overlays.prototype.contains=function(e,t,o){return null==o&&(o=0),r(e,t,o)},e.Overlays.OverlayTypes={RECTANGLE:"rectangle",LINE:"line"},e.Overlays.prototype.createLine=function(o,i,r,a,s,l,c){t&&(console.log("------------------------------"),console.log("Overlays _createLine: x1 - "+o),console.log("Overlays _createLine: y1 - "+i),console.log("Overlays _createLine: x2 - "+r),console.log("Overlays _createLine: y2 - "+a),console.log("Overlays _createLine: title - "+s),console.log("Overlays _createLine: id - "+l),console.log("Overlays _createLine: group - "+c),console.log("------------------------------"));var g=new OpenSeadragon.Point(o,i),h=new OpenSeadragon.Point(r,a),u=g.distanceTo(h),v=function(e,o){t&&(console.log("Overlays _calculateAngle: p1 - "+e),console.log("Overlays _calculateAngle: p2 - "+o));var i=o.x-e.x,n=o.y-e.y;return i>0?180*Math.atan(n/i)/Math.PI:i<0?180*Math.atan(n/i)/Math.PI+180:n<0?270:90}(g,h),d=(180-v)/2;i+=u/2*Math.sin(v*Math.PI/180),o-=u/2*Math.sin(v*Math.PI/180)/Math.tan(d*Math.PI/180);var f=this.image.viewer.viewport.imageToViewportRectangle(o,i,u,1),p=this.image.viewer.viewport.imageToViewportCoordinates(g),m=this.image.viewer.viewport.imageToViewportCoordinates(h),w={type:e.Overlays.OerlayTypes.LINE,rect:f,angle:v,point1:p,point2:m,group:c,id:l,title:s};this.getOverlayGroup(w.group).hidden||n(w,this),this.overlays.push(w)},e.Overlays.prototype.createRectangle=function(o,i,r,a,s,l,c,g){t&&(console.log("------------------------------"),console.log("Overlays _createRectangle: x - "+o),console.log("Overlays _createRectangle: y - "+i),console.log("Overlays _createRectangle: width - "+r),console.log("Overlays _createRectangle: height - "+a),console.log("Overlays _createRectangle: title - "+s),console.log("Overlays _createRectangle: id - "+l),console.log("Overlays _createRectangle: group - "+c),console.log("Overlays _createRectangle: imageIndex - "+g),console.log("------------------------------")),g||(g=0);var h=this.image.viewer.world.getItemAt(g).imageToViewportRectangle(o,i,r,a),u={type:e.Overlays.OverlayTypes.RECTANGLE,rect:h,group:c,id:l,title:s},v=this.image.getOverlayGroup(u.group);v&&!v.hidden&&n(u,this),this.overlays.push(u)},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";var t=4;return e.Transform=function(o,i,n){var r;this.viewer=o,this.style=i,this.startCondition=n,this.active=!0,this.transforming=!1,this.currentOverlay=null,this.drawArea=null,this.startPoint=null,this.overlays=[],this.finishedObservable=new Rx.Subject,this.cursor=void 0,(r=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,o){if(o.isTransforming()){var i=new OpenSeadragon.Point(t.position.x,t.position.y),n=e.CoordinateConversion.convertCoordinatesFromImageToCanvas(o.currentOverlay.rect,o.viewer),r=null,a=null;if(o.drawArea===e.Overlay.HitAreas.TOPLEFT)r=new OpenSeadragon.Point(Math.min(i.x,n.getBottomRight().x),Math.min(i.y,n.getBottomRight().y)),a=n.getBottomRight();else if(o.drawArea===e.Overlay.HitAreas.TOPRIGHT)r=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(i.y,n.getBottomRight().y)),a=new OpenSeadragon.Point(Math.max(i.x,n.getTopLeft().x),n.getBottomRight().y);else if(o.drawArea===e.Overlay.HitAreas.BOTTOMLEFT)r=new OpenSeadragon.Point(Math.min(i.x,n.getBottomRight().x),n.getTopLeft().y),a=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(i.y,n.getTopLeft().y));else if(o.drawArea===e.Overlay.HitAreas.BOTTOMRIGHT)r=n.getTopLeft(),a=new OpenSeadragon.Point(Math.max(i.x,n.getTopLeft().x),Math.max(i.y,n.getTopLeft().y));else if(o.drawArea===e.Overlay.HitAreas.LEFT)r=new OpenSeadragon.Point(Math.min(i.x,n.getBottomRight().x),n.getTopLeft().y),a=n.getBottomRight();else if(o.drawArea===e.Overlay.HitAreas.RIGHT)r=n.getTopLeft(),a=new OpenSeadragon.Point(Math.max(i.x,n.getTopLeft().x),n.getBottomRight().y);else if(o.drawArea===e.Overlay.HitAreas.TOP)r=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(i.y,n.getBottomRight().y)),a=n.getBottomRight();else if(o.drawArea===e.Overlay.HitAreas.BOTTOM)r=n.getTopLeft(),a=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(i.y,n.getTopLeft().y));else if(o.drawArea===e.Overlay.HitAreas.CENTER&&o.startPoint){var s=o.startPoint.x-i.x,l=o.startPoint.y-i.y;n.x-=s,n.y-=l,o.startPoint=i}r&&a&&(n=new OpenSeadragon.Rect(r.x,r.y,a.x-r.x,a.y-r.y)),o.currentOverlay.rect=e.CoordinateConversion.convertCoordinatesFromCanvasToImage(n,o.viewer),o.viewer.forceRedraw(),t.preventDefaultAction=!0}}(t,r)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentOverlay&&t.drawArea){var o=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=o,t.transforming=!0,e.preventDefaultAction=!0,!0}t.transforming=!1}}(e,r)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(t.transforming&&t.finishedObservable.onNext(t.currentOverlay),t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(o){!function(o,i){if(!i.isTransforming()&&i.isActive()&&i.startCondition(o.originalEvent)){var n=new OpenSeadragon.Point(o.position.x,o.position.y),r=i.getContainingOverlay(n),a=i.viewer.element;if(r?(i.currentOverlay=r,i.drawArea=r.getHitArea(n,t,!0)):(i.currentOverlay=null,i.drawArea=null),i.drawArea){var s=e.Overlay.HitAreas.getCursor(i.drawArea);i.cursor!=s&&(i.cursor=s,$(a).css({cursor:s}))}else i.cursor&&(i.cursor=void 0,$(a).css({cursor:DEFAULT_CURSOR}));o.preventDefaultAction=!0}}(o,r)}}]})},e.Transform.prototype.addOverlay=function(e){return!this.overlays.includes(e)&&(this.overlays.push(e),!0)},e.Transform.prototype.removeOverlay=function(e){if(this.overlays.includes(e)){var t=this.overlays.indexOf(e);return this.overlays.splice(t,1),!0}return!1},e.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},e.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Transform.prototype.isActive=function(){return this.active},e.Transform.prototype.isTransforming=function(){return this.transforming},e.Transform.prototype.getContainingOverlay=function(e){for(var o in this.overlays){var i=this.overlays[o];if(i.contains(e,t,!0))return i}return null},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";var t="default",o="not-allowed";return e.Remove=function(e,i){var n;this.viewer=e,this.startCondition=i,this.active=!0,this.currentOverlay=null,this.overlays=[],this.finishedObservable=new Rx.Subject,(n=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isActive()&&t.startCondition(e.originalEvent)&&t.currentOverlay&&(t.currentOverlay.remove(),t.finishedObservable.onNext(t.currentOverlay),t.currentOverlay=null)}(e,n)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(e){!function(e,i){if(i.isActive()&&i.startCondition(e.originalEvent)){var n=e.position,r=i.getContainingOverlay(n),a=i.viewer.element;i.currentOverlay=r||null,i.currentOverlay?$(a).css({cursor:o}):$(a).css({cursor:t}),e.preventDefaultAction=!0}}(e,n)}}]})},e.Remove.prototype.addOverlay=function(e){return!this.overlays.includes(e)&&(this.overlays.push(e),!0)},e.Remove.prototype.removeOverlay=function(e){if(this.overlays.includes(e)){var t=this.overlays.indexOf(e);return this.overlays.splice(t,1),!0}return!1},e.Remove.prototype.finishedRemoving=function(){return this.finishedObservable},e.Remove.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Remove.prototype.isActive=function(){return this.active},e.Remove.prototype.getContainingOverlay=function(e){for(var t in this.overlays){var o=this.overlays[t];if(o.contains(e,4,!0))return o}return null},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";function t(e,t,o){e=e.times(window.devicePixelRatio),o.beginPath(),o.lineWidth=t.borderWidth,o.strokeStyle=t.borderColor,o.rect(e.x,e.y,e.width,e.height),o.stroke()}return e.Draw=function(e,t,o){var i;this.viewer=e,this.style=t,this.startCondition=o,this.active=!0,this.drawing=!1,this.currentRect=null,this.startPoint=null,this.finishedObservable=new Rx.Subject,(i=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(e.preventDefaultAction=!0)}(e,i)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,t){if(t.isDrawing()){var o=new OpenSeadragon.Point(e.position.x,e.position.y);t.updateOverlay(o),e.preventDefaultAction=!0}}(e,i)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){var o=new OpenSeadragon.Point(e.position.x,e.position.y);t.createEmptyRectAt(o),e.preventDefaultAction=!1,t.drawing=!0}}(e,i)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){if(t.isDrawing()){t.drawing=!1;var o=ImageView.CoordinateConversion.convertCoordinatesFromCanvasToImage(t.currentRect,t.viewer),i=new ImageView.Overlay(o,t.viewer,t.style);t.finishedObservable.onNext(i),e.preventDefaultAction=!0}}(e,i)}}]})},e.Draw.prototype.finishedDrawing=function(){return this.finishedObservable},e.Draw.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Draw.prototype.isActive=function(){return this.active},e.Draw.prototype.isDrawing=function(){return this.drawing},e.Draw.prototype.createEmptyRectAt=function(e){this.currentRect=new OpenSeadragon.Rect(e.x,e.y,0,0),this.startPoint=e,t(this.currentRect,this.style,this.viewer.drawer.context)},e.Draw.prototype.updateOverlay=function(e){this.viewer.forceRedraw();var o=this;this.viewer.addOnceHandler("update-viewport",function(i){o.isDrawing()&&(o.currentRect.x=Math.min(o.startPoint.x,e.x),o.currentRect.y=Math.min(o.startPoint.y,e.y),o.currentRect.width=Math.abs(o.startPoint.x-e.x),o.currentRect.height=Math.abs(o.startPoint.y-e.y),t(o.currentRect,o.style,o.viewer.drawer.context))})},e}(ImageView=function(e){"use strict";return e.Measures=function(e){if(this.config=e.getConfig(),this.$container=$("#"+this.config.global.divId),this.originalImageSize=new OpenSeadragon.Point(this.getTotalImageWidth(e.getImageInfo()),this.getMaxImageHeight(e.getImageInfo())),this.config.global.adaptContainerWidth){let e=this.$container.height(),t=this.getAspectRatio();this.$container.width(e/t)}this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()),this.footerHeight=this.config.global.footerHeight,this.rotation=null!=e.viewer?e.viewer.viewport.getRotation():0,this.xPadding=this.outerCanvasSize.x-this.innerCanvasSize.x,this.yPadding=this.outerCanvasSize.y-this.innerCanvasSize.y,this.innerCanvasSize.y-=this.footerHeight,this.fitToHeight()?this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.y/this.ratio(this.getRotatedSize(this.originalImageSize)),this.innerCanvasSize.y):this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.x,this.innerCanvasSize.x*this.ratio(this.getRotatedSize(this.originalImageSize))),this.rotated()&&(this.imageDisplaySize=this.getRotatedSize(this.imageDisplaySize))},e.Measures.prototype.getMaxImageWidth=function(e){var t=0;if(e&&e.length>0)for(var o=0;o<e.length;o++){var i=e[o];i.tileSource&&(correction=i.width,i=i.tileSource),t=Math.max(t,i.width*correction)}return t},e.Measures.prototype.getMaxImageHeight=function(e){var t=0;if(e&&e.length>0)for(var o=0;o<e.length;o++){var i=e[o],n=1;i.tileSource&&(n=i.width,i=i.tileSource),t=Math.max(t,i.height*n)}return t},e.Measures.prototype.getTotalImageWidth=function(e){var t=0;if(e&&e.length>0)for(var o=0;o<e.length;o++){var i=e[o],n=1;i.tileSource&&(n=i.width,i=i.tileSource),t+=i.width*n}return t},e.Measures.prototype.getTotalImageHeight=function(e){var t=0;if(e&&e.length>0)for(var o=0;o<e.length;o++){var i=e[o];i.tileSource&&(correction=i.width,i=i.tileSource),t+=i.height*correction}return t},e.Measures.prototype.getImageHomeSize=function(){var e=this.rotated()?1/this.ratio(this.originalImageSize):this.ratio(this.originalImageSize);if(this.fitToHeight())var t=(o=this.innerCanvasSize.y)/e;else var o=(t=this.innerCanvasSize.x)*e;return this.getRotatedSize(new OpenSeadragon.Point(t,o))},e.Measures.prototype.rotated=function(){return this.rotation%180!=0},e.Measures.prototype.landscape=function(){return this.ratio(this.originalImageSize)<1},e.Measures.prototype.ratio=function(e){return e.y/e.x},e.Measures.prototype.getRotatedSize=function(e){return new OpenSeadragon.Point(this.rotated()?e.y:e.x,this.rotated()?e.x:e.y)},e.Measures.prototype.fitToHeight=function(){return!this.config.global.adaptContainerHeight&&this.ratio(this.getRotatedSize(this.originalImageSize))>this.ratio(this.innerCanvasSize)},e.Measures.prototype.resizeCanvas=function(){this.config.global.adaptContainerHeight&&this.$container.height(this.getRotatedSize(this.imageDisplaySize).y+this.footerHeight),this.config.global.adaptContainerWidth&&this.$container.width(this.getRotatedSize(this.imageDisplaySize).x),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()-this.footerHeight)},e.Measures.prototype.calculateExcessHeight=function(){var e=this.getRotatedSize(this.getImageHomeSize());return this.config.global.adaptContainerHeight||this.config.global.adaptContainerWidth||this.fitToHeight()?0:.5*(this.innerCanvasSize.y-e.y)},e.Measures.prototype.getAspectRatio=function(){return this.originalImageSize.y/this.originalImageSize.x},e}(ImageView=function(e){"use strict";if(!e||!e.Line)throw"imageView and imageView.Overlay must be initialized first";var t="default",o=4;return e.Line.Transform=function(i,n,r){var a;this.viewer=i,this.style=n,this.startCondition=r,this.active=!0,this.transforming=!1,this.currentLine=null,this.drawArea=null,this.startPoint=null,this.lines=[],this.finishedObservable=new Rx.Subject,this.cursor=void 0,this.fixed=e.Line.getFixed(!1),(a=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(e.preventDefaultAction=!0)}(e,a)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,o){if(o.isTransforming()){var i=new OpenSeadragon.Point(t.position.x,t.position.y),n=e.CoordinateConversion.convertPointFromImageToCanvas(o.currentLine.p1,o.viewer),r=e.CoordinateConversion.convertPointFromImageToCanvas(o.currentLine.p2,o.viewer),a=null,s=null;if(o.drawArea===e.Line.HitAreas.POINT_1){var l=o.currentLine.fixed.p1.x?n.x:i.x,c=o.currentLine.fixed.p1.y?n.y:i.y;a=new OpenSeadragon.Point(l,c),s=r}else if(o.drawArea===e.Line.HitAreas.POINT_2){var l=o.currentLine.fixed.p2.x?r.x:i.x,c=o.currentLine.fixed.p2.y?r.y:i.y;a=n,s=new OpenSeadragon.Point(l,c)}else if(o.drawArea===e.Line.HitAreas.LINE&&o.startPoint){var g=o.currentLine.fixed.line.x?0:o.startPoint.x-i.x,h=o.currentLine.fixed.line.y?0:o.startPoint.y-i.y,u=new OpenSeadragon.Point(g,h);a=n.minus(u),s=r.minus(u),o.startPoint=i}else a=n,s=r;var v=e.CoordinateConversion.convertPointFromCanvasToImage(a,o.viewer),d=e.CoordinateConversion.convertPointFromCanvasToImage(s,o.viewer);o.currentLine.p1=v,o.currentLine.p2=d,o.viewer.forceRedraw(),t.preventDefaultAction=!0}}(t,a)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentLine&&t.drawArea){console.log("transform draw area ",t.drawArea);var o=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=o,t.transforming=!0,e.preventDefaultAction=!0,!0}t.transforming=!1}}(e,a)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(t.transforming=!1,e.preventDefaultAction=!0)}(e,a)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(t.transforming&&t.finishedObservable.onNext(t.currentLine),t.transforming=!1,e.preventDefaultAction=!0)}(e,a)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(i){!function(i,n){if(!n.isTransforming()&&n.isActive()&&n.startCondition(i.originalEvent)){var r=new OpenSeadragon.Point(i.position.x,i.position.y),a=n.getContainingLine(r),s=n.viewer.element;if(a?(n.currentLine=a,n.drawArea=a.getHitArea(r,o,!0)):(n.currentLine=null,n.drawArea=null),n.drawArea){var l=e.Line.HitAreas.getCursor(n.drawArea,a.fixed);n.cursor!=l&&(n.cursor=l,$(s).css({cursor:l}))}else n.cursor&&(n.cursor=void 0,$(s).css({cursor:t}));i.preventDefaultAction=!0}}(i,a)}}]})},e.Line.Transform.prototype.addLine=function(e){return!this.lines.includes(e)&&(this.lines.push(e),!0)},e.Line.Transform.prototype.removeLine=function(e){if(this.lines.includes(e)){var t=this.lines.indexOf(e);return this.lines.splice(t,1),!0}return!1},e.Line.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},e.Line.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Line.Transform.prototype.isActive=function(){return this.active},e.Line.Transform.prototype.isTransforming=function(){return this.transforming},e.Line.Transform.prototype.getContainingLine=function(e){for(var t in this.lines){var i=this.lines[t];if(i.contains(e,o,!0))return i}return null},e}(ImageView=function(e){"use strict";if(!e)throw"Image view must exist";function t(e){var t=e.userData;if(!t.hidden){var o=t.viewer.drawer.context,i=ImageView.CoordinateConversion.convertPointFromImageToCanvas(t.p1,t.viewer),n=ImageView.CoordinateConversion.convertPointFromImageToCanvas(t.p2,t.viewer);o.beginPath(),o.lineWidth=t.style.lineWidth,o.strokeStyle=t.style.lineColor,o.moveTo(i.x,i.y),o.lineTo(n.x,n.y),o.stroke()}}function o(e,t,o,i){return function(e,t,o){return Math.sqrt(function(e,t,o){var i=n(t,o);if(0==i)return n(e,t);var r=((e.x-t.x)*(o.x-t.x)+(e.y-t.y)*(o.y-t.y))/i;return n(e,r<0?t:r>1?o:{x:t.x+r*(o.x-t.x),y:t.y+r*(o.y-t.y)})}(e,t,o))}(o,e,t)<=i}function i(e){return e*e}function n(e,t){return i(e.x-t.x)+i(e.y-t.y)}function r(e,t){return Math.sqrt(n(e,t))}return e.Line=function(t,o,i,n){this.viewer=i,this.p1=new OpenSeadragon.Point(t.x,t.y),this.p2=new OpenSeadragon.Point(o.x,o.y),this.style=n,this.fixed=e.Line.getFixed(!1),this.hidden=!1},e.Line.getFixed=function(e){return{p1:{x:e,y:e},p2:{x:e,y:e},line:{x:e,y:e}}},e.Line.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},e.Line.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},e.Line.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},e.Line.prototype.contains=function(t,i,n){return o(n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p1,this.viewer):this.p1,n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p2,this.viewer):this.p2,t,i)},e.Line.prototype.getHitArea=function(t,i,n){var a=n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p1,this.viewer):this.p1,s=n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p2,this.viewer):this.p2;return r(t,a)<=i?e.Line.HitAreas.POINT_1:r(t,s)<=i?e.Line.HitAreas.POINT_2:o(a,s,t,i)?e.Line.HitAreas.LINE:void 0},e.Line.prototype.hide=function(e){this.hidden=!0,e&&this.viewer.forceRedraw()},e.Line.prototype.show=function(e){this.hidden=!1,e&&this.viewer.forceRedraw()},e.Line.convertStringToPoints=function(e){var t=e.split(",");if(t&&4==t.length)return{p1:new OpenSeadragon.Point(parseFloat(t[0]),parseFloat(t[1])),p2:new OpenSeadragon.Point(parseFloat(t[2]),parseFloat(t[3]))};throw"Cannot convert string '"+e+"' to Points"},e.Line.convertPointsToString=function(e,t){return t||(t=0),e.p1.x.toFixed(t)+","+e.p1.y.toFixed(t)+","+e.p2.x.toFixed(t)+","+e.p2.y.toFixed(t)},e.Line.HitAreas={POINT_1:"point1",POINT_2:"point2",LINE:"line",isCorner:function(e){return e===this.POINT_1||e===this.POINT_2},isEdge:function(e){return e===this.LINE},getCursor:function(e,t){return e===this.POINT_1?t.p1.x||t.p1.y?t.p1.x?"ns-resize":t.p1.y?"ew-resize":"not-allowed":"move":e===this.POINT_2?t.p2.x||t.p2.y?t.p2.x?"ns-resize":t.p2.y?"ew-resize":"not-allowed":"move":e===this.LINE?t.line.x||t.line.y?t.line.x?"ns-resize":t.line.y?"ew-resize":"not-allowed":"move":void 0}},e}(ImageView=function(e){"use strict";var t=!1,o="drawing",i=5,n=.01,r=!1,a=!0;return e.DrawRect=function(s,l){t&&(console.log("##############################"),console.log("osViewer.drawRect.init"),console.log("##############################")),this.config=s,this.image=l;var c=this;this.viewerInputHook=l.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e){if(r)e.preventDefaultAction=!0}(e)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,i){if(i.drawing){var r=i.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),s=new OpenSeadragon.Rect(i.drawPoint.x,i.drawPoint.y,r.x-i.drawPoint.x,r.y-i.drawPoint.y);return r.x<i.drawPoint.x&&(s.x=r.x,s.width=i.drawPoint.x-r.x),r.y<i.drawPoint.y&&(s.y=r.y,s.height=i.drawPoint.y-r.y),i.image.viewer.updateOverlay(i.drawElement,s,0),e.preventDefaultAction=!0,!0}if(i.active&&i.drawPoint){var l=i.image.overlays.getDrawingOverlay();if(l&&i.image.transformRect&&i.image.transformRect.isActive()&&i.image.overlays.contains(l.rect,i.drawPoint,n))i.drawPoint=null,t&&console.log("Action overlaps active overlay");else{i.drawing=!0,l&&a&&i.image.overlays.removeOverlay(l),i.drawElement=document.createElement("div"),i.overlayGroup&&$(i.drawElement).addClass(i.overlayGroup.styleClass),$(i.drawElement).addClass(o);var s=new OpenSeadragon.Rect(i.drawPoint.x,i.drawPoint.y,0,0);i.image.viewer.addOverlay(i.drawElement,s,1)}e.preventDefaultAction=!0}}(e,c)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.active)t.drawPoint=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),e.preventDefaultAction=!1}(e,c)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(t){!function(t,o){if(o.drawing){o.drawing=!1;var n=o.image.viewer.viewport.viewerElementToViewportCoordinates(t.position),r=new OpenSeadragon.Rect(o.drawPoint.x,o.drawPoint.y,n.x-o.drawPoint.x,n.y-o.drawPoint.y);n.x<o.drawPoint.x&&(r.x=n.x,r.width=o.drawPoint.x-n.x),n.y<o.drawPoint.y&&(r.y=n.y,r.height=o.drawPoint.y-n.y),r.hitBox={l:r.x-i,t:r.y-i,r:r.x+r.width+i,b:r.y+r.height+i};var a={type:e.Overlays.OverlayTypes.RECTANGLE,element:o.drawElement,rect:r,group:o.overlayGroup.name};o.image.overlays.setDrawingOverlay(a),o.finishHook&&o.finishHook(a),t.preventDefaultAction=!0}}(t,c)}}]})},e.DrawRect.prototype.startDrawing=function(e,t){this.active=!0,this.overlayGroup=e,this.finishHook=t},e.DrawRect.prototype.endDrawing=function(e){this.active=!1,this.overlayGroup=null,this.finishHook=null,this.drawElement&&e?this.image.viewer.removeOverlay(this.drawElement):$(this.drawElement).removeClass(o)},e.DrawRect.prototype.isActive=function(){return this.active},e.DrawRect.prototype.isDrawing=function(){return this.drawing},e.DrawRect.prototype.removeLastDrawnElement=function(){this.drawElement&&this.image.viewer.removeOverlay(this.drawElement)},e}(ImageView=function(e){"use strict";if(!e||!e.DataPoint)throw"imageView and imageView.DataPoint must be initialized first";var t="default",o=4;return e.DataPoint.Transform=function(i,n){var r;this.viewer=i,this.startCondition=n,this.active=!0,this.transforming=!1,this.currentDataPoint=null,this.drawArea=null,this.dataPoints=[],this.finishedObservable=new Rx.Subject,this.cursor=void 0,(r=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,o){if(o.isTransforming()){var i=new OpenSeadragon.Point(t.position.x,t.position.y),n=e.CoordinateConversion.convertPointFromImageToCanvas(o.currentDataPoint.point,o.viewer),r=null;o.drawArea===e.DataPoint.HitAreas.POINT?r=i:o.drawArea===e.DataPoint.HitAreas.LINE_X?(console.log("move line x"),r=new OpenSeadragon.Point(n.x,i.y)):r=o.drawArea===e.DataPoint.HitAreas.LINE_Y?new OpenSeadragon.Point(i.x,n.y):n;var a=e.CoordinateConversion.convertPointFromCanvasToImage(r,o.viewer);o.currentDataPoint.point=a,o.viewer.forceRedraw(),t.preventDefaultAction=!0}}(t,r)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentDataPoint&&t.drawArea){var o=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=o,t.transforming=!0,e.preventDefaultAction=!0,!0}t.transforming=!1}}(e,r)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(t.transforming&&t.finishedObservable.onNext(t.currentDataPoint),t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(i){!function(i,n){if(!n.isTransforming()&&n.isActive()&&n.startCondition(i.originalEvent)){var r=new OpenSeadragon.Point(i.position.x,i.position.y),a=n.getContainingDataPoint(r),s=n.viewer.element;if(a?(n.currentDataPoint=a,n.drawArea=a.getHitArea(r,o,!0)):(n.currentDataPoint=null,n.drawArea=null),n.drawArea){var l=e.DataPoint.HitAreas.getCursor(n.drawArea,a.style);n.cursor!=l&&(n.cursor=l,$(s).css({cursor:l}))}else n.cursor&&(n.cursor=void 0,$(s).css({cursor:t}));i.preventDefaultAction=!0}}(i,r)}}]})},e.DataPoint.Transform.prototype.addDataPoint=function(e){return!this.dataPoints.includes(e)&&(this.dataPoints.push(e),!0)},e.DataPoint.Transform.prototype.removeDataPoint=function(e){if(this.dataPoints.includes(e)){var t=this.dataPoints.indexOf(e);return this.dataPoints.splice(t,1),!0}return!1},e.DataPoint.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},e.DataPoint.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.DataPoint.Transform.prototype.isActive=function(){return this.active},e.DataPoint.Transform.prototype.isTransforming=function(){return this.transforming},e.DataPoint.Transform.prototype.getContainingDataPoint=function(e){for(var t in this.dataPoints){var i=this.dataPoints[t];if(i.contains(e,o,!0))return i}return null},e}(ImageView=function(e){"use strict";if(!e)throw"Image view must exist";function t(e){var t=e.userData;if(!t.hidden){var o=t.viewer.drawer.context,i=ImageView.CoordinateConversion.convertPointFromImageToCanvas(t.point,t.viewer);t.style.lineX&&(o.beginPath(),o.lineWidth=t.style.lineX.lineWidth,o.strokeStyle=t.style.lineX.lineColor,o.moveTo(0,i.y),o.lineTo(o.canvas.width,i.y),o.stroke()),t.style.lineY&&(o.beginPath(),o.lineWidth=t.style.lineY.lineWidth,o.strokeStyle=t.style.lineY.lineColor,o.moveTo(i.x,0),o.lineTo(i.x,o.canvas.height),o.stroke()),t.style.point&&(o.beginPath(),o.fillStyle=t.style.point.pointColor,o.lineWidth=0,o.arc(i.x,i.y,t.style.point.pointRadius,0,2*Math.PI),o.fill())}}return e.DataPoint=function(e,t,o){this.viewer=t,this.point=new OpenSeadragon.Point(e.x,e.y),this.style=o,this.hidden=!1},e.DataPoint.getStyle=function(e,t,o){return{point:e,lineX:t,lineY:o}},e.DataPoint.getPointStyle=function(e,t){return{pointRadius:e,pointColor:t}},e.DataPoint.getLineStyle=function(e,t){return{lineWidth:e,lineColor:t}},e.DataPoint.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},e.DataPoint.prototype.setPosition=function(e,t){void 0!==e&&(this.point.x=e),void 0!==t&&(this.point.y=t)},e.DataPoint.prototype.getPosition=function(){return this.point.clone()},e.DataPoint.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},e.DataPoint.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},e.DataPoint.prototype.contains=function(t,o,i){var n=i?e.CoordinateConversion.convertPointFromImageToCanvas(this.point,this.viewer):this.point,r=Math.abs(t.x-n.x),a=Math.abs(t.y-n.y);return!!(this.style.point&&r<=this.style.point.pointRadius+o&&a<=this.style.point.pointRadius+o)||(!!(r<=o&&this.style.lineY)||!!(a<=o&&this.style.lineX))},e.DataPoint.prototype.getHitArea=function(t,o,i){var n=i?e.CoordinateConversion.convertPointFromImageToCanvas(this.point,this.viewer):this.point,r=Math.abs(t.x-n.x),a=Math.abs(t.y-n.y);return this.style.point&&r<=this.style.point.pointRadius+o&&a<=this.style.point.pointRadius+o?e.DataPoint.HitAreas.POINT:this.style.lineY&&r<=o?e.DataPoint.HitAreas.LINE_Y:this.style.lineX&&a<=o?e.DataPoint.HitAreas.LINE_X:void 0},e.DataPoint.prototype.hide=function(e){this.hidden=!0,e&&this.viewer.forceRedraw()},e.DataPoint.prototype.show=function(e){this.hidden=!1,e&&this.viewer.forceRedraw()},e.DataPoint.convertStringToPoint=function(e){var t=e.split(",");if(t&&2==t.length)return{x:parseFloat(t[0]),y:parseFloat(t[1])};throw"Cannot convert string '"+e+"' to Point"},e.DataPoint.convertPointsToString=function(e,t){return t||(t=0),e.x.toFixed(t)+","+e.y.toFixed(t)},e.DataPoint.HitAreas={POINT:"point",LINE_Y:"lineY",LINE_X:"lineX",isCorner:function(e){return e===this.POINT},isEdge:function(e){return e===this.LINE_Y||e===this.LINE_X},getCursor:function(e,t){return e===this.POINT&&t.point?"move":e===this.LINE_X&&t.lineX?"ns-resize":e===this.LINE_Y&&t.lineY?"ew-resize":void 0}},e}(ImageView=function(e){"use strict";e.CoordinateConversion={};var t=e.CoordinateConversion;function o(e){return e instanceof OpenSeadragon.Point||e instanceof OpenSeadragon.Rect?e:void 0!==e.width?new OpenSeadragon.Rect(e.x,e.y,e.width,e.height):new OpenSeadragon.Point(e.x,e.y)}return e.CoordinateConversion.scaleToOpenSeadragon=function(e,t,i){e=o(e);var n=t.world.getItemAt(0).source.dimensions,r=i.x/n.x;return e=(e=e.times(1/n.x)).times(1/r)},e.CoordinateConversion.scaleToImage=function(e,t,i){e=o(e);var n=t.world.getItemAt(0).source.dimensions,r=i.x/n.x;return e=(e=e.times(n.x)).times(r)},e.CoordinateConversion.scaleToRotatedImage=function(e,o,i){var n=o.world.getItemAt(0).source.dimensions,r=new OpenSeadragon.Rect(0,0,n.x,n.y),a=new OpenSeadragon.Rect(0,0,i.x,i.y),s=o.viewport.getRotation(),l=t.getRotatedBounds(r,s),c=t.getRotatedBounds(a,s).width/l.width;return e=(e=e.times(n.x)).times(c)},e.CoordinateConversion.scaleToOpenSeadragonCoordinates=function(e,o,i){var n=o.world.getItemAt(0).source.dimensions,r=new OpenSeadragon.Rect(0,0,n.x,n.y),a=new OpenSeadragon.Rect(0,0,i.x,i.y),s=o.viewport.getRotation(),l=t.getRotatedBounds(r,s),c=t.getRotatedBounds(a,s).width/l.width;return e=(e=e.times(1/n.x)).times(1/c)},e.CoordinateConversion.convertRectFromOpenSeadragonToImage=function(e,o,i){var n=ImageView.CoordinateConversion.convertRectFromImageToRotatedImage(e,o);return t.scaleToRotatedImage(n,o,i)},e.CoordinateConversion.convertRectFromImageToOpenSeadragon=function(e,o,i){var n=t.scaleToOpenSeadragonCoordinates(e,o);return t.convertRectFromRotatedImageToImage(n,o,i)},e.CoordinateConversion.convertCoordinatesFromImageToCanvas=function(e,o){var i=o.drawer.context.canvas.width/o.viewport.getBoundsNoRotate(!0).width;i/=window.devicePixelRatio;var n=t.convertPointFromImageToCanvas(e.getTopLeft(),o),r=t.convertPointFromImageToCanvas(e.getBottomRight(),o),a=n.x+.5*(r.x-n.x),s=n.y+.5*(r.y-n.y);return new OpenSeadragon.Rect(a-.5*e.width*i,s-.5*e.height*i,e.width*i,e.height*i)},e.CoordinateConversion.convertCoordinatesFromCanvasToImage=function(e,o){var i=o.drawer.context.canvas.width/o.viewport.getBoundsNoRotate(!0).width;i/=window.devicePixelRatio;var n=t.convertPointFromCanvasToImage(e.getTopLeft(),o),r=t.convertPointFromCanvasToImage(e.getBottomRight(),o),a=n.x+.5*(r.x-n.x),s=n.y+.5*(r.y-n.y);return new OpenSeadragon.Rect(a-.5*e.width/i,s-.5*e.height/i,e.width/i,e.height/i)},e.CoordinateConversion.convertPointFromImageToCanvas=function(e,o){var i=o.drawer.context.canvas.width/o.viewport.getBoundsNoRotate(!0).width;i/=window.devicePixelRatio;var n=o.source.width/o.source.height,r=o.viewport.getRotation(),a=new OpenSeadragon.Point(.5,.5/n).times(-1),s=o.viewport.getCenter(!0),l=new OpenSeadragon.Point(o.viewport.getBoundsNoRotate(!0).width/2,o.viewport.getBoundsNoRotate(!0).height/2),c=a.plus(s),g=t.rotate(c,r,!0),h=l.minus(g),u=a.plus(e),v=t.rotate(u,r,!0);return h.plus(v).times(i)},e.CoordinateConversion.convertPointFromCanvasToImage=function(e,o){var i=o.drawer.context.canvas.width/o.viewport.getBoundsNoRotate(!0).width;i/=window.devicePixelRatio;var n=o.source.width/o.source.height,r=o.viewport.getRotation(),a=new OpenSeadragon.Point(.5,.5/n).times(-1),s=o.viewport.getCenter(!0),l=new OpenSeadragon.Point(o.viewport.getBoundsNoRotate(!0).width/2,o.viewport.getBoundsNoRotate(!0).height/2),c=a.plus(s),g=t.rotate(c,r,!0),h=l.minus(g),u=e.times(1/i).minus(h);return t.rotate(u,r,!1).minus(a)},e.CoordinateConversion.convertRectFromImageToRotatedImage=function(e,o){var i=o.viewport.getRotation(),n=new OpenSeadragon.Rect(0,0,o.source.width,o.source.height),r=t.getRotatedBounds(n,i),a=n.width/n.height,s=(r.width,r.height,new OpenSeadragon.Rect(0,0,1,1/a)),l=t.getRotatedBounds(s,i),c=e.getCenter(),g=s.getCenter().times(-1).plus(c),h=t.rotate(g,i,!0),u=new OpenSeadragon.Point(l.width/2,l.height/2).times(-1),v=h.minus(u);return new OpenSeadragon.Rect(v.x-e.width/2,v.y-e.height/2,e.width,e.height)},e.CoordinateConversion.convertRectFromRotatedImageToImage=function(e,o){var i=o.viewport.getRotation(),n=new OpenSeadragon.Rect(0,0,o.source.width,o.source.height),r=t.getRotatedBounds(n,i),a=n.width/n.height,s=(r.width,r.height,new OpenSeadragon.Rect(0,0,1,1/a)),l=t.getRotatedBounds(s,i),c=s.getCenter().times(-1),g=new OpenSeadragon.Point(l.width/2,l.height/2).times(-1),h=e.getCenter(),u=g.plus(h),v=t.rotate(u,i,!1).minus(c);return new OpenSeadragon.Rect(v.x-e.width/2,v.y-e.height/2,e.width,e.height)},e.CoordinateConversion.convertPointFromImageToRotatedImage=function(e,i){var n=i.viewport.getRotation(),r=new OpenSeadragon.Rect(0,0,i.source.width,i.source.height),a=t.getRotatedBounds(r,n),s=r.width/r.height,l=(a.width,a.height,new OpenSeadragon.Rect(0,0,1,1/s)),c=t.getRotatedBounds(l,n),g=l.getCenter().times(-1),h=new OpenSeadragon.Point(c.width/2,c.height/2).times(-1),u=o(e),v=g.plus(u);return t.rotate(v,n).minus(h)},e.CoordinateConversion.convertPointFromRotatedImageToImage=function(e,i){var n=i.viewport.getRotation(),r=new OpenSeadragon.Rect(0,0,i.source.width,i.source.height),a=t.getRotatedBounds(r,n),s=r.width/r.height,l=(a.width,a.height,new OpenSeadragon.Rect(0,0,1,1/s)),c=t.getRotatedBounds(l,n),g=l.getCenter().times(-1),h=new OpenSeadragon.Point(c.width/2,c.height/2).times(-1),u=o(e).plus(h);return t.rotate(u,-n).minus(g)},e.CoordinateConversion.rotate=function(e,t,o){var i,n,r=t*Math.PI/180;return o?(i=e.x*Math.cos(r)-e.y*Math.sin(r),n=e.x*Math.sin(r)+e.y*Math.cos(r)):(i=e.x*Math.cos(r)+e.y*Math.sin(r),n=-e.x*Math.sin(r)+e.y*Math.cos(r)),new OpenSeadragon.Point(i,n)},e.CoordinateConversion.getRotatedBounds=function(e,t){var o=void 0===e.width?e.x:e.width,i=void 0===e.height?e.y:e.height,n=t*Math.PI/180,r=Math.abs(Math.sin(n)),a=Math.abs(Math.cos(n)),s=o*r+i*a,l=o*a+i*r,c=Math.abs(l),g=Math.abs(s),h=c-o,u=g-i;return new OpenSeadragon.Rect(-h/2,-u/2,c,g)},e.CoordinateConversion.getAsDimension=function(e){return{x:void 0===e.width?e.x:e.width,y:void 0===e.height?e.y:e.height}},e}(ImageView=function(e){"use strict";function t(e){return"number"==typeof e&&!Number.isNaN(e)}return e.Controls.Persistence=function(e,o){if("undefined"!=typeof Storage){var i=null,n=e.global.persistenceId;if(e.global.persistZoom||e.global.persistRotation){try{i=JSON.parse(localStorage.imageLocation)}catch(e){0}i&&function(e){return t(e.x)&&t(e.y)&&t(e.zoom)&&t(e.rotation)}(i)&&i.persistenceId===n&&(e.image.location={},e.global.persistZoom&&(e.image.location.zoom=i.zoom,e.image.location.x=i.x,e.image.location.y=i.y),e.global.persistRotation?e.image.location.rotation=i.rotation:e.image.location.rotation=0),window.onbeforeunload=function(){var t=o.controls.getLocation();t.persistenceId=e.global.persistenceId,localStorage.imageLocation=JSON.stringify(t)}}}},e}(ImageView=function(e){"use strict";return e.Controls=function(t,o){this.config=t,this.image=o;var i=this;e.Controls.Persistence&&(this.persistence=new e.Controls.Persistence(t,o)),this.config.global.controls&&($(this.config.global.controls.rotateLeft).on("click",function(){i.rotateLeft()}),$(this.config.global.controls.rotateRight).on("click",function(){i.rotateRight()}),$(this.config.global.controls.reset).on("click",function(){i.reset(!0)})),o.observables&&(o.observables.redrawRequired.sample(o.observables.viewportUpdate).subscribe(function(e){i.setLocation(e),i.setPanning(!1)}),o.config.global.panHomeOnZoomOut&&o.observables.viewerZoom.subscribe(function(e){i.isPanning()||o.viewer.viewport.getZoom()<=o.viewer.viewport.minZoomLevel&&(i.setPanning(!0),i.goHome(!0),i.setPanning(!1))})),$("#fullscreenTemplate").length>0&&($("#fullscreenTemplate").on("mousemove",function(){i.fullscreenControlsFadeout()}),$("#fullscreenMap").on("touchmove",function(){i.fullscreenControlsFadeout()}).on("touchend",function(){i.fullscreenControlsFadeout()}))},e.Controls.prototype.getLocation=function(){return{x:this.getCenter().x,y:this.getCenter().y,zoom:this.getZoom()/this.getCurrentRotationZooming(),rotation:this.getRotation()}},e.Controls.prototype.getCenter=function(){return this.image.viewer.viewport.getCenter(!0)},e.Controls.prototype.setCenter=function(e){this.image.viewer.viewport.panTo(e,!0)},e.Controls.prototype.getZoom=function(){return this.image.viewer.viewport.getZoom(!0)},e.Controls.prototype.zoomTo=function(e){var t=parseFloat(e)/this.image.viewer.viewport.getZoom();this.image.viewer.viewport.zoomBy(t,this.image.viewer.viewport.getCenter(!1),!0)},e.Controls.prototypesetFullScreen=function(e){this.image.viewer.setFullScreen(e)},e.Controls.prototype.goHome=function(e){this.image.viewer.viewport.goHome(e),this.zoomedOut=!0},e.Controls.prototype.reset=function(e){this.goHome(!0),this.image.viewer.viewport.zoomTo(this.image.viewer.viewport.getHomeZoom(),null,!0),e&&this.rotateTo(0)},e.Controls.prototype.zoomIn=function(){this.image.viewer.viewport.zoomBy(this.config.global.zoomSpeed,this.image.viewer.viewport.getCenter(!1),!1)},e.Controls.prototype.zoomOut=function(){this.image.viewer.viewport.zoomBy(1/this.config.global.zoomSpeed,this.image.viewer.viewport.getCenter(!1),!1)},e.Controls.prototype.rotateRight=function(){var e=this.image.viewer.viewport.getRotation()+90;this.rotateTo(e)},e.Controls.prototype.rotateLeft=function(){var e=this.image.viewer.viewport.getRotation()-90;this.rotateTo(e)},e.Controls.prototype.getRotation=function(){return this.image.viewer.viewport.getRotation()},e.Controls.prototype.setRotation=function(e){return this.rotateTo(e)},e.Controls.prototype.rotateTo=function(e){e<0&&(e+=360),e%=360,this.panning=!0,this.currentZoom=null,this.image.viewer.viewport.setRotation(e),this.panning=!1},e.Controls.prototype.getCurrentRotationZooming=function(){var e=this.image.getSizes();return e&&e.rotated()?1/e.ratio(e.originalImageSize):1},e.Controls.prototype.setPanning=function(e){this.panning=e},e.Controls.prototype.isPanning=function(){return this.panning},e.Controls.prototype.fullscreenControlsFadeout=function(){this.fadeout&&(clearTimeout(this.fadeout),this.showFullscreenControls()),this.fadeout=setTimeout(this.hideFullscreenControls,3e3)},e.Controls.prototype.hideFullscreenControls=function(){$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").stop().fadeOut("slow")},e.Controls.prototype.showFullscreenControls=function(){$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").show()},e.Controls.prototype.setLocation=function(e){this.image.viewer.viewport.minZoomLevel=this.image.viewer.viewport.getHomeZoom()*this.config.global.minZoomLevel;var t=e.targetLocation.zoom,o=new OpenSeadragon.Point(e.targetLocation.x,e.targetLocation.y);(t*this.image.viewer.viewport.getHomeZoom()-this.image.viewer.viewport.minZoomLevel<.001||!t)&&this.image.config.global.fitToContainer?this.goHome(!0):(this.image.config.global.fitToContainer&&this.image.viewer.viewport.zoomTo(t*this.getCurrentRotationZooming(),null,!0),this.setCenter(o)),"open"===e.osState&&0!==e.targetLocation.rotation&&this.rotateTo(e.targetLocation.rotation)},e}(ImageView=function(e){"use strict";if(!e)throw"Image view must exist";function t(e){var t=e.userData;if(!t.hidden){var o=t.viewer.drawer.context,i=ImageView.CoordinateConversion.convertCoordinatesFromImageToCanvas(t.rect,t.viewer).times(window.devicePixelRatio);o.beginPath(),o.lineWidth=t.style.borderWidth,o.strokeStyle=t.style.borderColor,o.rect(i.x,i.y,i.width,i.height),o.stroke()}}function o(e,t,o){return t.x>e.getTopLeft().x-o&&t.x<e.getBottomRight().x+o&&t.y>e.getTopLeft().y-o&&t.y<e.getBottomRight().y+o}function i(e){return e*e}function n(e,t){return i(e.x-t.x)+i(e.y-t.y)}function r(e,t){return Math.sqrt(n(e,t))}function a(e,t,o){return Math.sqrt(function(e,t,o){var i=n(t,o);if(0==i)return n(e,t);var r=((e.x-t.x)*(o.x-t.x)+(e.y-t.y)*(o.y-t.y))/i;return n(e,r<0?t:r>1?o:{x:t.x+r*(o.x-t.x),y:t.y+r*(o.y-t.y)})}(e,t,o))}return e.Overlay=function(e,t,o){this.viewer=t,this.rect=e,this.style=o,this.fixed=null,this.allowMove=!1},e.Overlay.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},e.Overlay.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},e.Overlay.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},e.Overlay.prototype.contains=function(t,i,n){return o(n?e.CoordinateConversion.convertCoordinatesFromImageToCanvas(this.rect,this.viewer):this.rect,t,i)},e.Overlay.prototype.getHitArea=function(t,i,n){var s=n?e.CoordinateConversion.convertCoordinatesFromImageToCanvas(this.rect,this.viewer):this.rect;if(o(s,t,i)){var l=function(t,o,i){var n=r(o,t.getTopLeft()),a=r(o,t.getBottomLeft()),s=r(o,t.getTopRight()),l=r(o,t.getBottomRight()),c=Math.min(n,Math.min(s,Math.min(a,l)));if(c<=i){if(n===c)return e.Overlay.HitAreas.TOPLEFT;if(s===c)return e.Overlay.HitAreas.TOPRIGHT;if(a===c)return e.Overlay.HitAreas.BOTTOMLEFT;if(l===c)return e.Overlay.HitAreas.BOTTOMRIGHT}return""}(s,t,i);if(l||(l=function(t,o,i){var n=a(o,t.getTopLeft(),t.getBottomLeft()),r=a(o,t.getBottomLeft(),t.getBottomRight()),s=a(o,t.getTopRight(),t.getBottomRight()),l=a(o,t.getTopLeft(),t.getTopRight()),c=Math.min(n,Math.min(s,Math.min(l,r)));if(c<=i){if(n===c)return e.Overlay.HitAreas.LEFT;if(s===c)return e.Overlay.HitAreas.RIGHT;if(l===c)return e.Overlay.HitAreas.TOP;if(r===c)return e.Overlay.HitAreas.BOTTOM}return""}(s,t,i)),this.allowMove&&!l&&o(s,t,0)&&(l=e.Overlay.HitAreas.CENTER),function(t,o){if(t&&o)switch(t){case e.Overlay.HitAreas.TOP:return o.y||o.height;case e.Overlay.HitAreas.BOTTOM:return o.height;case e.Overlay.HitAreas.LEFT:return o.x||o.width;case e.Overlay.HitAreas.RIGHT:return o.width;case e.Overlay.HitAreas.TOPLEFT:return o.x||o.y||o.width||o.height;case e.Overlay.HitAreas.TOPRIGHT:return o.y||o.width||o.height;case e.Overlay.HitAreas.BOTTOMLEFT:return o.height||o.x||o.width;case e.Overlay.HitAreas.BOTTOMRIGHT:return o.width||o.height;case e.Overlay.HitAreas.CENTER:return o.y||o.x;case e.Overlay.HitAreas.FIXED:return!0}return!1}(l,this.fixed))return e.Overlay.HitAreas.FIXED}return l},e.Overlay.prototype.hide=function(e){this.hidden=!0,e&&this.viewer.forceRedraw()},e.Overlay.prototype.show=function(e){this.hidden=!1,e&&this.viewer.forceRedraw()},e.Overlay.convertStringToRect=function(e){var t=e.split(",");if(t&&4==t.length)return new OpenSeadragon.Rect(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));throw"Cannot convert string '"+e+"' to Rectangle"},e.Overlay.convertRectToString=function(e,t){return t||(t=0),e.x.toFixed(t)+","+e.y.toFixed(t)+","+e.width.toFixed(t)+","+e.height.toFixed(t)},e.Overlay.drawPoint=function(e,t,o,i){!function(e){var t=e.userData[0].times(window.devicePixelRatio),o=e.userData[1],i=e.userData[2],n=e.userData[3],r=o.drawer.context;r.beginPath(),i&&(r.fillStyle=i);r.arc(t.x,t.y,n,0,2*Math.PI,!0),r.fill()}({userData:[e,t,o,i]})},e.Overlay.HitAreas={TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",FIXED:"f",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(e){return e===this.TOPLEFT||e===this.BOTTOMRIGHT?"nwse-resize":e===this.TOPRIGHT||e===this.BOTTOMLEFT?"nesw-resize":e===this.TOP||e===this.BOTTOM?"ns-resize":e===this.RIGHT||e===this.LEFT?"ew-resize":e===this.CENTER?"move":e===this.FIXED?"not-allowed":void 0}},e}(ImageView)))))))))))))))));