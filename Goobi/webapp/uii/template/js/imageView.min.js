/*!
 * This file is part of the Goobi viewer - a content presentation and management application for digitized objects.
 *
 * Visit these websites for more information.
 * - http://www.intranda.com
 * - http://digiverso.com
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var _MIN_DESKEW_ANGLE=-44.9,_MAX_DESKEW_ANGLE=45,DEFAULT_CURSOR="default",ImageView=function(){"use strict";var e=!1,t={global:{divId:"map",zoomSlider:".zoom-slider",zoomSliderHandle:".zoom-slider-handle",overlayGroups:[],zoomSpeed:1.25,maxZoomLevel:2,minZoomLevel:1,allowPanning:!0,enableMouseNavigation:!0,imageControlsActive:!0,visibilityRatio:.2,loadImageTimeout:6e5,maxParallelImageLoads:2,adaptContainerHeight:!1,fitToContainer:!0,footerHeight:0,topMargin:0,rememberZoom:!1,rememberRotation:!1,panHomeOnZoomOut:!0,showControls:!1,useTiles:!0},image:{initialRotation:0,mimeType:"image/jpeg"}},i={};function o(e){var t=e.userData;if(t.config.global.footerHeight>0){var i=t.config.global.footerHeight,o=new OpenSeadragon.Point(0,t.container.height()-i),n=new OpenSeadragon.Point(t.container.width(),i);t.canvasScale||(t.canvasScale=t.viewer.drawer.context.canvas.width/t.viewer.drawer.context.canvas.clientWidth),1!=t.canvasScale&&(o=o.times(t.canvasScale),n=n.times(t.canvasScale)),t.viewer.drawer.context.drawImage(t.footerImage,o.x,o.y,n.x,n.y)}}function n(t,i){var o=Q.defer();return ImageView.TileSourceResolver.resolveAsJson(t).then(function(t){return e&&console.log("IIIF image info ",t),function(e,t){if(t){if("string"==typeof t){t.replace(/[\{\}]/,"");var t=JSON.parse(t)}var i=[];t.forEach(function(e){e.width||e.height?i.push(e):i.push({width:parseInt(e),height:parseInt(e)})}),i.length>0&&(e.sizes=i)}}(t,i.global.imageSizes),function(e,t){if(t){if("string"==typeof t){var i=t.replace(/(\d+)/,'"$1"').replace("=",":");t=JSON.parse(i)}var o=[];Array.isArray(t)?o=t:Object.keys(t).forEach(function(e){var i=t[e];o.push({width:parseInt(e),height:parseInt(e),scaleFactors:i})}),o.length>0&&(e.tiles=o)}}(t,i.global.tileSizes),e&&console.log("adapted IIIF image info ",t),i.global.useTiles&&t.tiles&&t.tiles.length>0?new OpenSeadragon.IIIFTileSource(t):function(t,i){e&&console.log("Creating legacy tilesource from imageInfo ",t);var o=i.image.mimeType;o=(o=o.replace("image/","")).replace("jpeg","jpg").replace("tiff","tif");var n,r=[];Array.isArray(t)?(t.forEach(function(e){e.mimetype=i.image.mimeType}),n=new OpenSeadragon.LegacyTileSource(t)):t.sizes?(t.sizes.forEach(function(n){e&&(console.log("Image level width = ",n.width),console.log("Image level height = ",n.height));var a={mimetype:i.image.mimeType,url:t["@id"].replace("/info.json","")+"/full/"+n.width+",/0/default."+o,width:t.width,height:t.height};e&&console.log("Created level ",a),r.push(a)}),n=new OpenSeadragon.LegacyTileSource(r)):n=new OpenSeadragon.ImageTileSource({url:t["@id"].replace("/info.json","")+"/full/full/0/default."+o,crossOriginPolicy:"Anonymous",buildPyramid:!1});return n}(t,i)},function(t){if(ImageView.TileSourceResolver.isURI(i.image.tileSource)){e&&console.log("Image URL",i.image.tileSource);var o=new OpenSeadragon.ImageTileSource({url:i.image.tileSource,buildPyramid:!0,crossOriginPolicy:!1});return o}var n="Failed to load tilesource from "+o;return e&&console.log(n),Q.reject(n)}).then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise}function r(e){return(e%360+360)%360}function a(e){return e+=_MAX_DESKEW_ANGLE,e/=90,e=parseInt(e),r(e*=90)}function s(e){return e+=_MAX_DESKEW_ANGLE,e=parseFloat(e%90),e=(e=r(e-=_MAX_DESKEW_ANGLE))>_MAX_DESKEW_ANGLE?e-360:e}return i.Image=function(i){this.config=jQuery.extend(!0,{},t),jQuery.extend(!0,this.config,i),this.container=$("#"+this.config.global.divId),e&&console.log("initializing image view with config ",this.config)},i.Image.prototype.load=function(){e&&(console.log("##############################"),console.log("osViewer.init"),console.log("##############################")),this.config.image.mimeType=this.config.image.mimeType.replace("jpeg","jpg");var t=this.config.image.tileSource;"string"==typeof t&&t.startsWith("[")?(e&&console.log("Sources = ",t),t=JSON.parse(t)):$.isArray(t)||(t=[t]);for(var i=[],o=0;o<t.length;o++){var r=n(t[o],this.config);i.push(r)}var a=this;return Q.all(i).then(function(t){for(var i=Number.MAX_VALUE,o=Number.MAX_VALUE,n=Number.MAX_VALUE,r=0;r<t.length;r++){var s=t[r];i=Math.min(i,s.width),o=Math.min(o,s.height),n=Math.min(n,s.aspectRatio),a.config.image.originalImageWidth||(a.config.image.originalImageWidth=s.width),a.config.image.originalImageHeight||(a.config.image.originalImageHeight=s.height)}e&&(console.log("original image size: ",a.config.image.originalImageWidth,a.config.image.originalImageHeight),console.log("Min aspect ratio = "+n));for(var l=0,h=0;h<t.length;h++){s=t[h];t[h]={tileSource:s,width:s.aspectRatio/n,x:l,y:0},l+=t[h].width}return a.loadImage(t)})},i.Image.prototype.loadImage=function(o){e&&console.log("Loading image with tilesource: ",o);var n=$("#"+this.config.global.divId),l=this.config.global.maxZoomLevel;this.config.image.originalImageWidth&&n.width()>0&&(l=this.config.global.maxZoomLevel*this.config.image.originalImageWidth/n.width()),this.loadFooter();var h={tileSources:o,id:this.config.global.divId,prefixUrl:this.config.resourcePath+"/javascript/openseadragon/images/",immediateRender:!1,visibilityRatio:this.config.global.visibilityRatio,sequenceMode:!1,degrees:this.config.image.initialRotation?this.config.image.initialRotation:0,zoomPerClick:1,showRotationControl:!0,showNavigationControl:this.config.global.showControls,minZoomLevel:this.config.global.minZoomLevel,maxZoomLevel:l,zoomPerScroll:this.config.global.zoomSpeed,panHorizontal:this.config.global.allowPanning,panVertical:this.config.global.allowPanning,mouseNavEnabled:this.config.global.enableMouseNavigation,homeButton:this.config.global.zoomHome,rotateLeftButton:this.config.global.rotateLeft,rotateRightButton:this.config.global.rotateRight,timeout:this.config.global.loadImageTimeout,blendTime:.5,alwaysBlend:!1,imageLoaderLimit:this.config.global.maxParallelImageLoads,loadTilesWithAjax:!0,ajaxHeaders:{token:this.config.global.webApiToken},viewportMargins:{top:this.config.global.topMargin,left:0,right:0,bottom:this.config.global.footerHeight}};e&&console.log("osconfig ",h),this.viewer=new OpenSeadragon(h);var c=Q.defer();this.observables=function(e,i){var o={};return o.viewerOpen=Rx.Observable.create(function(e){i.viewer.addOnceHandler("open",function(i){return i.osState="open",Number.isNaN(i.eventSource.viewport.getHomeBounds().x)?e.onError("Unknow error loading image from ",t.image.tileSource):e.onNext(i)}),i.viewer.addOnceHandler("open-failed",function(t){return t.osState="open-failed",console.error("Failed to open openseadragon "),e.onError(t)})}),o.firstTileLoaded=Rx.Observable.create(function(e){i.viewer.addOnceHandler("tile-loaded",function(t){return t.osState="tile-loaded",e.onNext(t)}),i.viewer.addOnceHandler("tile-load-failed",function(t){return t.osState="tile-load-failed",console.error("Failed to load tile"),e.onError(t)})}),o.viewerZoom=Rx.Observable.create(function(e){i.viewer.addHandler("zoom",function(t){return e.onNext(t)})}),o.animationComplete=Rx.Observable.create(function(e){i.viewer.addHandler("animation-finish",function(t){return e.onNext(t)})}),o.viewportUpdate=Rx.Observable.create(function(e){i.viewer.addHandler("update-viewport",function(t){return e.onNext(t)})}),o.animation=Rx.Observable.create(function(e){i.viewer.addHandler("animation",function(t){return e.onNext(t)})}),o.viewerRotate=Rx.Observable.create(function(e){i.viewer.addHandler("rotate",function(t){return t.osState="rotate",e.onNext(t)})}),o.canvasResize=Rx.Observable.create(function(e){i.viewer.addHandler("resize",function(t){return t.osState="resize",e.onNext(t)})}),o.windowResize=Rx.Observable.fromEvent(e,"resize").map(function(e){return e.osState="window resize",e}),o.overlayRemove=Rx.Observable.create(function(e){i.viewer.addHandler("remove-overlay",function(t){return e.onNext(t)})}),o.overlayUpdate=Rx.Observable.create(function(e){i.viewer.addHandler("update-overlay",function(t){return e.onNext(t)})}),o.levelUpdate=Rx.Observable.create(function(e){i.viewer.addHandler("update-level",function(t){return e.onNext(t)})}),o.redrawRequired=o.viewerOpen.merge(o.viewerRotate.merge(o.canvasResize).debounce(10)).map(function(e){var t={};return i.controls&&(t=i.controls.getLocation()),"open"===e.osState&&(t.zoom=i.viewer.viewport.getHomeZoom(),i.config.image.location&&(t=i.config.image.location)),e.targetLocation=t,e}).publish(),o}(window,this),(this.config.global.rotationSlider||this.config.global.rotationInput)&&function(e){var t=e.config.image.initialRotation,i=s(t);e.rotation=a(t);var o=e.config.global,n=e.viewer;o.rotationSlider&&($("#"+o.rotationSlider).slider({orientation:"vertical",min:_MIN_DESKEW_ANGLE,max:_MAX_DESKEW_ANGLE,step:.1,slide:function(t,i){var o=-i.value,r=s(o);n.viewport.setRotation(r+e.rotation)}}),$("#"+o.rotationSlider).slider("option","value",-i));o.rotationInput&&$("#"+o.rotationInput).on("blur",function(t){e.rotate(t.target.value)});n.addHandler("rotate",function(t){var i=r(t.degrees),l=s(i);if(e.rotation=a(n.viewport.getRotation()),o.rotationInput){var h=e.rotation+l;$("#"+o.rotationInput).val(h.toFixed(1)).change()}})}(this);var g=this;return this.observables.viewerOpen.subscribe(function(e,t){c.resolve(g)},function(e){c.reject(e)}),this.observables.redrawRequired.subscribe(function(t){e&&console.log("viewer "+t.osState+"ed with target location ",t.targetLocation),g.redraw()}),i.Controls&&(this.controls=new i.Controls(this.config,this)),i.ZoomSlider&&(this.zoomSlider=new i.ZoomSlider(this.config,this),this.onFirstTileLoaded().then(function(){g.zoomSlider&&g.zoomSlider.init()})),i.Overlays&&(this.overlays=new i.Overlays(this.config,this)),i.DrawRect&&(this.drawRect=new i.DrawRect(this.config,this)),i.TransformRect&&(this.transformRect=new i.TransformRect(this.config,this)),this.observables.redrawRequired.connect(),c.promise},i.Image.prototype.getObservables=function(){return this.observables},i.Image.prototype.hasFooter=function(){return null!=this.footerImage},i.Image.prototype.getConfig=function(){return this.config},i.Image.prototype.loadFooter=function(){if(this.config.image.baseFooterUrl&&this.config.global.footerHeight>0){this.footerImage=new Image,this.footerImage.src=this.config.image.baseFooterUrl.replace("{width}",Math.round(this.container.width())).replace("{height}",Math.round(this.config.global.footerHeight)),this.footerImage.src=this.config.image.baseFooterUrl.replace("/full/max/","/full/!"+Math.round(this.container.width())+","+Math.round(this.config.global.footerHeight)+"/");var t=this;this.footerImage.onload=function(){e&&(console.log("loading footer image ",t.footerImage),console.log("Calculating image Footer size")),function(e){e&&e.viewer&&(o({userData:e}),e.viewer.removeHandler("update-viewport",o),e.viewer.addHandler("update-viewport",o,e))}(t)}}},i.Image.prototype.getOverlayGroup=function(e){for(var t=this.config.global.overlayGroups,i=0;i<t.length;i++){var o=t[i];if(o.name===e)return o}},i.Image.prototype.getHighlightCoordinates=function(e){var t=this.config.image.highlightCoords;if(t)for(var i=0;i<t.length;i++){var o=t[i];if(o.name===e)return o}},i.Image.prototype.getSizes=function(){return this.sizes},i.Image.prototype.getImageInfo=function(){return this.viewer?this.viewer.tileSources:null},i.Image.prototype.close=function(){e&&console.log("Closing openSeadragon viewer"),this.viewer&&this.viewer.destroy()},i.Image.prototype.redraw=function(){this.controls&&this.controls.setPanning(!0),this.sizes=function(t){e&&(console.log("viewImage: calcualte sizes"),console.log("Home zoom = ",t.viewer.viewport.getHomeZoom()));var i=new ImageView.Measures(t);(t.config.global.adaptContainerHeight||t.config.global.adaptContainerWidth)&&i.resizeCanvas();if(null!=t.viewer){var o=t.viewer.viewport.getMargins();o.bottom=i.footerHeight+i.calculateExcessHeight(),t.viewer.viewport.setMargins(o)}e&&console.log("sizes: ",i);return i}(this)},i.Image.prototype.onFirstTileLoaded=function(){var e=Q.defer();return this.observables?this.observables.firstTileLoaded.subscribe(function(t){e.resolve(t)},function(t){e.reject(t)}):e.reject("No observables defined"),e.promise},i.Image.prototype.getOriginalImageSize=function(){return new OpenSeadragon.Point(this.config.image.originalImageWidth,this.config.image.originalImageHeight)},i.Image.prototype.rotate=function(e){var t=r(e),i=s(t);this.rotation=a(t),this.viewer.viewport.setRotation(t),this.config.rotationSlider&&$("#"+this.config.rotationSlider).slider("option","value",-i)},i.Image.prototype.scaleToOpenSeadragon=function(e){return i.CoordinateConversion.scaleToOpenSeadragon(e,this.viewer,this.getOriginalImageSize())},i.Image.prototype.scaleToImage=function(e){return i.CoordinateConversion.scaleToImage(e,this.viewer,this.getOriginalImageSize())},i}();String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.substring(0,e.length).localeCompare(e)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return 0===this.substring(this.length-e.length,this.length).localeCompare(e)}),Array.prototype.find||(Array.prototype.find=function(e){for(var t=0;t<this.length;t++){var i=this[t];if(e(i))return i}}),Number.isNaN||(Number.isNaN=function(e){return e!=e});ImageView=function(e){"use strict";var t=!1,i={},o={sliderDilation:12};return e.ZoomSlider=function(e,t){this.config=$.extend(!0,{},o),$.extend(!0,this.config,e.global),this.image=t},e.ZoomSlider.prototype.init=function(){t&&(console.log("##############################"),console.log("imageView.zoomSlider.init"),console.log("##############################")),this.addZoomSlider(this.config.zoomSlider),this.buttonToZoom(this.image.viewer.viewport.getHomeZoom());var e=this;this.image.observables.viewerZoom.subscribe(function(t){var i=e.image.viewer.viewport.getZoom();e.buttonToZoom(i)})},e.ZoomSlider.prototype.exists=function(){return this.$element.length&&this.$button.length},e.ZoomSlider.prototype.buttonToMouse=function(e){t&&console.log("imageView.zoomSlider.buttonToMouse: mousePos - "+e);var i=this.$button.width()/2,o=e-i;o<0&&(o=0),o+2*i>this.absoluteWidth&&(o=this.absoluteWidth-2*i),this.$button.css({left:o}),this.buttonPosition=o;var n=o/(this.absoluteWidth-2*i);n=1/this.config.sliderDilation*Math.tan(Math.atan(this.config.sliderDilation)*n);var r=this.image.viewer.viewport.getMinZoom()+(this.image.viewer.viewport.getMaxZoom()-this.image.viewer.viewport.getMinZoom())*n;t&&console.log("imageView.zoomSlider.buttonToMouse: newScale - "+r),this.zoomTo(r)},e.ZoomSlider.prototype.zoomTo=function(e){t&&console.log("imageView.controls.myZoomTo: zoomTo - "+e);var i=parseFloat(e)/this.image.viewer.viewport.getZoom();t&&console.log("imageView.controls.myZoomTo: zoomBy - "+i),this.image.viewer.viewport.zoomBy(i,this.image.viewer.viewport.getCenter(!1),!0),this.setLabel(e)},e.ZoomSlider.prototype.buttonToZoom=function(e){if(t&&(console.log("imageView.zoomSlider.buttonToZoom: scale - "+e),console.log("imageView.zoomSlider.buttonToZoom: _zoomSlider - ",i)),this.image.viewer.viewport){if(this.$button){var o=(e-this.image.viewer.viewport.getMinZoom())/(this.image.viewer.viewport.getMaxZoom()-this.image.viewer.viewport.getMinZoom()),n=(o=1/Math.atan(this.config.sliderDilation)*Math.atan(this.config.sliderDilation*o))*(this.absoluteWidth-this.$button.width());Math.abs(this.image.viewer.viewport.getMaxZoom()-e)<1e-10&&(n=this.absoluteWidth-this.$button.width()),n<0&&(n=0),this.$button.css({left:n}),this.buttonPosition=n}this.setLabel(e)}},e.ZoomSlider.prototype.setLabel=function(e){if(this.$label.length&&this.image.sizes){var t=this.image.config.image.originalImageWidth,i=this.image.container.width();e=parseFloat(e)/t*i,e*=window.devicePixelRatio,this.$label.val((100*e).toFixed(1))}},e.ZoomSlider.prototype.inputToZoom=function(e){var i=parseFloat(e);if(i&&this.image.sizes){t&&console.log("scale to ",e);var o=i*this.image.config.image.originalImageWidth/this.image.container.width()/100;(o/=window.devicePixelRatio)<this.image.viewer.viewport.getMinZoom()?o=this.image.viewer.viewport.getMinZoom():o>this.image.viewer.viewport.getMaxZoom()&&(o=this.image.viewer.viewport.getMaxZoom()),this.zoomTo(o)}},e.ZoomSlider.prototype.addZoomSlider=function(e){t&&console.log("imageView.zoomSlider.addZoomSlider: element - "+e),this.buttonPosition=0,this.$element=$(e),this.absoluteWidth=this.$element.innerWidth(),this.mousedown=!1;var i=this;this.$element.length&&(this.$button=this.$element.children(this.config.zoomSliderHandle),this.$element.on("mousedown",function(e){!function(e,i){t&&console.log("imageView.zoomSlider.zoomSliderMouseDown: evt - "+e);i.mousedown=!0;var o=i.$element.offset(),n=e.pageX-o.left;i.buttonToMouse(n)}(e,i)}),this.$element.on("mousemove",function(e){!function(e,i){t&&console.log("imageView.zoomSlider.zoomSliderMouseMove: evt - "+e);if(!i.mousedown)return;var o=i.$element.offset(),n=e.pageX-o.left;i.buttonToMouse(n),t&&console.log("imageView.zoomSlider.zoomSliderMouseMove: moving - "+n)}(e,i)}),this.$button.length&&this.$button.on("mousedown",function(e){!function(e,i){t&&console.log("imageView.zoomSlider.buttonMouseDown");i.mousedown=!0}(0,i)})),this.$label=$(this.config.zoomSliderLabel),this.$label.length&&(this.$label.on("change",function(e){return i.inputToZoom(e.target.value),!1}),this.$label.on("keypress",function(e){if(13==e.which)return i.inputToZoom(e.target.value),!1})),$(document).on("mouseup",function(e){!function(e,i){t&&console.log("imageView.zoomSlider.zoomSliderMouseUp");i.mousedown=!1}(0,i)})},e}(ImageView=function(e){"use strict";return e.TileSourceResolver={resolveAsJsonOrURI:function(e){var t=Q.defer();return this.isJson(e)?t.resolve(e):this.isStringifiedJson(e)?t.resolve(JSON.parse(e)):t.resolve(e),t.promise},resolveAsJson:function(e){var t=Q.defer();if(this.isURI(e)){if(this.isJsonURI(e))return this.loadJsonFromURL(e);t.reject("Url does not lead to a json object")}else if("string"==typeof e)try{var i=JSON.parse(e);t.resolve(i)}catch(e){t.reject("String does not contain valid json: "+e)}else"object"==typeof e?t.resolve(e):t.reject("Neither a url nor a json object");return t.promise},loadJsonFromURL:function(e){var t=Q.defer();return this.isJsonURI(e)?OpenSeadragon.makeAjaxRequest(e,function(e){try{t.resolve(JSON.parse(e.responseText))}catch(e){t.reject(e)}},function(e){t.reject(e)}):t.reject("Not a json uri: "+e),t.promise},loadIfJsonURL:function(t){return Q.promise(function(i,o){if(e.TileSourceResolver.isURI(t)){var n={url:decodeURI(t),type:"GET",dataType:"JSON",async:!0,crossDomain:!0,accepts:{application_json:"application/json",application_jsonLd:"application/ld+json",text_json:"text/json",text_jsonLd:"text/ld+json"}};Q($.ajax(n)).then(function(e){i(e)}).fail(function(e){o("Failed to retrieve json from "+t)}),setTimeout(function(){o("Timeout after 10s")},1e4)}else o("Not a uri: "+t)})},isJsonURI:function(e){if(this.isURI(e)){var t=e.replace(/\?.*/,"");return t.endsWith("/")&&(t=t.substring(0,t.length-1)),t.toLowerCase().endsWith(".json")}return!1},isURI:function(e){return!(!e||"string"!=typeof e||!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file:/")))},isStringifiedJson:function(e){if(e&&"string"==typeof e)try{var t=JSON.parse(e);return this.isJson(t)}catch(e){return!1}return!1},isJson:function(e){return e&&"object"==typeof e}},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";var t=4;return e.Transform=function(i,o,n){var r;this.viewer=i,this.style=o,this.startCondition=n,this.active=!0,this.transforming=!1,this.currentOverlay=null,this.drawArea=null,this.startPoint=null,this.overlays=[],this.finishedObservable=new Rx.Subject,this.cursor=void 0,(r=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,i){if(i.isTransforming()){var o=new OpenSeadragon.Point(t.position.x,t.position.y),n=e.CoordinateConversion.convertCoordinatesFromImageToCanvas(i.currentOverlay.rect,i.viewer),r=null,a=null;if(i.drawArea===e.Overlay.HitAreas.TOPLEFT)r=new OpenSeadragon.Point(Math.min(o.x,n.getBottomRight().x),Math.min(o.y,n.getBottomRight().y)),a=n.getBottomRight();else if(i.drawArea===e.Overlay.HitAreas.TOPRIGHT)r=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(o.y,n.getBottomRight().y)),a=new OpenSeadragon.Point(Math.max(o.x,n.getTopLeft().x),n.getBottomRight().y);else if(i.drawArea===e.Overlay.HitAreas.BOTTOMLEFT)r=new OpenSeadragon.Point(Math.min(o.x,n.getBottomRight().x),n.getTopLeft().y),a=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(o.y,n.getTopLeft().y));else if(i.drawArea===e.Overlay.HitAreas.BOTTOMRIGHT)r=n.getTopLeft(),a=new OpenSeadragon.Point(Math.max(o.x,n.getTopLeft().x),Math.max(o.y,n.getTopLeft().y));else if(i.drawArea===e.Overlay.HitAreas.LEFT)r=new OpenSeadragon.Point(Math.min(o.x,n.getBottomRight().x),n.getTopLeft().y),a=n.getBottomRight();else if(i.drawArea===e.Overlay.HitAreas.RIGHT)r=n.getTopLeft(),a=new OpenSeadragon.Point(Math.max(o.x,n.getTopLeft().x),n.getBottomRight().y);else if(i.drawArea===e.Overlay.HitAreas.TOP)r=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(o.y,n.getBottomRight().y)),a=n.getBottomRight();else if(i.drawArea===e.Overlay.HitAreas.BOTTOM)r=n.getTopLeft(),a=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(o.y,n.getTopLeft().y));else if(i.drawArea===e.Overlay.HitAreas.CENTER&&i.startPoint){var s=i.startPoint.x-o.x,l=i.startPoint.y-o.y;n.x-=s,n.y-=l,i.startPoint=o}r&&a&&(n=new OpenSeadragon.Rect(r.x,r.y,a.x-r.x,a.y-r.y)),i.currentOverlay.rect=e.CoordinateConversion.convertCoordinatesFromCanvasToImage(n,i.viewer),i.viewer.forceRedraw(),t.preventDefaultAction=!0}}(t,r)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentOverlay&&t.drawArea){var i=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=i,t.transforming=!0,e.preventDefaultAction=!0,!0}t.transforming=!1}}(e,r)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(t.transforming&&t.finishedObservable.onNext(t.currentOverlay),t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(i){!function(i,o){if(!o.isTransforming()&&o.isActive()&&o.startCondition(i.originalEvent)){var n=new OpenSeadragon.Point(i.position.x,i.position.y),r=o.getContainingOverlay(n),a=o.viewer.element;if(r?(o.currentOverlay=r,o.drawArea=r.getHitArea(n,t,!0)):(o.currentOverlay=null,o.drawArea=null),o.drawArea){var s=e.Overlay.HitAreas.getCursor(o.drawArea);o.cursor!=s&&(o.cursor=s,$(a).css({cursor:s}))}else o.cursor&&(o.cursor=void 0,$(a).css({cursor:DEFAULT_CURSOR}));i.preventDefaultAction=!0}}(i,r)}}]})},e.Transform.prototype.addOverlay=function(e){return!this.overlays.includes(e)&&(this.overlays.push(e),!0)},e.Transform.prototype.removeOverlay=function(e){if(this.overlays.includes(e)){var t=this.overlays.indexOf(e);return this.overlays.splice(t,1),!0}return!1},e.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},e.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Transform.prototype.isActive=function(){return this.active},e.Transform.prototype.isTransforming=function(){return this.transforming},e.Transform.prototype.getContainingOverlay=function(e){for(var i in this.overlays){var o=this.overlays[i];if(o.contains(e,t,!0))return o}return null},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";var t="default",i="not-allowed";return e.Remove=function(e,o){var n;this.viewer=e,this.startCondition=o,this.active=!0,this.currentOverlay=null,this.overlays=[],this.finishedObservable=new Rx.Subject,(n=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isActive()&&t.startCondition(e.originalEvent)&&t.currentOverlay&&(t.currentOverlay.remove(),t.finishedObservable.onNext(t.currentOverlay),t.currentOverlay=null)}(e,n)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(e){!function(e,o){if(o.isActive()&&o.startCondition(e.originalEvent)){var n=e.position,r=o.getContainingOverlay(n),a=o.viewer.element;o.currentOverlay=r||null,o.currentOverlay?$(a).css({cursor:i}):$(a).css({cursor:t}),e.preventDefaultAction=!0}}(e,n)}}]})},e.Remove.prototype.addOverlay=function(e){return!this.overlays.includes(e)&&(this.overlays.push(e),!0)},e.Remove.prototype.removeOverlay=function(e){if(this.overlays.includes(e)){var t=this.overlays.indexOf(e);return this.overlays.splice(t,1),!0}return!1},e.Remove.prototype.finishedRemoving=function(){return this.finishedObservable},e.Remove.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Remove.prototype.isActive=function(){return this.active},e.Remove.prototype.getContainingOverlay=function(e){for(var t in this.overlays){var i=this.overlays[t];if(i.contains(e,4,!0))return i}return null},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";function t(e,t,i){e=e.times(window.devicePixelRatio),i.beginPath(),i.lineWidth=t.borderWidth,i.strokeStyle=t.borderColor,i.rect(e.x,e.y,e.width,e.height),i.stroke()}return e.Draw=function(e,t,i){var o;this.viewer=e,this.style=t,this.startCondition=i,this.active=!0,this.drawing=!1,this.currentRect=null,this.startPoint=null,this.finishedObservable=new Rx.Subject,(o=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(e.preventDefaultAction=!0)}(e,o)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,t){if(t.isDrawing()){var i=new OpenSeadragon.Point(e.position.x,e.position.y);t.updateOverlay(i),e.preventDefaultAction=!0}}(e,o)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){var i=new OpenSeadragon.Point(e.position.x,e.position.y);t.createEmptyRectAt(i),e.preventDefaultAction=!1,t.drawing=!0}}(e,o)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){if(t.isDrawing()){t.drawing=!1;var i=ImageView.CoordinateConversion.convertCoordinatesFromCanvasToImage(t.currentRect,t.viewer),o=new ImageView.Overlay(i,t.viewer,t.style);t.finishedObservable.onNext(o),e.preventDefaultAction=!0}}(e,o)}}]})},e.Draw.prototype.finishedDrawing=function(){return this.finishedObservable},e.Draw.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Draw.prototype.isActive=function(){return this.active},e.Draw.prototype.isDrawing=function(){return this.drawing},e.Draw.prototype.createEmptyRectAt=function(e){this.currentRect=new OpenSeadragon.Rect(e.x,e.y,0,0),this.startPoint=e,t(this.currentRect,this.style,this.viewer.drawer.context)},e.Draw.prototype.updateOverlay=function(e){this.viewer.forceRedraw();var i=this;this.viewer.addOnceHandler("update-viewport",function(o){i.isDrawing()&&(i.currentRect.x=Math.min(i.startPoint.x,e.x),i.currentRect.y=Math.min(i.startPoint.y,e.y),i.currentRect.width=Math.abs(i.startPoint.x-e.x),i.currentRect.height=Math.abs(i.startPoint.y-e.y),t(i.currentRect,i.style,i.viewer.drawer.context))})},e}(ImageView=function(e){"use strict";return e.Measures=function(e){if(this.config=e.getConfig(),this.$container=$("#"+this.config.global.divId),this.originalImageSize=new OpenSeadragon.Point(this.getTotalImageWidth(e.getImageInfo()),this.getMaxImageHeight(e.getImageInfo())),this.config.global.adaptContainerWidth){let e=this.$container.height(),t=this.getAspectRatio();this.$container.width(e/t)}this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()),this.footerHeight=this.config.global.footerHeight,this.rotation=null!=e.viewer?e.viewer.viewport.getRotation():0,this.xPadding=this.outerCanvasSize.x-this.innerCanvasSize.x,this.yPadding=this.outerCanvasSize.y-this.innerCanvasSize.y,this.innerCanvasSize.y-=this.footerHeight,this.fitToHeight()?this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.y/this.ratio(this.getRotatedSize(this.originalImageSize)),this.innerCanvasSize.y):this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.x,this.innerCanvasSize.x*this.ratio(this.getRotatedSize(this.originalImageSize))),this.rotated()&&(this.imageDisplaySize=this.getRotatedSize(this.imageDisplaySize))},e.Measures.prototype.getMaxImageWidth=function(e){var t=0;if(e&&e.length>0)for(var i=0;i<e.length;i++){var o=e[i];o.tileSource&&(correction=o.width,o=o.tileSource),t=Math.max(t,o.width*correction)}return t},e.Measures.prototype.getMaxImageHeight=function(e){var t=0;if(e&&e.length>0)for(var i=0;i<e.length;i++){var o=e[i],n=1;o.tileSource&&(n=o.width,o=o.tileSource),t=Math.max(t,o.height*n)}return t},e.Measures.prototype.getTotalImageWidth=function(e){var t=0;if(e&&e.length>0)for(var i=0;i<e.length;i++){var o=e[i],n=1;o.tileSource&&(n=o.width,o=o.tileSource),t+=o.width*n}return t},e.Measures.prototype.getTotalImageHeight=function(e){var t=0;if(e&&e.length>0)for(var i=0;i<e.length;i++){var o=e[i];o.tileSource&&(correction=o.width,o=o.tileSource),t+=o.height*correction}return t},e.Measures.prototype.getImageHomeSize=function(){var e=this.rotated()?1/this.ratio(this.originalImageSize):this.ratio(this.originalImageSize);if(this.fitToHeight())var t=(i=this.innerCanvasSize.y)/e;else var i=(t=this.innerCanvasSize.x)*e;return this.getRotatedSize(new OpenSeadragon.Point(t,i))},e.Measures.prototype.rotated=function(){return this.rotation%180!=0},e.Measures.prototype.landscape=function(){return this.ratio(this.originalImageSize)<1},e.Measures.prototype.ratio=function(e){return e.y/e.x},e.Measures.prototype.getRotatedSize=function(e){return new OpenSeadragon.Point(this.rotated()?e.y:e.x,this.rotated()?e.x:e.y)},e.Measures.prototype.fitToHeight=function(){return!this.config.global.adaptContainerHeight&&this.ratio(this.getRotatedSize(this.originalImageSize))>this.ratio(this.innerCanvasSize)},e.Measures.prototype.resizeCanvas=function(){this.config.global.adaptContainerHeight&&this.$container.height(this.getRotatedSize(this.imageDisplaySize).y+this.footerHeight),this.config.global.adaptContainerWidth&&this.$container.width(this.getRotatedSize(this.imageDisplaySize).x),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()-this.footerHeight)},e.Measures.prototype.calculateExcessHeight=function(){var e=this.getRotatedSize(this.getImageHomeSize());return this.config.global.adaptContainerHeight||this.config.global.adaptContainerWidth||this.fitToHeight()?0:.5*(this.innerCanvasSize.y-e.y)},e.Measures.prototype.getAspectRatio=function(){return this.originalImageSize.y/this.originalImageSize.x},e}(ImageView=function(e){"use strict";if(!e||!e.Line)throw"imageView and imageView.Overlay must be initialized first";var t="default",i=4;return e.Line.Transform=function(o,n,r){var a;this.viewer=o,this.style=n,this.startCondition=r,this.active=!0,this.transforming=!1,this.currentLine=null,this.drawArea=null,this.startPoint=null,this.lines=[],this.finishedObservable=new Rx.Subject,this.cursor=void 0,this.fixed=e.Line.getFixed(!1),(a=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(e.preventDefaultAction=!0)}(e,a)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,i){if(i.isTransforming()){var o=new OpenSeadragon.Point(t.position.x,t.position.y),n=e.CoordinateConversion.convertPointFromImageToCanvas(i.currentLine.p1,i.viewer),r=e.CoordinateConversion.convertPointFromImageToCanvas(i.currentLine.p2,i.viewer),a=null,s=null;if(i.drawArea===e.Line.HitAreas.POINT_1){var l=i.currentLine.fixed.p1.x?n.x:o.x,h=i.currentLine.fixed.p1.y?n.y:o.y;a=new OpenSeadragon.Point(l,h),s=r}else if(i.drawArea===e.Line.HitAreas.POINT_2){var l=i.currentLine.fixed.p2.x?r.x:o.x,h=i.currentLine.fixed.p2.y?r.y:o.y;a=n,s=new OpenSeadragon.Point(l,h)}else if(i.drawArea===e.Line.HitAreas.LINE&&i.startPoint){var c=i.currentLine.fixed.line.x?0:i.startPoint.x-o.x,g=i.currentLine.fixed.line.y?0:i.startPoint.y-o.y,u=new OpenSeadragon.Point(c,g);a=n.minus(u),s=r.minus(u),i.startPoint=o}else a=n,s=r;var d=e.CoordinateConversion.convertPointFromCanvasToImage(a,i.viewer),v=e.CoordinateConversion.convertPointFromCanvasToImage(s,i.viewer);i.currentLine.p1=d,i.currentLine.p2=v,i.viewer.forceRedraw(),t.preventDefaultAction=!0}}(t,a)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentLine&&t.drawArea){console.log("transform draw area ",t.drawArea);var i=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=i,t.transforming=!0,e.preventDefaultAction=!0,!0}t.transforming=!1}}(e,a)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(t.transforming=!1,e.preventDefaultAction=!0)}(e,a)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(t.transforming&&t.finishedObservable.onNext(t.currentLine),t.transforming=!1,e.preventDefaultAction=!0)}(e,a)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(o){!function(o,n){if(!n.isTransforming()&&n.isActive()&&n.startCondition(o.originalEvent)){var r=new OpenSeadragon.Point(o.position.x,o.position.y),a=n.getContainingLine(r),s=n.viewer.element;if(a?(n.currentLine=a,n.drawArea=a.getHitArea(r,i,!0)):(n.currentLine=null,n.drawArea=null),n.drawArea){var l=e.Line.HitAreas.getCursor(n.drawArea,a.fixed);n.cursor!=l&&(n.cursor=l,$(s).css({cursor:l}))}else n.cursor&&(n.cursor=void 0,$(s).css({cursor:t}));o.preventDefaultAction=!0}}(o,a)}}]})},e.Line.Transform.prototype.addLine=function(e){return!this.lines.includes(e)&&(this.lines.push(e),!0)},e.Line.Transform.prototype.removeLine=function(e){if(this.lines.includes(e)){var t=this.lines.indexOf(e);return this.lines.splice(t,1),!0}return!1},e.Line.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},e.Line.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Line.Transform.prototype.isActive=function(){return this.active},e.Line.Transform.prototype.isTransforming=function(){return this.transforming},e.Line.Transform.prototype.getContainingLine=function(e){for(var t in this.lines){var o=this.lines[t];if(o.contains(e,i,!0))return o}return null},e}(ImageView=function(e){"use strict";if(!e)throw"Image view must exist";function t(e){var t=e.userData;if(!t.hidden){var i=t.viewer.drawer.context,o=ImageView.CoordinateConversion.convertPointFromImageToCanvas(t.p1,t.viewer),n=ImageView.CoordinateConversion.convertPointFromImageToCanvas(t.p2,t.viewer);i.beginPath(),i.lineWidth=t.style.lineWidth,i.strokeStyle=t.style.lineColor,i.moveTo(o.x,o.y),i.lineTo(n.x,n.y),i.stroke()}}function i(e,t,i,o){return function(e,t,i){return Math.sqrt(function(e,t,i){var o=n(t,i);if(0==o)return n(e,t);var r=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/o;return n(e,r<0?t:r>1?i:{x:t.x+r*(i.x-t.x),y:t.y+r*(i.y-t.y)})}(e,t,i))}(i,e,t)<=o}function o(e){return e*e}function n(e,t){return o(e.x-t.x)+o(e.y-t.y)}function r(e,t){return Math.sqrt(n(e,t))}return e.Line=function(t,i,o,n){this.viewer=o,this.p1=new OpenSeadragon.Point(t.x,t.y),this.p2=new OpenSeadragon.Point(i.x,i.y),this.style=n,this.fixed=e.Line.getFixed(!1),this.hidden=!1},e.Line.getFixed=function(e){return{p1:{x:e,y:e},p2:{x:e,y:e},line:{x:e,y:e}}},e.Line.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},e.Line.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},e.Line.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},e.Line.prototype.contains=function(t,o,n){return i(n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p1,this.viewer):this.p1,n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p2,this.viewer):this.p2,t,o)},e.Line.prototype.getHitArea=function(t,o,n){var a=n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p1,this.viewer):this.p1,s=n?e.CoordinateConversion.convertPointFromImageToCanvas(this.p2,this.viewer):this.p2;return r(t,a)<=o?e.Line.HitAreas.POINT_1:r(t,s)<=o?e.Line.HitAreas.POINT_2:i(a,s,t,o)?e.Line.HitAreas.LINE:void 0},e.Line.prototype.hide=function(e){this.hidden=!0,e&&this.viewer.forceRedraw()},e.Line.prototype.show=function(e){this.hidden=!1,e&&this.viewer.forceRedraw()},e.Line.convertStringToPoints=function(e){var t=e.split(",");if(t&&4==t.length)return{p1:new OpenSeadragon.Point(parseFloat(t[0]),parseFloat(t[1])),p2:new OpenSeadragon.Point(parseFloat(t[2]),parseFloat(t[3]))};throw"Cannot convert string '"+e+"' to Points"},e.Line.convertPointsToString=function(e,t){return t||(t=0),e.p1.x.toFixed(t)+","+e.p1.y.toFixed(t)+","+e.p2.x.toFixed(t)+","+e.p2.y.toFixed(t)},e.Line.HitAreas={POINT_1:"point1",POINT_2:"point2",LINE:"line",isCorner:function(e){return e===this.POINT_1||e===this.POINT_2},isEdge:function(e){return e===this.LINE},getCursor:function(e,t){return e===this.POINT_1?t.p1.x||t.p1.y?t.p1.x?"ns-resize":t.p1.y?"ew-resize":"not-allowed":"move":e===this.POINT_2?t.p2.x||t.p2.y?t.p2.x?"ns-resize":t.p2.y?"ew-resize":"not-allowed":"move":e===this.LINE?t.line.x||t.line.y?t.line.x?"ns-resize":t.line.y?"ew-resize":"not-allowed":"move":void 0}},e}(ImageView=function(e){"use strict";if(!e||!e.DataPoint)throw"imageView and imageView.DataPoint must be initialized first";var t="default",i=4;return e.DataPoint.Transform=function(o,n){var r;this.viewer=o,this.startCondition=n,this.active=!0,this.transforming=!1,this.currentDataPoint=null,this.drawArea=null,this.dataPoints=[],this.finishedObservable=new Rx.Subject,this.cursor=void 0,(r=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(t){!function(t,i){if(i.isTransforming()){var o=new OpenSeadragon.Point(t.position.x,t.position.y),n=e.CoordinateConversion.convertPointFromImageToCanvas(i.currentDataPoint.point,i.viewer),r=null;i.drawArea===e.DataPoint.HitAreas.POINT?r=o:i.drawArea===e.DataPoint.HitAreas.LINE_X?(console.log("move line x"),r=new OpenSeadragon.Point(n.x,o.y)):r=i.drawArea===e.DataPoint.HitAreas.LINE_Y?new OpenSeadragon.Point(o.x,n.y):n;var a=e.CoordinateConversion.convertPointFromCanvasToImage(r,i.viewer);i.currentDataPoint.point=a,i.viewer.forceRedraw(),t.preventDefaultAction=!0}}(t,r)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentDataPoint&&t.drawArea){var i=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=i,t.transforming=!0,e.preventDefaultAction=!0,!0}t.transforming=!1}}(e,r)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){t.isTransforming()&&(t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){t.isActive()&&(t.transforming&&t.finishedObservable.onNext(t.currentDataPoint),t.transforming=!1,e.preventDefaultAction=!0)}(e,r)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(o){!function(o,n){if(!n.isTransforming()&&n.isActive()&&n.startCondition(o.originalEvent)){var r=new OpenSeadragon.Point(o.position.x,o.position.y),a=n.getContainingDataPoint(r),s=n.viewer.element;if(a?(n.currentDataPoint=a,n.drawArea=a.getHitArea(r,i,!0)):(n.currentDataPoint=null,n.drawArea=null),n.drawArea){var l=e.DataPoint.HitAreas.getCursor(n.drawArea,a.style);n.cursor!=l&&(n.cursor=l,$(s).css({cursor:l}))}else n.cursor&&(n.cursor=void 0,$(s).css({cursor:t}));o.preventDefaultAction=!0}}(o,r)}}]})},e.DataPoint.Transform.prototype.addDataPoint=function(e){return!this.dataPoints.includes(e)&&(this.dataPoints.push(e),!0)},e.DataPoint.Transform.prototype.removeDataPoint=function(e){if(this.dataPoints.includes(e)){var t=this.dataPoints.indexOf(e);return this.dataPoints.splice(t,1),!0}return!1},e.DataPoint.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},e.DataPoint.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.DataPoint.Transform.prototype.isActive=function(){return this.active},e.DataPoint.Transform.prototype.isTransforming=function(){return this.transforming},e.DataPoint.Transform.prototype.getContainingDataPoint=function(e){for(var t in this.dataPoints){var o=this.dataPoints[t];if(o.contains(e,i,!0))return o}return null},e}(ImageView=function(e){"use strict";if(!e)throw"Image view must exist";function t(e){var t=e.userData;if(!t.hidden){var i=t.viewer.drawer.context,o=ImageView.CoordinateConversion.convertPointFromImageToCanvas(t.point,t.viewer);t.style.lineX&&(i.beginPath(),i.lineWidth=t.style.lineX.lineWidth,i.strokeStyle=t.style.lineX.lineColor,i.moveTo(0,o.y),i.lineTo(i.canvas.width,o.y),i.stroke()),t.style.lineY&&(i.beginPath(),i.lineWidth=t.style.lineY.lineWidth,i.strokeStyle=t.style.lineY.lineColor,i.moveTo(o.x,0),i.lineTo(o.x,i.canvas.height),i.stroke()),t.style.point&&(i.beginPath(),i.fillStyle=t.style.point.pointColor,i.lineWidth=0,i.arc(o.x,o.y,t.style.point.pointRadius,0,2*Math.PI),i.fill())}}return e.DataPoint=function(e,t,i){this.viewer=t,this.point=new OpenSeadragon.Point(e.x,e.y),this.style=i,this.hidden=!1},e.DataPoint.getStyle=function(e,t,i){return{point:e,lineX:t,lineY:i}},e.DataPoint.getPointStyle=function(e,t){return{pointRadius:e,pointColor:t}},e.DataPoint.getLineStyle=function(e,t){return{lineWidth:e,lineColor:t}},e.DataPoint.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},e.DataPoint.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},e.DataPoint.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},e.DataPoint.prototype.contains=function(t,i,o){var n=o?e.CoordinateConversion.convertPointFromImageToCanvas(this.point,this.viewer):this.point,r=Math.abs(t.x-n.x),a=Math.abs(t.y-n.y);return!!(this.style.point&&r<=this.style.point.pointRadius+i&&a<=this.style.point.pointRadius+i)||(!!(r<=i&&this.style.lineY)||!!(a<=i&&this.style.lineX))},e.DataPoint.prototype.getHitArea=function(t,i,o){var n=o?e.CoordinateConversion.convertPointFromImageToCanvas(this.point,this.viewer):this.point,r=Math.abs(t.x-n.x),a=Math.abs(t.y-n.y);return this.style.point&&r<=this.style.point.pointRadius+i&&a<=this.style.point.pointRadius+i?e.DataPoint.HitAreas.POINT:this.style.lineY&&r<=i?e.DataPoint.HitAreas.LINE_Y:this.style.lineX&&a<=i?e.DataPoint.HitAreas.LINE_X:void 0},e.DataPoint.prototype.hide=function(e){this.hidden=!0,e&&this.viewer.forceRedraw()},e.DataPoint.prototype.show=function(e){this.hidden=!1,e&&this.viewer.forceRedraw()},e.DataPoint.convertStringToPoint=function(e){var t=e.split(",");if(t&&2==t.length)return{x:parseFloat(t[0]),y:parseFloat(t[1])};throw"Cannot convert string '"+e+"' to Point"},e.DataPoint.convertPointsToString=function(e,t){return t||(t=0),e.x.toFixed(t)+","+e.y.toFixed(t)},e.DataPoint.HitAreas={POINT:"point",LINE_Y:"lineY",LINE_X:"lineX",isCorner:function(e){return e===this.POINT},isEdge:function(e){return e===this.LINE_Y||e===this.LINE_X},getCursor:function(e,t){return e===this.POINT&&t.point?"move":e===this.LINE_X&&t.lineX?"ns-resize":e===this.LINE_Y&&t.lineY?"ew-resize":void 0}},e}(ImageView=function(e){"use strict";e.CoordinateConversion={};var t=e.CoordinateConversion;function i(e,t,i){var o,n,r=t*Math.PI/180;return i?(o=e.x*Math.cos(r)-e.y*Math.sin(r),n=e.x*Math.sin(r)+e.y*Math.cos(r)):(o=e.x*Math.cos(r)+e.y*Math.sin(r),n=-e.x*Math.sin(r)+e.y*Math.cos(r)),new OpenSeadragon.Point(o,n)}function o(e,t){var i=t*Math.PI/180,o=Math.abs(Math.sin(i)),n=Math.abs(Math.cos(i)),r=e.width*o+e.height*n,a=e.width*n+e.height*o,s=Math.abs(a),l=Math.abs(r),h=s-e.width,c=l-e.height;return new OpenSeadragon.Rect(-h/2,-c/2,s,l)}return e.CoordinateConversion.scaleToOpenSeadragon=function(e,t,i){var o=image.viewer.world.getItemAt(0).source.dimensions,n=image.sizes.originalImageSize.x/o.x;return e=(e=e.times(1/o.x)).times(1/n)},e.CoordinateConversion.scaleToImage=function(e,t,i){var o=image.viewer.world.getItemAt(0).source.dimensions,n=image.sizes.originalImageSize.x/o.x;return e=(e=e.times(o.x)).times(n)},e.CoordinateConversion.scaleToRotatedImage=function(e,t,i){var n=t.world.getItemAt(0).source.dimensions,r=new OpenSeadragon.Rect(0,0,n.x,n.y),a=new OpenSeadragon.Rect(0,0,i.x,i.y),s=t.viewport.getRotation(),l=o(r,s),h=o(a,s).width/l.width;return e=(e=e.times(n.x)).times(h)},e.CoordinateConversion.scaleToOpenSeadragonCoordinates=function(e,t,i){var n=t.world.getItemAt(0).source.dimensions,r=new OpenSeadragon.Rect(0,0,n.x,n.y),a=new OpenSeadragon.Rect(0,0,i.x,i.y),s=t.viewport.getRotation(),l=o(r,s),h=o(a,s).width/l.width;return e=(e=e.times(1/n.x)).times(1/h)},e.CoordinateConversion.convertRectFromOpenSeadragonToImage=function(e,i,o){var n=ImageView.CoordinateConversion.convertRectFromImageToRotatedImage(e,i);return t.scaleToRotatedImage(n,i,o)},e.CoordinateConversion.convertRectFromImageToOpenSeadragon=function(e,i,o){var n=t.scaleToOpenSeadragonCoordinates(e,i);return t.convertRectFromRotatedImageToImage(n,i,o)},e.CoordinateConversion.convertCoordinatesFromImageToCanvas=function(e,i){var o=i.drawer.context.canvas.width/i.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var n=t.convertPointFromImageToCanvas(e.getTopLeft(),i),r=t.convertPointFromImageToCanvas(e.getBottomRight(),i),a=n.x+.5*(r.x-n.x),s=n.y+.5*(r.y-n.y);return new OpenSeadragon.Rect(a-.5*e.width*o,s-.5*e.height*o,e.width*o,e.height*o)},e.CoordinateConversion.convertCoordinatesFromCanvasToImage=function(e,i){var o=i.drawer.context.canvas.width/i.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var n=t.convertPointFromCanvasToImage(e.getTopLeft(),i),r=t.convertPointFromCanvasToImage(e.getBottomRight(),i),a=n.x+.5*(r.x-n.x),s=n.y+.5*(r.y-n.y);return new OpenSeadragon.Rect(a-.5*e.width/o,s-.5*e.height/o,e.width/o,e.height/o)},e.CoordinateConversion.convertPointFromImageToCanvas=function(e,t){var o=t.drawer.context.canvas.width/t.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var n=t.source.width/t.source.height,r=t.viewport.getRotation(),a=new OpenSeadragon.Point(.5,.5/n).times(-1),s=t.viewport.getCenter(!0),l=new OpenSeadragon.Point(t.viewport.getBoundsNoRotate(!0).width/2,t.viewport.getBoundsNoRotate(!0).height/2),h=i(a.plus(s),r,!0),c=l.minus(h),g=i(a.plus(e),r,!0);return c.plus(g).times(o)},e.CoordinateConversion.convertPointFromCanvasToImage=function(e,t){var o=t.drawer.context.canvas.width/t.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var n=t.source.width/t.source.height,r=t.viewport.getRotation(),a=new OpenSeadragon.Point(.5,.5/n).times(-1),s=t.viewport.getCenter(!0),l=new OpenSeadragon.Point(t.viewport.getBoundsNoRotate(!0).width/2,t.viewport.getBoundsNoRotate(!0).height/2),h=i(a.plus(s),r,!0),c=l.minus(h);return i(e.times(1/o).minus(c),r,!1).minus(a)},e.CoordinateConversion.convertRectFromImageToRotatedImage=function(e,t){var n=t.viewport.getRotation(),r=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),a=o(r,n),s=r.width/r.height,l=(a.width,a.height,new OpenSeadragon.Rect(0,0,1,1/s)),h=o(l,n),c=e.getCenter(),g=i(l.getCenter().times(-1).plus(c),n,!0),u=new OpenSeadragon.Point(h.width/2,h.height/2).times(-1),d=g.minus(u);return new OpenSeadragon.Rect(d.x-e.width/2,d.y-e.height/2,e.width,e.height)},e.CoordinateConversion.convertRectFromRotatedImageToImage=function(e,t){var n=t.viewport.getRotation(),r=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),a=o(r,n),s=r.width/r.height,l=(a.width,a.height,new OpenSeadragon.Rect(0,0,1,1/s)),h=o(l,n),c=l.getCenter().times(-1),g=new OpenSeadragon.Point(h.width/2,h.height/2).times(-1),u=e.getCenter(),d=i(g.plus(u),n,!1).minus(c);return new OpenSeadragon.Rect(d.x-e.width/2,d.y-e.height/2,e.width,e.height)},e.CoordinateConversion.convertPointFromImageToRotatedImage=function(e,t){var n=t.viewport.getRotation(),r=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),a=o(r,n),s=r.width/r.height,l=(a.width,a.height,new OpenSeadragon.Rect(0,0,1,1/s)),h=o(l,n),c=e,g=i(l.getCenter().times(-1).plus(c),n,!0),u=new OpenSeadragon.Point(h.width/2,h.height/2).times(-1);return g.minus(u)},e.CoordinateConversion.convertPointFromRotatedImageToImage=function(e,t){var n=t.viewport.getRotation(),r=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),a=o(r,n),s=r.width/r.height,l=(a.width,a.height,new OpenSeadragon.Rect(0,0,1,1/s)),h=o(l,n),c=l.getCenter().times(-1),g=e;return i(new OpenSeadragon.Point(h.width/2,h.height/2).times(-1).plus(g),n,!1).minus(c)},e}(ImageView=function(e){"use strict";return e.Controls=function(t,i){this.config=t,this.image=i;var o=this;e.Controls.Persistence&&(this.persistence=new e.Controls.Persistence(t,i)),this.config.global.controls&&($(this.config.global.controls.rotateLeft).on("click",function(){o.rotateLeft()}),$(this.config.global.controls.rotateRight).on("click",function(){o.rotateRight()}),$(this.config.global.controls.reset).on("click",function(){o.reset(!0)})),i.observables&&(i.observables.redrawRequired.sample(i.observables.viewportUpdate).subscribe(function(e){o.setLocation(e),o.setPanning(!1)}),i.config.global.panHomeOnZoomOut&&i.observables.viewerZoom.subscribe(function(e){o.isPanning()||i.viewer.viewport.getZoom()<=i.viewer.viewport.minZoomLevel&&(o.setPanning(!0),o.goHome(!0),o.setPanning(!1))})),$("#fullscreenTemplate").length>0&&($("#fullscreenTemplate").on("mousemove",function(){o.fullscreenControlsFadeout()}),$("#fullscreenMap").on("touchmove",function(){o.fullscreenControlsFadeout()}).on("touchend",function(){o.fullscreenControlsFadeout()}))},e.Controls.prototype.getLocation=function(){return{x:this.getCenter().x,y:this.getCenter().y,zoom:this.getZoom()/this.getCurrentRotationZooming(),rotation:this.getRotation()}},e.Controls.prototype.getCenter=function(){return this.image.viewer.viewport.getCenter(!0)},e.Controls.prototype.setCenter=function(e){this.image.viewer.viewport.panTo(e,!0)},e.Controls.prototype.getZoom=function(){return this.image.viewer.viewport.getZoom(!0)},e.Controls.prototype.zoomTo=function(e){var t=parseFloat(e)/this.image.viewer.viewport.getZoom();this.image.viewer.viewport.zoomBy(t,this.image.viewer.viewport.getCenter(!1),!0)},e.Controls.prototypesetFullScreen=function(e){this.image.viewer.setFullScreen(e)},e.Controls.prototype.goHome=function(e){this.image.viewer.viewport.goHome(e),this.zoomedOut=!0},e.Controls.prototype.reset=function(e){this.goHome(!0),this.image.viewer.viewport.zoomTo(this.image.viewer.viewport.getHomeZoom(),null,!0),e&&this.rotateTo(0)},e.Controls.prototype.zoomIn=function(){this.image.viewer.viewport.zoomBy(this.config.global.zoomSpeed,this.image.viewer.viewport.getCenter(!1),!1)},e.Controls.prototype.zoomOut=function(){this.image.viewer.viewport.zoomBy(1/this.config.global.zoomSpeed,this.image.viewer.viewport.getCenter(!1),!1)},e.Controls.prototype.rotateRight=function(){var e=this.image.viewer.viewport.getRotation()+90;this.rotateTo(e)},e.Controls.prototype.rotateLeft=function(){var e=this.image.viewer.viewport.getRotation()-90;this.rotateTo(e)},e.Controls.prototype.getRotation=function(){return this.image.viewer.viewport.getRotation()},e.Controls.prototype.setRotation=function(e){return this.rotateTo(e)},e.Controls.prototype.rotateTo=function(e){e<0&&(e+=360),e%=360,this.panning=!0,this.currentZoom=null,this.image.viewer.viewport.setRotation(e),this.panning=!1},e.Controls.prototype.getCurrentRotationZooming=function(){var e=this.image.getSizes();return e&&e.rotated()?1/e.ratio(e.originalImageSize):1},e.Controls.prototype.setPanning=function(e){this.panning=e},e.Controls.prototype.isPanning=function(){return this.panning},e.Controls.prototype.fullscreenControlsFadeout=function(){this.fadeout&&(clearTimeout(this.fadeout),this.showFullscreenControls()),this.fadeout=setTimeout(this.hideFullscreenControls,3e3)},e.Controls.prototype.hideFullscreenControls=function(){$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").stop().fadeOut("slow")},e.Controls.prototype.showFullscreenControls=function(){$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").show()},e.Controls.prototype.setLocation=function(e){this.image.viewer.viewport.minZoomLevel=this.image.viewer.viewport.getHomeZoom()*this.config.global.minZoomLevel;var t=e.targetLocation.zoom,i=new OpenSeadragon.Point(e.targetLocation.x,e.targetLocation.y);(t*this.image.viewer.viewport.getHomeZoom()-this.image.viewer.viewport.minZoomLevel<.001||!t)&&this.image.config.global.fitToContainer?this.goHome(!0):(this.image.config.global.fitToContainer&&this.image.viewer.viewport.zoomTo(t*this.getCurrentRotationZooming(),null,!0),this.setCenter(i)),"open"===e.osState&&0!==e.targetLocation.rotation&&this.rotateTo(e.targetLocation.rotation)},e}(ImageView=function(e){"use strict";if(!e)throw"Image view must exist";function t(e){var t=e.userData;if(!t.hidden){var i=t.viewer.drawer.context,o=ImageView.CoordinateConversion.convertCoordinatesFromImageToCanvas(t.rect,t.viewer).times(window.devicePixelRatio);i.beginPath(),i.lineWidth=t.style.borderWidth,i.strokeStyle=t.style.borderColor,i.rect(o.x,o.y,o.width,o.height),i.stroke()}}function i(e,t,i){return t.x>e.getTopLeft().x-i&&t.x<e.getBottomRight().x+i&&t.y>e.getTopLeft().y-i&&t.y<e.getBottomRight().y+i}function o(e){return e*e}function n(e,t){return o(e.x-t.x)+o(e.y-t.y)}function r(e,t){return Math.sqrt(n(e,t))}function a(e,t,i){return Math.sqrt(function(e,t,i){var o=n(t,i);if(0==o)return n(e,t);var r=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/o;return n(e,r<0?t:r>1?i:{x:t.x+r*(i.x-t.x),y:t.y+r*(i.y-t.y)})}(e,t,i))}return e.Overlay=function(e,t,i){this.viewer=t,this.rect=e,this.style=i,this.fixed=null,this.allowMove=!1},e.Overlay.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},e.Overlay.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},e.Overlay.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},e.Overlay.prototype.contains=function(t,o,n){return i(n?e.CoordinateConversion.convertCoordinatesFromImageToCanvas(this.rect,this.viewer):this.rect,t,o)},e.Overlay.prototype.getHitArea=function(t,o,n){var s=n?e.CoordinateConversion.convertCoordinatesFromImageToCanvas(this.rect,this.viewer):this.rect;if(i(s,t,o)){var l=function(t,i,o){var n=r(i,t.getTopLeft()),a=r(i,t.getBottomLeft()),s=r(i,t.getTopRight()),l=r(i,t.getBottomRight()),h=Math.min(n,Math.min(s,Math.min(a,l)));if(h<=o){if(n===h)return e.Overlay.HitAreas.TOPLEFT;if(s===h)return e.Overlay.HitAreas.TOPRIGHT;if(a===h)return e.Overlay.HitAreas.BOTTOMLEFT;if(l===h)return e.Overlay.HitAreas.BOTTOMRIGHT}return""}(s,t,o);if(l||(l=function(t,i,o){var n=a(i,t.getTopLeft(),t.getBottomLeft()),r=a(i,t.getBottomLeft(),t.getBottomRight()),s=a(i,t.getTopRight(),t.getBottomRight()),l=a(i,t.getTopLeft(),t.getTopRight()),h=Math.min(n,Math.min(s,Math.min(l,r)));if(h<=o){if(n===h)return e.Overlay.HitAreas.LEFT;if(s===h)return e.Overlay.HitAreas.RIGHT;if(l===h)return e.Overlay.HitAreas.TOP;if(r===h)return e.Overlay.HitAreas.BOTTOM}return""}(s,t,o)),this.allowMove&&!l&&i(s,t,0)&&(l=e.Overlay.HitAreas.CENTER),function(t,i){if(t&&i)switch(t){case e.Overlay.HitAreas.TOP:return i.y||i.height;case e.Overlay.HitAreas.BOTTOM:return i.height;case e.Overlay.HitAreas.LEFT:return i.x||i.width;case e.Overlay.HitAreas.RIGHT:return i.width;case e.Overlay.HitAreas.TOPLEFT:return i.x||i.y||i.width||i.height;case e.Overlay.HitAreas.TOPRIGHT:return i.y||i.width||i.height;case e.Overlay.HitAreas.BOTTOMLEFT:return i.height||i.x||i.width;case e.Overlay.HitAreas.BOTTOMRIGHT:return i.width||i.height;case e.Overlay.HitAreas.CENTER:return i.y||i.x;case e.Overlay.HitAreas.FIXED:return!0}return!1}(l,this.fixed))return e.Overlay.HitAreas.FIXED}return l},e.Overlay.prototype.hide=function(e){this.hidden=!0,e&&this.viewer.forceRedraw()},e.Overlay.prototype.show=function(e){this.hidden=!1,e&&this.viewer.forceRedraw()},e.Overlay.convertStringToRect=function(e){var t=e.split(",");if(t&&4==t.length)return new OpenSeadragon.Rect(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));throw"Cannot convert string '"+e+"' to Rectangle"},e.Overlay.convertRectToString=function(e,t){return t||(t=0),e.x.toFixed(t)+","+e.y.toFixed(t)+","+e.width.toFixed(t)+","+e.height.toFixed(t)},e.Overlay.drawPoint=function(e,t,i,o){!function(e){var t=e.userData[0].times(window.devicePixelRatio),i=e.userData[1],o=e.userData[2],n=e.userData[3],r=i.drawer.context;r.beginPath(),o&&(r.fillStyle=o);r.arc(t.x,t.y,n,0,2*Math.PI,!0),r.fill()}({userData:[e,t,i,o]})},e.Overlay.HitAreas={TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",FIXED:"f",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(e){return e===this.TOPLEFT||e===this.BOTTOMRIGHT?"nwse-resize":e===this.TOPRIGHT||e===this.BOTTOMLEFT?"nesw-resize":e===this.TOP||e===this.BOTTOM?"ns-resize":e===this.RIGHT||e===this.LEFT?"ew-resize":e===this.CENTER?"move":e===this.FIXED?"not-allowed":void 0}},e}(ImageView)))))))))))));