/*!
 * This file is part of the Goobi viewer - a content presentation and management application for digitized objects.
 *
 * Visit these websites for more information.
 * - http://www.intranda.com
 * - http://digiverso.com
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
THREE.FBXMeshLoader=function(e,t){this.color=t,this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.FBXMeshLoader.prototype={constructor:THREE.FBXMeshLoader,load:function(e,t,o,i){var n=new THREE.FBXLoader(this.manager);this.color;Q($.getJSON(e)).then(function(e){console.log("loading object info = ",e);e.uri.substring(0,e.uri.lastIndexOf("/"));var o=e.uri;n.load(o,function(e){console.log("loaded mesh ",e),t(e)},function(e){console.log("loading ",e)},function(e){console.log("error ",e)})})}},THREE.GLTFDRACOLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.GLTFDRACOLoader.prototype={constructor:THREE.GLTFDRACOLoader,load:function(e,t,o,i){var n=new THREE.GLTFLoader(this.manager);THREE.DRACOLoader.setDecoderPath("/../three/dependencies/draco"),n.setDRACOLoader(new THREE.DRACOLoader),Q($.getJSON(e)).then(function(e){console.log("loading object info = ",e);e.uri.substring(0,e.uri.lastIndexOf("/"));var o=e.uri;n.load(o,function(e){console.log("loaded gltf ",e),t(e.scene)},function(e){console.log("loading ",e)},function(e){console.log("error ",e)})})}},THREE.OBJMTLLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.OBJMTLLoader.prototype={constructor:THREE.OBJMTLLoader,load:function(e,t,o,i){Q($.getJSON(e)).then(function(e){console.log("loading object info = ",e);e.uri.substring(0,e.uri.lastIndexOf("/"));var n=e.uri,a=e.resources.filter(function(e){return e.endsWith(".mtl")}).shift(),r=new THREE.MTLLoader(this.manager),s=new THREE.OBJLoader(this.manager);r.setTexturePath(a.substring(0,a.lastIndexOf("/"))+"/");r.load(a,function(e){e.preload(),s.setMaterials(e),s.load(n,t,o,i)},o,i)})}},THREE.PLYMeshLoader=function(e,t){this.color=t,this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.PLYMeshLoader.prototype={constructor:THREE.PLYMeshLoader,load:function(e,t,o,i){var n=new THREE.PLYLoader(this.manager),a=this.color;Q($.getJSON(e)).then(function(e){console.log("loading object info = ",e);e.uri.substring(0,e.uri.lastIndexOf("/"));var r=e.uri;n.load(r,function(e){e.computeVertexNormals();var o=new THREE.MeshStandardMaterial({color:a,shading:THREE.FlatShading}),i=new THREE.Mesh(e,o);i.castShadow=!0,i.receiveShadow=!0,t(i)},o,i)})}},THREE.STLMeshLoader=function(e,t){this.color=t,this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.STLMeshLoader.prototype={constructor:THREE.STLMeshLoader,load:function(e,t,o,i){var n=new THREE.STLLoader(this.manager),a=this.color;Q($.getJSON(e)).then(function(e){console.log("loading object info = ",e);e.uri.substring(0,e.uri.lastIndexOf("/"));var r=e.uri;console.log("loader ",n),n.load(r,function(e){e.computeVertexNormals();var o=new THREE.MeshStandardMaterial({color:a,shading:THREE.FlatShading}),i=new THREE.Mesh(e,o);i.castShadow=!0,i.receiveShadow=!0,t(i)},o,i)}).catch(function(e){i(e)})}},THREE.TDSMeshLoader=function(e,t){this.color=t,this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.TDSMeshLoader.prototype={constructor:THREE.TDSMeshLoader,load:function(e,t,o,i){var n=new THREE.TDSLoader(this.manager),a=new THREE.TextureLoader;Q($.getJSON(e)).then(function(e){console.log("loading object info = ",e);var r=e.uri,s=e.resources.filter(function(e){return e.match(/je?pg|png$/i)});n.load(r,function(e){console.log("LOADING 3DS OBJECT",e),e instanceof THREE.Mesh&&console.log("object is already a mesh");var o=s.map(function(e){return a.load(e)});console.log("loaded textures ",o),e.traverse(function(e){if(e instanceof THREE.Mesh){var t=o.shift();e.material.map=t}}),e.castShadow=!0,e.receiveShadow=!0,t(e)},o,i)})}},X3DLoader=function(){},X3DLoader.prototype={constructor:X3DLoader,load:function(e,t,o,i,n){return Q($.getJSON(t)).then(function(t){console.log("Loading x3dom ",t);var i='<x3d width="'+(e.width()+"px")+'" height="'+(e.height()+"px")+'"><scene><inline url="'+t.uri+'"></inline></scene></x3d>';e.get(0).innerHTML+=i,x3dom.reload(),o()})}};var WorldGenerator=function(){var e={camera:{fieldOfView:35,viewPadding:0,nearPlane:.1,farPlane:1e4,position:{x:0,y:0,z:0},offset:{x:0,y:0,z:0}},container:{id:"container"},light:{background:{color:16777215},ambient:{color:9474192,intensity:.7},directional:[{color:11184810,intensity:.7,position:{x:0,y:10,z:0},castShadow:!0,showHelper:!1},{color:11184810,intensity:.7,position:{x:0,y:-10,z:0},castShadow:!0,showHelper:!1},{color:11184810,intensity:.7,position:{x:-10,y:0,z:0},castShadow:!0,showHelper:!1},{color:11184810,intensity:.7,position:{x:10,y:0,z:0},castShadow:!0,showHelper:!1}]}},t=function(e,t){e.url;var o=e.url.replace("/info.json",""),i=o.substring(o.lastIndexOf(".")+1);switch(i.toLowerCase()){case"obj":return new THREE.OBJMTLLoader(t);case"ply":return new THREE.PLYMeshLoader(t,e.material.color);case"stl":return new THREE.STLMeshLoader(t,e.material.color);case"fbx":return new THREE.FBXMeshLoader(t,e.material.color);case"3ds":return new THREE.TDSMeshLoader(t);case"gltf":return new THREE.GLTFDRACOLoader(t);default:console.log("no loader defined for "+i)}},o=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z)},i=function(e,t){return{x:void 0===t.x?180*e._x/Math.PI:180*e._x/Math.PI+t.x,y:void 0===t.y?180*e._y/Math.PI:180*e._y/Math.PI+t.y,z:void 0===t.z?180*e._z/Math.PI:180*e._z/Math.PI+t.z}},n=function(e,t,o,i){i||(i={x:0,y:0,z:0});var n=t/180*Math.PI,a={x:e.x-i.x,y:e.y-i.y,z:e.z-i.z},r={x:a.x,y:a.y,z:a.z};switch(o){case"x":r.y=a.y*Math.cos(n)-a.z*Math.sin(n),r.z=a.y*Math.sin(n)+a.z*Math.cos(n);break;case"y":r.x=a.x*Math.cos(n)-a.z*Math.sin(n),r.z=a.x*Math.sin(n)+a.z*Math.cos(n);break;case"z":r.x=a.x*Math.cos(n)-a.y*Math.sin(n),r.y=a.x*Math.sin(n)+a.y*Math.cos(n);break;default:throw"Third parameter 'axis' must be one of 'x', 'y' or 'z'"}return{x:r.x+i.x,y:r.y+i.y,z:r.z+i.z}};return{create:function(a){var r={};return $.extend(!0,r,e),$.extend(!0,r,a),new class{constructor(e){if(console.log("Constructing world with config ",e),this.config=e,this.time=0,this.container=document.getElementById(e.container.id),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(e.camera.fieldOfView,this.container.clientWidth/this.container.clientHeight,e.camera.nearPlane,e.camera.farPlane),this.camera.position.set(e.camera.position.x,e.camera.position.y,e.camera.position.z),this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setClearColor(e.light.background.color),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.container.appendChild(this.renderer.domElement),this.controls=new THREE.OrbitControls(this.camera,this.container),this.loadingManager=new THREE.LoadingManager,this.loadingManager.onProgress=function(e,t,o){console.log("Progress on load ",e,t,o)},this.directionalLights=[],e.light.ambient){var t=new THREE.AmbientLight(e.light.ambient.color,e.light.ambient.intensity);this.scene.add(t),this.ambientLight=t}if(e.light.directional){var i=e.light.directional;$.isArray(i)||(i=[i]);for(var n=0;n<i.length;n++){var a=i[n],t=this.createShadowedLight(a.position,a.color,a.intensity,o(a.position),a.castShadow,a.showHelper);this.directionalLights.push(t),this.scene.add(t)}}this.tick=new Rx.Subject}initControls(e,t,o){var n=this;if(t.xAxis){var a=$(t.xAxis.rotateLeft);a.length>0&&a.on("click",function(t){n.rotate(e,i(e.rotation,{x:-90})),n.center(e,e.position)});var r=$(t.xAxis.rotateRight);r.length>0&&r.on("click",function(t){n.rotate(e,i(e.rotation,{x:90})),n.center(e,e.position)})}if(t.yAxis){var s=$(t.yAxis.rotateLeft);s.length>0&&s.on("click",function(t){n.rotate(e,i(e.rotation,{y:-90})),n.center(e,e.position)});var c=$(t.yAxis.rotateRight);c.length>0&&c.on("click",function(t){n.rotate(e,i(e.rotation,{y:90})),n.center(e,e.position)})}if(t.zAxis){var d=$(t.zAxis.rotateLeft);d.length>0&&d.on("click",function(t){n.rotate(e,i(e.rotation,{z:-90})),n.center(e,e.position)});var h=$(t.zAxis.rotateRight);h.length>0&&h.on("click",function(t){n.rotate(e,i(e.rotation,{z:90})),n.center(e,e.position)})}if(t.position){var l=$(t.position.reset);l.length>0&&l.on("click",function(e){n.controls.reset()})}}rotateLights(e,t){for(var o in this.directionalLights){var i=this.directionalLights[o],a=n(i.position,e,t);i.position.x=a.x,i.position.y=a.y,i.position.z=a.z}}addSphere(e){var t=new THREE.SphereGeometry(e.size/2,64,64),o=new THREE.MeshLambertMaterial({color:e.material.color,transparent:!!e.material.opacity,opacity:e.material.opacity}),i=new THREE.Mesh(t,o);this.center(i,e.position),e.focus&&this.zoomToObject(i,this.config.camera.viewPadding,this.config.camera.fieldOfView),e.onTick&&this.tick.subscribe(function(t){e.onTick(i,t)}),this.scene.add(i)}addBlock(e){var t=new THREE.BoxGeometry(e.box.max.x-e.box.min.x,e.box.max.y-e.box.min.y,e.box.max.z-e.box.min.z),o=new THREE.MeshLambertMaterial({color:e.material.color,transparent:!!e.material.opacity,opacity:e.material.opacity}),i=new THREE.Mesh(t,o);this.center(i,e.position),e.focus&&this.zoomToObject(i,this.config.camera.viewPadding,this.config.camera.fieldOfView),e.onTick&&this.tick.subscribe(function(t){e.onTick(i,t)}),this.scene.add(i)}addPlane(e){var t=new THREE.PlaneGeometry(e.size,e.size),o=new THREE.MeshLambertMaterial({color:e.material.color,transparent:!!e.material.opacity,opacity:e.material.opacity}),i=new THREE.Mesh(t,o);i.receiveShadow=!0,i.position.set(e.offset.x,e.offset.y,e.offset.z),i.rotation.set(e.rotation.x*Math.PI/180,e.rotation.y*Math.PI/180,e.rotation.z*Math.PI/180),e.onTick&&this.tick.subscribe(function(t){e.onTick(i,t)}),this.scene.add(i)}loadObject(e){console.log("Load object ",e);var o=t(e,this.loadingManager),i=this,n=Q.defer();return o&&o.load(e.url,function(t){i.addObject(t,e),n.resolve(t)},function(){},function(e){n.reject(e)}),n.promise}addObject(e,t){console.log("add object ",e),this.setSize(e,t.size),this.rotate(e,t.rotation);var o=(new THREE.Box3).setFromObject(e);o.getCenter(e.position),e.position.multiplyScalar(-1);var i=new THREE.Group;return this.scene.add(i),i.add(e),t.focus&&this.zoomToObject(i,this.config.camera.viewPadding,this.config.camera.fieldOfView),this.initControls(i,this.config.controls,t),t.onTick&&this.tick.subscribe(function(o){t.onTick(e,o)}),this.controls.saveState(),this.object=e,e}rotate(e,t){console.log("rotate object by ",t),e.rotation.set(t.x*Math.PI/180,t.y*Math.PI/180,t.z*Math.PI/180)}center(e,t){var o=this.getBoundingSphere(e),i=o.center;e.position.set(t.x-i.x,t.y-i.y,t.z-i.z)}setSize(e,t){var o=this.getBoundingSphere(e).radius,i=t/o;e.scale.set(i,i,i)}getBoundingSphere(e){var t;if(e.geometry&&e.geometry.computeBoundingSphere)e.geometry.boundingSphere||e.geometry.computeBoundingSphere(),(t=e.geometry.boundingSphere).radius*=e.scale.x;else{var o=(new THREE.Box3).setFromObject(e);t=o.getBoundingSphere()}return{center:t.center,radius:t.radius}}zoomToObject(e,t,o){var i=this.getBoundingSphere(e);this.zoomToPosition(i.center,2*i.radius+t,o)}zoomToPosition(e,t,o){var i=t/(2*Math.sin(Math.PI/180*o/2));this.camera.position.set(e.x,e.y,e.z+i)}createShadowedLight(e,t,o,i,n,a){var r=new THREE.DirectionalLight(t,o);if(r.position.set(e.x,e.y,e.z),this.scene.add(r),r.castShadow=n,r.shadow.camera.left=-i,r.shadow.camera.right=i,r.shadow.camera.top=i,r.shadow.camera.bottom=-i,r.shadow.camera.near=i/10,r.shadow.camera.far=10*i,r.shadow.mapSize.width=1024,r.shadow.mapSize.height=1024,r.shadow.bias=-.005,a){var s=new THREE.DirectionalLightHelper(r,i/10);this.scene.add(s)}return r}render(){if(!this.disposed){this.time+=1,this.renderer.render(this.scene,this.camera),this.tick.onNext(this.time);var e=this;window.requestAnimationFrame(function(){e.render()})}}dispose(){this.disposeObject(this.object),this.disposed=!0}disposeObject(e){for(var t in e.children)this.disposeObject(e.children[t]);e.geometry&&(e.geometry.dispose&&e.geometry.dispose(),e.geometry=void 0),e.material&&(e.material.map&&(e.material.map.dispose&&e.material.map.dispose(),e.material.map=void 0),e.material.dispose&&e.material.dispose(),e.material=void 0)}}(r)}}}();