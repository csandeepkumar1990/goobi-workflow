<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites"
    xmlns:composite="http://xmlns.jcp.org/jsf/composite"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:x="http://myfaces.apache.org/tomahawk"
    xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

    <composite:interface>
    </composite:interface>

    <composite:implementation>

        <!-- process search modal #processesSearchBox -->
        <div
            id="processesSearchBox"
            class="modal fade modal__viaf"
            tabindex="-1"
            role="dialog"
            aria-labelledby="processesSearchBoxLabel"
            aria-hidden="true">
            <div
                class="modal-dialog xxl"
                role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5
                            class="modal-title"
                            id="processesSearchBoxLabel">#{msgs.NORM_processesSearch}</h5>

                        <button
                            type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                            <span aria-hidden="true">
                                <h:outputText
                                    value="&amp;times;"
                                    escape="false" />
                            </span>
                        </button>
                    </div>
                    <div class="modal-body">

                        <p>
                            <h:outputText
                                value="#{msgs.NORM_helpProcessesSearch}"
                                escape="false" />
                        </p>

                        <h:panelGroup id="processes_search">
                            <div class="col-sm-12">
                                <c:if test="#{Metadaten.currentMetadataToPerformSearch.metadataDisplaytype == 'process'}">
                                    <ui:repeat
                                        value="#{Metadaten.currentMetadataToPerformSearch.searchRequest.metadataFilters}"
                                        var="group"
                                        varStatus="globStatus">

                                        <div class="searchgroup__container">
                                            <h:commandLink
                                                styleClass="searchgroup__container-close"
                                                action="#{Metadaten.currentMetadataToPerformSearch.searchRequest.deleteSearchGroup(globStatus.index)}">
                                                <f:ajax
                                                    execute=":normdataForm:processes_search"
                                                    render=":normdataForm:processes_search" />
                                            </h:commandLink>
                                            <ui:repeat
                                                var="filter"
                                                value="#{group.filters}"
                                                varStatus="status">
                                                <div class="row">
                                                    <div class="col-2">
                                                        <div class="form-control form-control--select">
                                                            <h:selectOneMenu
                                                                value="#{filter.field}"
                                                                styleClass="form-control form-control--select">
                                                                <f:selectItems
                                                                    value="#{Metadaten.currentMetadataToPerformSearch.possibleFields}"
                                                                    var="field"
                                                                    itemValue="#{field}"
                                                                    itemLabel="#{msgs[field]}" />
                                                            </h:selectOneMenu>
                                                        </div>
                                                    </div>
                                                    <div class="col-1">
                                                        <div class="form-control form-control--select">
                                                            <h:selectOneMenu
                                                                value="#{filter.relation}"
                                                                styleClass="form-control form-control--select">
                                                                <f:selectItems value="#{filter.operators}" />
                                                            </h:selectOneMenu>
                                                        </div>
                                                    </div>
                                                    <div class="col-8">
                                                        <!--                                                                    search button? -->
                                                        <x:inputText
                                                            value="#{filter.value}"
                                                            styleClass="form-control input"
                                                            id="input_processes" />
                                                    </div>
                                                    <div class="col-1 text-right">
                                                        <h:commandLink
                                                            action="#{group.deleteFilter(status.index)}"
                                                            styleClass="fa fa-trash pull-right">
                                                            <f:ajax
                                                                execute=":normdataForm:processes_search"
                                                                render=":normdataForm:processes_search" />
                                                        </h:commandLink>
                                                    </div>

                                                </div>
                                            </ui:repeat>
                                            <div class="row">
                                                <ui:fragment rendered="#{group.numFilters gt 1}">
                                                    <div class="col-8 group-conjunction">
                                                        <strong>
                                                            <h:outputText value="#{msgs.NORM_filterconjunction}:" />
                                                        </strong>
                                                        <h:selectOneRadio
                                                            value="#{group.conjunctive}"
                                                            styleClass="table__radio">
                                                            <f:selectItem
                                                                itemValue="true"
                                                                itemLabel="#{msgs.NORM_conjunctive}" />
                                                            <f:selectItem
                                                                itemValue="false"
                                                                itemLabel="#{msgs.NORM_disjunctive}" />
                                                            <f:ajax />
                                                        </h:selectOneRadio>
                                                    </div>
                                                </ui:fragment>
                                                <div class="#{group.numFilters gt 1 ? 'col-4' : 'col'}">
                                                    <h:commandLink
                                                        action="#{group.newFilter}"
                                                        styleClass="new-filter-btn">
                                                        #{msgs.NORM_newFilter}
                                                        <f:ajax
                                                            execute=":normdataForm:processes_search"
                                                            render=":normdataForm:processes_search" />
                                                    </h:commandLink>
                                                </div>
                                            </div>
                                        </div>
                                    </ui:repeat>
                                    <div class="modal__viaf-conjunction">
                                        <div class="row">
                                            <h:panelGroup rendered="#{Metadaten.currentMetadataToPerformSearch.searchRequest.numGroups gt 1}">
                                                <div
                                                    class="col-sm-8"
                                                    style="padding-top: 4px;">
                                                    <strong>
                                                        <h:outputText value="#{msgs.NORM_groupconjunction}:" />
                                                    </strong>
                                                    <h:selectOneRadio value="#{Metadaten.currentMetadataToPerformSearch.searchRequest.metadataConjunctive}">
                                                        <f:selectItem
                                                            itemValue="true"
                                                            itemLabel="#{msgs.NORM_conjunctive}" />
                                                        <f:selectItem
                                                            itemValue="false"
                                                            itemLabel="#{msgs.NORM_disjunctive}" />
                                                        <f:ajax />
                                                    </h:selectOneRadio>
                                                </div>
                                            </h:panelGroup>
                                            <div class="#{Metadaten.currentMetadataToPerformSearch.searchRequest.numGroups gt 1 ? 'col-sm-4' : 'col-sm-12'}">

                                                <h:commandLink
                                                    action="#{Metadaten.currentMetadataToPerformSearch.searchRequest.newGroup}"
                                                    styleClass="new-filter-btn">
                                                    <f:ajax
                                                        execute=":normdataForm:processes_search"
                                                        render=":normdataForm:processes_search" />
                                                        #{msgs.NORM_newGroup}
                                                    </h:commandLink>

                                            </div>
                                        </div>
                                    </div>
                                </c:if>
                            </div>

                            <h:commandLink 
                                        styleClass="btn btn--white btn--loader" 
                                        action="#{Metadaten.currentMetadataToPerformSearch.search}"
                                        title="#{msgs.search}">
                                        <i class="fa fa-search" aria-hidden="true"></i>
                                        #{msgs.search}
                                        <span class="btn-ajax-loader" aria-hidden="true">
                                            <img src="template/img/goobi/ajaxloader2.gif" alt="Ajax Button Loader" />
                                        </span>
                                        <f:passThroughAttribute name="data-toggle" value="tooltip" />
                                       <f:ajax
                                        execute="@form"
                                        render="processResults" />
                             </h:commandLink>    

                            
                            <script>
                                                                                                                    $( 'input[id*="geonamesSearch"]' ).on( 'focus', function() {
                                                                                                                        $( this ).on( 'keyup', function( event ) {
                                                                                                                            event.preventDefault();
                                                                                                                            if ( event.keyCode == 13 ) {
                                                                                                                                $( this ).parent().next().click();
                                                                                                                            }
                                                                                                                        } );
                                                                                                                    } );
                                                                                                                </script>

                        </h:panelGroup>
                        <h:panelGroup
                            id="processResults"
                            rendered="#{Metadaten.currentMetadataToPerformSearch.metadataDisplaytype == 'process'}">
<c:if test="#{Metadaten.currentMetadataToPerformSearch.metadataDisplaytype == 'process'}">
                            <h:panelGroup
                                id="processesList"
                                layout="block"
                                styleClass="row pre-scrollable"
                                rendered="#{not empty Metadaten.currentMetadataToPerformSearch.results}">
                                <h:message
                                    for="processesList"
                                    showDetail="true"
                                    styleClass="help-inline font-danger" />

                                <div class="col-sm-12">
                                    <h:dataTable
                                        value="#{Metadaten.currentMetadataToPerformSearch.results}"
                                        var="process"
                                        styleClass="table table-hover table-nomargin dataTable table-bordered responsive">
                                        <c:if test="#{Metadaten.currentMetadataToPerformSearch.metadataDisplaytype == 'process'}">
                                            <c:forEach
                                                items="#{Metadaten.currentMetadataToPerformSearch.searchRequest.wantedFields}"
                                                var="val">
                                                <h:column>
                                                    <f:facet name="header">
                                                        <!-- TODO: translation ? -->
                                                        <h:outputText value="#{msgs[val]}" />
                                                    </f:facet>
                                                    <h:outputText value="#{process.metadata[val][0].value}" />
                                                </h:column>
                                            </c:forEach>
                                        </c:if>
                                        <h:column>
                                            <f:facet name="header">
                                                <h:outputText value="#{msgs.action}" />
                                            </f:facet>
                                            <h:commandLink
                                                styleClass="btn btn-primary fa fa-check"
                                                action="#{Metadaten.currentMetadataToPerformSearch.linkProcess(process)}" />
                                        </h:column>
                                    </h:dataTable>

                                    <h:outputText
                                        value="#{msgs.NORM_noHits}"
                                        rendered="#{Metadaten.currentMetadataToPerformSearch != NULL and Metadaten.currentMetadataToPerformSearch.showNoHitFound}"
                                        style="margin: 20px;" />
                                </div>

                            </h:panelGroup>
                            </c:if>
                        </h:panelGroup>
                    </div>
                </div>


            </div>
        </div>

    </composite:implementation>
</ui:composition>