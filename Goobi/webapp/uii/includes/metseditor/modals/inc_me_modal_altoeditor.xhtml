<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites"
    xmlns:composite="http://xmlns.jcp.org/jsf/composite"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:x="http://myfaces.apache.org/tomahawk"
    xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
    xmlns:jsf="http://xmlns.jcp.org/jsf">

    <composite:interface>
    </composite:interface>

    <composite:implementation>
        <style>
            autocomplete {
                display: inline-block;
            }
            .actions {
                margin-top: 15px;
            }
            .image-navigation {
                display: flex;
                justify-content: center;
            }
            .image-navigation .btn {
                margin: 0 4px;
                padding: 0 7px;
            }
        </style>

        <!-- process search modal #processesSearchBox -->
        <div
            id="altoEditBox"
            class="modal fade modal__viaf"
            tabindex="-1"
            role="dialog"
            aria-hidden="true">
            <div
                class="modal-dialog xxl"
                role="document">
                <h:panelGroup id="altoEditorModalContent" class="modal-content" layout="block">
                    <div class="modal-header">
                        <h6
                            class="modal-title"
                            id="processesSearchBoxLabel">#{msgs.editAlto}</h6>

                        <button
                            type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                            <span aria-hidden="true">
                                <h:outputText
                                    value="&amp;times;"
                                    escape="false" />
                            </span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <alto-editor></alto-editor>
                        <div class="actions">
                            <div class="row">
                                <div class="col-md-2"></div>
                                <div class="col-md-8">
                                    <div class="image-navigation">
                                        <button type="button" class="btn btn--icon-blue" onclick="document.querySelector('#prevImage').click()">
                                            <i class="fa fa-angle-left" aria-hidden="true"></i>
                                            #{Metadaten.pagesRTL?msgs.nextImage:msgs.previousImage}
                                        </button>
                                        <autocomplete></autocomplete>
                                        <h:inputHidden id="autocompleteValue" value="#{Metadaten.bildNummerGeheZuCompleteString}" />
                                        <button type="button" class="btn btn--icon-blue" onclick="document.querySelector('#nextImage').click()">
                                            #{Metadaten.pagesRTL?msgs.previousImage:msgs.nextImage}
                                            <i class="fa fa-angle-right" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn--icon-blue pull-right" onclick="saveAltoResults">#{msgs.save}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h:inputText value="#{Metadaten.altoChanges}" id="altoChanges" style="display: none;"/>
                    <h:commandButton id="saveAltoChanges" action="#{Metadaten.saveAlto}" style="display: none;">
                        <f:ajax execute="altoChanges" render="" />
                    </h:commandButton>
                </h:panelGroup>
                <h:commandScript id="altoEditorAutocompleteScript" name="requestAutocomplete" 
                    action="#{Metadaten.autocompleteJson}" onevent="autocompleted" render="" pt:data-noaction="true" />
                <h:commandScript 
                    pt:data-renderimage="true"
                    name="sendAutocompleteValue"
                    action="#{Metadaten.BildGeheZu}" 
                    execute="autocompleteValue" 
                    render="openseadragonform" />

            </div>
        </div>
        <script>
        function autocompleted(e) {
        	if(e.status === "complete") {
        		var autocomplete = document.querySelector('autocomplete')._tag
        		autocomplete.onAutocompleteResponse(JSON.parse(e.responseText))
        	}
        }
        function sendAutocomplete(value) {
        	requestAutocomplete({suggest: value})
        }
        function enterValue(value) {
        	document.querySelector('#autocompleteValue').value = value;
        	sendAutocompleteValue();
        }
        function openAltoEditor(dontShowModal) {
        	if(!dontShowModal) {
        		$('#altoEditBox').modal('show');
        	}
        	var opts = {
        		language: "#{SpracheForm.locale.language}",
        		altoDivSelector: '#jsonAlto',
        		altoChangesInputSelector: "#altoChanges",
        		saveAltoButtonSelector: "#saveAltoChanges",
        		tileSourceSelector: '#tileSource'
        	}
        	riot.mount('alto-editor', opts);
        	var ocOpts = {
        		requestAutocomplete: sendAutocomplete,
        		enterValue: enterValue,
        		initialValue: document.querySelector('#autocompleteValue').value      		
        	}
        	riot.mount('autocomplete', ocOpts);
        }
        </script>

    </composite:implementation>
</ui:composition>