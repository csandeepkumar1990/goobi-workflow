<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:o="http://omnifaces.org/ui"
	xmlns:of="http://omnifaces.org/functions"
	template="/uii/template/template.html"
	xmlns:x="http://myfaces.apache.org/tomahawk"
	xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:param name="myPageTitle"
		value="#{msgs.menu_administration_plugins}" />

	<ui:define name="breadcrumb">
		<intranda:breadcrumb id="index"
			label="#{DashboardForm.plugin==null?msgs.startseite:msgs.dashboard}"
			action="index" navId="a0" />
		<intranda:breadcrumb id="admin"
			label="#{msgs.menu_administration_plugins}" action="plugins.xhtml"
			noSeparator="#{true}" />
	</ui:define>

	<ui:define name="info">
	</ui:define>

	<ui:define name="content">

		<link rel="stylesheet" href="template/css/codemirror/codemirror.css"/>
		<script type="text/javascript" src="template/js/codemirror/codemirror.js"/>
		<script type="text/javascript" src="template/js/plugin-installer-codemirror.js"/>
		<script type="text/javascript" src="template/js/codemirror/mode/xml/xml.js"/>


		<div class="row" role="main">
			<div class="col-sm-12">
				<div class="box box-bordered box-color">
					<div class="box-title">
						<h2>
							<i class="fa fa-stethoscope"></i>
							<h:outputText value="#{msgs.menu_administration_plugins}" />
						</h2>
					</div>
					<div class="box-content ">
						<h:form id="plugins_tabform">
							<ul class="nav nav-tabs">
								<li role="presentation"
									class="#{pluginsBean.mode eq 'installed' ? 'active' : ''}">
									<h:commandLink>
										<h:outputText value="#{msgs.install_plugin_installed}" />
										<f:ajax render="pluginsTabContent @form" />
										<f:setPropertyActionListener value="installed" target="#{pluginsBean.mode}"></f:setPropertyActionListener>
									</h:commandLink>
								</li>
								<li role="presentation"
									class="#{pluginsBean.mode eq 'installNew' ? 'active' : ''}">
									<h:commandLink>
										<h:outputText value="#{msgs.install_plugin_install_new}" />
										<f:ajax render="pluginsTabContent @form" />
										<f:setPropertyActionListener value="installNew" target="#{pluginsBean.mode}"></f:setPropertyActionListener>
									</h:commandLink>
								</li>
							</ul>
						</h:form>
						<h:panelGroup id="pluginsTabContent">
							<h:panelGroup layout="block" rendered="#{pluginsBean.mode eq 'installNew'}">
								<h3>#{msgs.install_plugin_install_new}</h3>
								<h:form enctype="multipart/form-data">
									<h:inputFile value="#{pluginInstallBean.uploadedPluginFile}" rendered="#{pluginInstallBean.pluginInstaller.pluginInfo eq null}">
										<f:ajax listener="#{pluginInstallBean.parseUploadedPlugin}" render="@form"/>
									</h:inputFile>
									<ui:fragment rendered="#{pluginInstallBean.pluginInstaller.pluginInfo != null}">
										<div class="row">
											<div class="col-md-12">
												<table class="table">
													<tr>
														<th>Plugin identifier</th>
														<td>#{pluginInstallBean.pluginInstaller.pluginInfo.name}</td>
													</tr>
													<tr>
														<th>Plugin type</th>
														<td>#{pluginInstallBean.pluginInstaller.pluginInfo.type}</td>
													</tr>
													<tr>
														<th>Plugin version</th>
														<td>#{pluginInstallBean.pluginInstaller.pluginInfo.versions[0].pluginVersion}</td>
													</tr>
													<tr>
														<th>Goobi version</th>
														<td>#{pluginInstallBean.pluginInstaller.pluginInfo.versions[0].publicGoobiVersion}</td>
													</tr>
												</table>
											</div>
										</div>
										<div class="row">
											<ui:repeat var="conflict" value="#{pluginInstallBean.pluginInstaller.check.conflicts.values()}">
												<div class="space-to-bottom">
													<ui:fragment rendered="#{!conflict.fixed}">
														<div class="col-md-12">
															<h4>#{conflict.fileName} (#{msgs.install_plugin_conflict} #{conflict.number}/#{pluginInstallBean.pluginInstaller.check.conflicts.size()})</h4>
														</div>
														<ul class="nav nav-tabs">
															<li role="presentation"
																class="#{conflict.diffMode eq 'show_old_and_new_file' ? 'active' : ''}">
																<h:commandLink>
																	<h:outputText value="#{msgs.install_plugin_show_old_and_new_file}" />
																	<f:ajax render="pluginsTabContent @form" />
																	<f:setPropertyActionListener value="show_old_and_new_file" target="#{conflict.diffMode}"></f:setPropertyActionListener>
																</h:commandLink>
															</li>
															<li role="presentation"
																class="#{conflict.diffMode eq 'show_default_and_custom_file' ? 'active' : ''}">
																<h:commandLink>
																	<h:outputText value="#{msgs.install_plugin_show_default_and_custom_file}" />
																	<f:ajax render="pluginsTabContent @form" />
																	<f:setPropertyActionListener value="show_default_and_custom_file" target="#{conflict.diffMode}"></f:setPropertyActionListener>
																</h:commandLink>
															</li>
															<li role="presentation"
																class="pull-right #{conflict.conflictsMode eq 'edit_uploaded_file' ? 'active' : ''}">
																<h:commandLink>
																	<h:outputText value="#{msgs.install_plugin_edit_uploaded_file}" />
																	<f:ajax render="pluginsTabContent @form" execute="textarea_edit_file_destination" />
																	<f:setPropertyActionListener value="edit_uploaded_file" target="#{conflict.conflictsMode}"></f:setPropertyActionListener>
																</h:commandLink>
															</li>
															<li role="presentation"
																class="pull-right #{conflict.conflictsMode eq 'edit_existing_file' ? 'active' : ''}">
																<h:commandLink>
																	<h:outputText value="#{msgs.install_plugin_edit_existing_file}" />
																	<f:ajax render="pluginsTabContent @form" execute="textarea_edit_file_destination" />
																	<f:setPropertyActionListener value="edit_existing_file" target="#{conflict.conflictsMode}"></f:setPropertyActionListener>
																</h:commandLink>
															</li>
														</ul>
														<ui:fragment rendered="#{conflict.diffMode eq 'show_old_and_new_file'}">
															<div class="col-md-6">
																<h5>#{msgs.install_plugin_show_old_and_new_file}</h5>
															</div>
														</ui:fragment>
														<ui:fragment rendered="#{conflict.diffMode eq 'show_default_and_custom_file'}">
															<div class="col-md-6">
																<h5>#{msgs.install_plugin_show_default_and_custom_file}</h5>
															</div>
														</ui:fragment>
														<ui:fragment rendered="#{conflict.conflictsMode eq 'edit_existing_file'}">
															<div class="col-md-6">
																<h5>#{msgs.install_plugin_existing_file}</h5>
															</div>
														</ui:fragment>
														<ui:fragment rendered="#{conflict.conflictsMode eq 'edit_uploaded_file'}">
															<div class="col-md-6">
																<h5>#{msgs.install_plugin_uploaded_file}</h5>
															</div>
														</ui:fragment>
														<div class="col-md-6">
															<ui:fragment rendered="#{conflict.diffMode eq 'show_old_and_new_file'}">
																<span class="plugin-installer-next-to-eachother-5">
																	<ui:repeat var="line" value="#{conflict.lineNumbersOldNew}" varStatus="lineStatus">
																		<div class="plugin-installer-line-number #{conflict.lineTypesOldNew.get(lineStatus.index) eq 'insertion' ? 'plugin-installer-line-number-inserted' : ''} #{conflict.lineTypesOldNew.get(lineStatus.index) eq 'deletion' ? 'plugin-installer-line-number-deleted' : ''}">&#160;#{line}</div>
																	</ui:repeat>
																</span>
															</ui:fragment>
															<ui:fragment rendered="#{conflict.diffMode eq 'show_default_and_custom_file'}">
																<span class="plugin-installer-next-to-eachother-5">
																	<ui:repeat var="line" value="#{conflict.lineNumbersOldOld}" varStatus="lineStatus">
																		<div class="plugin-installer-line-number #{conflict.lineTypesOldOld.get(lineStatus.index) eq 'insertion' ? 'plugin-installer-line-number-inserted' : ''} #{conflict.lineTypesOldOld.get(lineStatus.index) eq 'deletion' ? 'plugin-installer-line-number-deleted' : ''}">&#160;#{line}</div>
																	</ui:repeat>
																</span>
															</ui:fragment>
															<span class="plugin-installer-next-to-eachother-90">
																<ui:repeat var="line" value="#{conflict.diffMode eq 'show_old_and_new_file' ? conflict.spanTagsOldNew : conflict.spanTagsOldOld}" varStatus="lineStatus">
																	<div class="plugin-installer-diff-box #{conflict.diffMode eq 'show_old_and_new_file' &amp;&amp; conflict.lineTypesOldNew.get(lineStatus.index) eq 'insertion' ? 'plugin-installer-inserted-passive' : ''} #{conflict.diffMode eq 'show_old_and_new_file' &amp;&amp; conflict.lineTypesOldNew.get(lineStatus.index) eq 'deletion' ? 'plugin-installer-deleted-passive' : ''} #{conflict.diffMode eq 'show_default_and_custom_file' &amp;&amp; conflict.lineTypesOldOld.get(lineStatus.index) eq 'insertion' ? 'plugin-installer-inserted-passive' : ''} #{conflict.diffMode eq 'show_default_and_custom_file' &amp;&amp; conflict.lineTypesOldOld.get(lineStatus.index) eq 'deletion' ? 'plugin-installer-deleted-passive' : ''}">
																		<!-- WARNING: The comment sequences MUST be here to AVOID the white spaces between different span tags! -->
																		<ui:repeat var="spanTag" value="#{conflict.diffMode eq 'show_old_and_new_file' ? conflict.spanTagsOldNew.get(lineStatus.index) : conflict.spanTagsOldOld.get(lineStatus.index)}"><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'LINE_NUMBER_NORMAL'}"><!--
																				--><span class="plugin-installer-line-number plugin-installer-line-number-normal">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'LINE_NUMBER_INSERTED'}"><!--
																				--><span class="plugin-installer-line-number plugin-installer-line-number-inserted">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'LINE_NUMBER_DELETED'}"><!--
																				--><span class="plugin-installer-line-number plugin-installer-line-number-deleted">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'TEXT_NORMAL'}"><!--
																				--><span class="plugin-installer-text plugin-installer-normal">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'TEXT_INSERTED_PASSIVE'}"><!--
																				--><span class="plugin-installer-text plugin-installer-inserted-passive">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'TEXT_INSERTED_ACTIVE'}"><!--
																				--><span class="plugin-installer-text plugin-installer-inserted-active">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'TEXT_DELETED_PASSIVE'}"><!--
																				--><span class="plugin-installer-text plugin-installer-deleted-passive">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'TEXT_DELETED_ACTIVE'}"><!--
																				--><span class="plugin-installer-text plugin-installer-deleted-active">#{spanTag.text}</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'SPACE_NORMAL'}"><!--
																				--><span class="plugin-installer-space plugin-installer-normal">&#160;</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'SPACE_INSERTED_PASSIVE'}"><!--
																				--><span class="plugin-installer-space plugin-installer-inserted-passive">&#160;</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'SPACE_INSERTED_ACTIVE'}"><!--
																				--><span class="plugin-installer-space plugin-installer-inserted-active">&#160;</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'SPACE_DELETED_PASSIVE'}"><!--
																				--><span class="plugin-installer-space plugin-installer-deleted-passive">&#160;</span><!--
																			--></ui:fragment><!--
																			--><ui:fragment rendered="#{spanTag.type eq 'SPACE_DELETED_ACTIVE'}"><!--
																				--><span class="plugin-installer-space plugin-installer-deleted-active">&#160;</span><!--
																			--></ui:fragment><!--
																		--></ui:repeat>
																	</div>
																</ui:repeat>
															</span>
														</div>
														<div class="col-md-6">
															<textarea class="textarea_edit_file_source">#{conflict.conflictsMode eq 'edit_existing_file' ? conflict.editedExistingVersion : conflict.editedUploadedVersion}</textarea>
															<h:inputTextarea id="textarea_edit_file_destination" styleClass="textarea_edit_file_destination" value="#{conflict.currentVersion}"></h:inputTextarea>
														</div>
														<br class="plugin-installer-separator" />
														<h:commandButton id="fix" forcedId="true" styleClass="btn btn-primary pull-right" value="#{msgs.install_plugin_resolve_conflict}" action="#{conflict.fixConflict}">
															<f:ajax render="pluginsTabContent @form" execute="@form" />
														</h:commandButton>
														<h:commandButton id="reset" forcedId="true" styleClass="btn btn-primary pull-right" style="margin-right: 10px;" value="#{msgs.install_plugin_reset_text_editor}" action="#{conflict.resetTextEditor}">
															<f:ajax render="pluginsTabContent @form" execute="@form" />
														</h:commandButton>
														<hr class="plugin-installer-separator" />
													</ui:fragment>
												</div>
											</ui:repeat>
											<script type="text/javascript">
												initXmlCodeMirror();
											</script>
										</div>
										<div class="row">
											<div class="col-md-12">
												<ui:fragment rendered="#{!pluginInstallBean.areAllConflictsFixed}">
													<div class="alert alert-warning">
														<h:outputText value="#{msgs.install_plugin_resolve_conflicts_before_installation}" />
													</div>
												</ui:fragment>
												<h:commandButton id="install" forcedId="true" styleClass="btn btn-primary pull-right" value="#{msgs.install}" action="#{pluginInstallBean.install}" disabled="#{!pluginInstallBean.areAllConflictsFixed}" />
												<h:commandButton id="cancel" forcedId="true" styleClass="btn" value="#{msgs.cancel}" action="#{pluginInstallBean.cancelInstall}" />
											</div>
										</div>
									</ui:fragment>
								</h:form>
							</h:panelGroup>
							<h:panelGroup layout="block" rendered="#{pluginsBean.mode eq 'installed'}">
								<h:form id="plugins_form">
									<ui:repeat var="folder"
										value="#{pluginsBean.plugins.keySet().toArray()}">
										
										<ui:fragment rendered="#{not pluginsBean.plugins[folder].isEmpty()}">
											<h3 class="folder--line" tabindex="0">
												<h:outputText value="#{folder} #{msgs.plugins}" styleClass="text"/>
											</h3>
										</ui:fragment>
	
										<x:dataTable
											rendered="#{not pluginsBean.plugins[folder].isEmpty()}"
											styleClass="table table-hover table-nomargin dataTable table-bordered responsive"
											var="pluginInfo" value="#{pluginsBean.plugins[folder]}">
											<x:column styleClass="">
												<f:facet name="header">
													<h:outputText value="#{msgs.filename}" />
												</f:facet>
												<h:outputText value="#{pluginInfo.filename}" />
											</x:column>
											<x:column style="width: 300px;">
												<f:facet name="header">
													<h:outputText value="#{msgs.containedPlugins}" />
												</f:facet>
												<h:outputText rendered="#{not pluginInfo.containedPlugins.isEmpty()}" value="#{pluginInfo.containedPlugins}" />
											</x:column>
											<x:column style="width: 300px;">
												<f:facet name="header">
													<h:outputText value="#{msgs.pluginsUsedInWorkflows}" />
												</f:facet>
												<h:outputText rendered="#{not pluginInfo.pluginsUsedInWorkflows.isEmpty()}" value="#{pluginInfo.pluginsUsedInWorkflows}" />
											</x:column>
											<x:column styleClass="tableColumnOverflow width200">
												<f:facet name="header">
													<h:outputText value="#{msgs.gitHash}" />
												</f:facet>
												<h:outputText value="#{pluginInfo.gitHash}" />
											</x:column>
											<x:column styleClass="tableColumnOverflow width200">
												<f:facet name="header">
													<h:outputText value="#{msgs.buildDate}" />
												</f:facet>
												<h:outputText value="#{pluginInfo.buildDate}" />
											</x:column>
										</x:dataTable>
									</ui:repeat>
								</h:form>
							</h:panelGroup>
						</h:panelGroup>
					</div>
				</div>
			</div>
		</div>
	</ui:define>
</ui:composition>