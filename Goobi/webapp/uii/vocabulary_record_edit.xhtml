<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:o="http://omnifaces.org/ui"
    xmlns:of="http://omnifaces.org/functions"
    template="/uii/template/template.html"
    xmlns:x="http://myfaces.apache.org/tomahawk"
    xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites">

    <ui:param
        name="myPageTitle"
        value="#{msgs.intranda_edit_vocabulary}" />

    <ui:define name="breadcrumb">
        <intranda:breadcrumb
            id="index"
            label="#{DashboardForm.plugin==null?msgs.startseite:msgs.dashboard}"
            action="index"
            navId="a0" />
        <intranda:breadcrumb
            id="admin"
            label="#{msgs.intranda_administration_vocabulary}"
            action="administration_vocabulary.xhtml" />
        <intranda:breadcrumb
            id="edit"
            label="#{vocabularyBean.currentVocabulary.title}"
            action="vocab_record_edit.xhtml"
            noSeparator="#{true}" />
    </ui:define>

    <ui:define name="info">
    </ui:define>

    <ui:define name="content">

        <h:form
            id="myform"
            styleClass="form-horizontal form-bordered"
            onkeypress="submitOnEnter(event);"
            rendered="#{LoginForm.hasRole('Admin_Vocabulary')}">

            <div class="row">
                <div class="col-sm-12">
                    <div class="box box-color orange box-bordered">
                        <div class="box-title">
                            <h3>
                                <i class="fa fa-print box-icon-fix"></i>
                                <h:outputText value="#{vocabularyBean.currentVocabulary.title}" />
                            </h3>
                        </div>
                        <div class="box-content nopadding">
                            <x:dataList
                                styleClass="table table-hover dataTable table-bordered responsive"
                                value="#{vocabularyBean.currentVocabulary.records}"
                                var="record"
                                style="margin-top:10px;">
                                    <div class="form-group">
											<h:outputLabel for="recordid"
												styleClass="control-label col-sm-3" value="#{msgs.id}" />
											<div class="col-sm-9">
												<div class="input-group input-group">
													<h:outputText id="recordid"
														styleClass="form-control font-light"
														value="#{record.id}" />
													<div class="input-group-btn">
														<h:commandLink id="delete" styleClass="btn btn-danger"
															style="height:25px;margin-left:5px; border:0;padding-top:3px;"
															title="#{msgs.plugin_admin_vocabulary_deleteRecord}"
															action="#{vocabularyBean.deleteRecord}"
															immediate="true">
                                                            <f:setPropertyActionListener value="#{record}" target="#{vocabularyBean.currentVocabRecord}"/>
															<i class="fa fa-trash-o font-bold" style="color: white;"></i>
														</h:commandLink>
													</div>
												</div>
											</div>
										</div>
                                <ui:repeat
                                    var="field"
                                    value="#{record.fields}">
                                    
                                    <!-- regular input field -->
                                    <intranda:formInputText
                                        name="field"
                                        label="#{field.label}:"
                                        field="#{field.value}"
                                        fieldStyle="form-control"
                                        required="false"
                                        rendered="#{field.definition.type eq 'input'}"
                                        style="border-left:1px solid #ddd;" />
                                    <!-- text area field -->
                                    <intranda:formInputTextArea
                                        name="field2"
                                        label="#{field.label}:"
                                        field="#{field.value}"
                                        fieldStyle="form-control"
                                        required="false"
                                        rendered="#{field.definition.type eq 'textarea'}"
                                        style="border-left:1px solid #ddd;" />
                                    <!-- select1 field -->
                                    <intranda:formInputDropDown
                                        name="field3"
                                        label="#{field.label}:"
                                        field="#{field.value}"
                                        rendered="#{field.definition.type eq 'select1'}"
                                        selectItems="#{field.definition.selectList}"
                                        required="false"
                                        fieldStyle="form-control"
                                        style="border-left:1px solid #ddd;" />
                                    <!-- select field -->
                                    <intranda:formInputSelectMany
                                        name="field4"
                                        label="#{field.label}:"
                                        field="#{field.valueMultiSelect}"
                                        rendered="#{field.definition.type eq 'select'}"
                                        selectItems="#{field.definition.selectList}"
                                        required="false"
                                        fieldStyle="form-control"
                                        style="border-left:1px solid #ddd;" />
                                    <!-- html field -->
                                    <intranda:formInputTextArea
                                        name="field2"
                                        label="#{field.label}:"
                                        field="#{field.value}"
                                        fieldStyle="editor form-control"
                                        required="false"
                                        rendered="#{field.definition.type eq 'html'}"
                                        style="border-left:1px solid #ddd;" />
                                </ui:repeat>

                                <hr />

                            </x:dataList>


                            <h:commandLink
                                immediate="true"
                                id="new_def"
                                styleClass="btn btn-primary font-size-s"
                                style="margin-top:10px; margin-left:5px; margin-bottom:10px; background: #368ee0;"
                                action="#{vocabularyBean.addRecord}"
                                title="#{msgs.plugin_admin_vocabulary_addRecord}">
                                <i
                                    aria-hidden="true"
                                    class="fa fa-plus margin-right-5"></i>
                                <h:outputText value="#{msgs.plugin_admin_vocabulary_addRecord}" />
                            </h:commandLink>
                        </div>
                    </div>
                </div>

            </div>


            <!-- Information about the definitions -->

            <!-- new definition -->

            <!-- Save -->
            <h:commandLink
                styleClass="btn btn-success submitOnEnter pull-right font-size-s margin-bottom-most"
                style="margin-top:10px; margin-left:5px;"
                id="absenden"
                type="submit"
                action="#{vocabularyBean.saveRecordEdition}">
                <i class="fa fa-save margin-right-5"></i>
                <h:outputText value="#{msgs.speichern}" />
            </h:commandLink>

            <!-- Cancel -->
            <h:commandLink
                styleClass="btn btn-cancel submitOnEnter pull-right font-size-s margin-bottom-most"
                style="margin-top:10px;"
                id="abbrechen"
                type="cancel"
                action="#{vocabularyBean.cancelRecordEdition}"
                immediate="true">
                <i class="fa fa-cancel margin-right-5"></i>
                <h:outputText value="#{msgs.abbrechen}" />
            </h:commandLink>


        </h:form>

    </ui:define>
    <script type="text/javascript">
                    //<![CDATA[
                    var simpleTinyMceConfig = {
                        selector: '.editor',
                        setup: function( editor ) {
                            editor.on( 'change', function() {
                                tinymce.triggerSave();
                            } );
                        },
                        valid_elements: 'p,strong,em,span[!style<text-decoration: underline;],sup,',
                        statusbar: true,
                        theme: 'modern',
                        height: 250,
                        plugins: [ 'print code preview fullscreen' ],
                        menu: {},
                        toolbar: false,
                        toolbar: 'undo redo | bold italic underline | superscript | code ',
                        content_css: 'css/content.css',
                        init_instance_callback: function( editor ) {
                            var readOnlyAttr = $( "#" + editor.id.replace( ":", "\\:" ) ).attr( "readonly" );
                            if ( readOnlyAttr === "readonly" ) {
                                editor.setMode( "readonly" );
                            }
                        },
                        setup: function( editor ) {
                            editor.on( "blur", function( event, a, b ) {
                                editor.save();
                                $( "#" + editor.id.replace( ":", "\\:" ) ).trigger( "change" );
                            } );
                        }
                    
                    };
                    
                    function initTinyMce() {
                        console.log( "Init tinyMce" );
                        tinymce.init( simpleTinyMceConfig );
                    }

                    $( window ).on( "load", function() {
                        renderInputFields()
                    } )

                    jsf.ajax.addOnEvent( function( data ) {
                        var ajaxstatus = data.status; // Can be "begin", "complete" and "success"
                        switch ( ajaxstatus ) {
                            case "success": // This is called when ajax response is successfully processed.
                                renderInputFields()
                                break;
                        }
                    } );
                    
                    function renderInputFields( ajaxData ) {
                        if ( typeof tinyMCE !== 'undefined' ) {
                            if ( ajaxData === undefined || ajaxData.status == "begin" ) {
                                for ( edId in tinyMCE.editors ) {
                                    try {
                                        tinyMCE.editors[ edId ].remove();
                                        console.log( "Removed editor " + edId );
                                    }
                                    catch ( error ) {
                                        console.log( "Error occured during removing editors; ", error );
                                    }
                                }
                            }
                            if ( ajaxData === undefined || ajaxData.status == "success" ) {
                                initTinyMce( ajaxData );
                            }
                        }
                    }
                    //]]>
                </script>
</ui:composition>